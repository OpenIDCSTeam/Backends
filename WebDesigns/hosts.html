{% extends "base.html" %}

{% block content %}
<!-- 页面标题 -->
<div class="mb-6">
    <h1 class="text-3xl font-bold text-gray-800 flex items-center gap-3">
        <span class="iconify text-blue-600" data-icon="mdi:server" data-width="36"></span>
        主机管理
    </h1>
    <p class="text-gray-600 mt-1">管理所有虚拟化主机</p>
</div>

<!-- 操作栏 -->
<div class="bg-white rounded-lg border border-gray-200 p-4 mb-6 flex flex-wrap items-center justify-between gap-4">
    <div class="flex items-center gap-4">
        <button onclick="openAddHostModal()"
                class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm font-medium btn-hover shadow-sm flex items-center gap-2">
            <span class="iconify" data-icon="mdi:plus" data-width="18"></span>
            添加主机
        </button>
        <button onclick="loadHosts()"
                class="bg-gray-100 hover:bg-gray-200 text-gray-700 px-4 py-2 rounded-lg text-sm font-medium btn-hover flex items-center gap-2">
            <span class="iconify" data-icon="mdi:refresh" data-width="18"></span>
            刷新
        </button>
    </div>
    <div class="text-sm text-gray-500 flex items-center gap-2">
        <span class="iconify" data-icon="mdi:information-outline" data-width="16"></span>
        共 <span id="hostCount" class="font-medium text-gray-700">0</span> 个主机
    </div>
</div>

<!-- 主机列表 -->
<div id="hostsList" class="grid grid-cols-1 gap-4">
    <div class="col-span-full text-center py-16 text-gray-500">
        <span class="iconify animate-pulse-slow text-gray-400" data-icon="mdi:loading" data-width="48"></span>
        <p class="mt-4" data-i18n="加载中...">加载中...</p>
    </div>
</div>

<!-- 添加/编辑主机模态框 -->
<dialog id="hostModal" class="modal">
    <div class="modal-box max-w-2xl">
        <h3 class="font-bold text-lg flex items-center gap-2" id="modalTitle">
            <span class="iconify text-blue-600" data-icon="mdi:server-plus" data-width="24"></span>
            添加主机
        </h3>
        <form id="hostForm" class="mt-4 space-y-4">
            <input type="hidden" name="editMode" id="editMode" value="add">
            <input type="hidden" name="originalName" id="originalName" value="">

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">服务器名称 *</label>
                    <input type="text" name="name" id="hostName" required
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                           placeholder="例如: host1">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">服务器类型 *</label>
                    <select name="type" id="hostType" required
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        <option value="">请选择类型</option>
                    </select>
                </div>
            </div>

            <!-- 主机类型信息提示区域 -->
            <div id="hostTypeInfo" class="hidden">
                <!-- Messages 提示信息 -->
                <div id="hostTypeMessages" class="hidden bg-yellow-50 border border-yellow-200 rounded-lg p-3">
                    <h5 class="text-sm font-medium text-yellow-800 mb-2 flex items-center gap-2">
                        <span class="iconify" data-icon="mdi:information" data-width="16"></span>
                        注意事项
                    </h5>
                    <ul id="hostTypeMessagesList" class="text-sm text-yellow-700 space-y-1 list-disc list-inside">
                        <!-- Messages 将动态添加到这里 -->
                    </ul>
                </div>

                <!-- Optional 可选配置 -->
                <div id="hostTypeOptional" class="hidden bg-blue-50 border border-blue-200 rounded-lg p-3 mt-3">
                    <h5 class="text-sm font-medium text-blue-800 mb-2 flex items-center gap-2">
                        <span class="iconify" data-icon="mdi:cog" data-width="16"></span>
                        可选配置项
                    </h5>
                    <div id="hostTypeOptionalList" class="text-sm text-blue-700 space-y-1">
                        <!-- Optional 将动态添加到这里 -->
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">服务器地址</label>
                    <input type="text" name="server_addr" id="serverAddr"
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                           placeholder="例如: localhost:8697">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">服务器用户</label>
                    <input type="text" name="server_user" id="serverUser"
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                           placeholder="例如: root">
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">服务器密码</label>
                    <input type="password" name="server_pass" id="serverPass"
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                           placeholder="服务器密码">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">虚拟机前缀</label>
                    <input type="text" name="filter_name" id="filterName"
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                           placeholder="过滤器名称">
                </div>
            </div>

            <div class="border-t border-gray-200 pt-4">
                <h4 class="text-sm font-medium text-gray-700 mb-3 flex items-center gap-2">
                    <span class="iconify" data-icon="mdi:folder" data-width="18"></span>
                    存储路径配置
                </h4>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-600 mb-1">模板存储路径</label>
                        <input type="text" name="images_path" id="imagesPath"
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                               placeholder="例如: /data/images">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-600 mb-1">光盘存储路径</label>
                        <input type="text" name="dvdrom_path" id="dvdromPath"
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                               placeholder="例如: /data/iso">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-600 mb-1">系统存储路径</label>
                        <input type="text" name="system_path" id="systemPath"
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                               placeholder="例如: /data/system">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-600 mb-1">备份存储路径</label>
                        <input type="text" name="backup_path" id="backupPath"
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                               placeholder="例如: /data/backup">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-600 mb-1">数据存储路径</label>
                        <input type="text" name="extern_path" id="externPath"
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                               placeholder="例如: /data/extern">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-600 mb-1">程序启动路径</label>
                        <input type="text" name="launch_path" id="launchPath"
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                               placeholder="虚拟化程序路径">
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">服务访问端口</label>
                    <input type="number" name="server_port" id="serverPort"
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                           placeholder="例如: 443" min="0" max="65535">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">服务器公网IP</label>
                    <input type="text" name="public_addr" id="publicAddr"
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                           placeholder="例如: 192.168.1.1, 2001:db8::1">
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">共享IP设备名</label>
                    <input type="text" name="network_nat" id="networkNat"
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                           placeholder="例如: nat">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">独立IP设备名</label>
                    <input type="text" name="network_pub" id="networkPub"
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                           placeholder="例如: pub">
                </div>
            </div>

            <div class="border-t border-gray-200 pt-4">
                <h4 class="text-sm font-medium text-gray-700 mb-3 flex items-center gap-2">
                    <span class="iconify" data-icon="mdi:router-network" data-width="18"></span>
                    爱快OS配置
                </h4>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-600 mb-1">爱快OS地址</label>
                        <input type="text" name="i_kuai_addr" id="iKuaiAddr"
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                               placeholder="例如: http://192.168.1.1">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-600 mb-1">爱快OS用户名</label>
                        <input type="text" name="i_kuai_user" id="iKuaiUser"
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                               placeholder="爱快OS管理员用户名">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-600 mb-1">爱快OS密码</label>
                        <input type="password" name="i_kuai_pass" id="iKuaiPass"
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                               placeholder="爱快OS管理员密码">
                    </div>
                </div>
            </div>

            <div class="border-t border-gray-200 pt-4">
                <h4 class="text-sm font-medium text-gray-700 mb-3 flex items-center gap-2">
                    <span class="iconify" data-icon="mdi:network-outline" data-width="18"></span>
                    端口配置
                </h4>
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-600 mb-1">TCP端口起始</label>
                        <input type="number" name="ports_start" id="portsStart"
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                               placeholder="例如: 10000" min="0" max="65535">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-600 mb-1">TCP端口结束</label>
                        <input type="number" name="ports_close" id="portsClose"
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                               placeholder="例如: 20000" min="0" max="65535">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-600 mb-1">VNC服务端口</label>
                        <input type="number" name="remote_port" id="remotePort"
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                               placeholder="例如: 5900" min="0" max="65535">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-600 mb-1">虚拟机数量限制</label>
                        <input type="number" name="limits_nums" id="limitsNums"
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                               placeholder="例如: 100" min="0">
                    </div>
                </div>
            </div>

            <div class="border-t border-gray-200 pt-4">
                <h4 class="text-sm font-medium text-gray-700 mb-3 flex items-center gap-2">
                    <span class="iconify" data-icon="mdi:file-table-outline" data-width="18"></span>
                    系统映射配置
                </h4>
                <div class="mb-3">
                    <p class="text-sm text-gray-600">配置系统名称与镜像文件的映射关系</p>
                </div>
                <div id="systemMapsContainer" class="space-y-2">
                    <!-- 系统映射行将动态添加到这里 -->
                </div>
                <div class="mt-3">
                    <button type="button" onclick="addSystemMapRow()"
                            class="px-3 py-1.5 bg-blue-500 text-white text-sm rounded-lg hover:bg-blue-600 flex items-center gap-1">
                        <span class="iconify" data-icon="mdi:plus" data-width="16"></span>
                        添加系统映射
                    </button>
                </div>
            </div>

            <div class="border-t border-gray-200 pt-4">
                <h4 class="text-sm font-medium text-gray-700 mb-3 flex items-center gap-2">
                    <span class="iconify" data-icon="mdi:disc-alert" data-width="18"></span>
                    ISO镜像映射配置
                </h4>
                <div id="imagesMapsContainer" class="space-y-2 mb-3">
                    <!-- 镜像映射项将动态添加到这里 -->
                </div>
                <button type="button" onclick="addImageMapItem()"
                        class="px-3 py-1.5 text-sm bg-blue-50 text-blue-600 border border-blue-200 rounded-lg hover:bg-blue-100 flex items-center gap-1">
                    <span class="iconify" data-icon="mdi:plus" data-width="16"></span>
                    添加镜像映射
                </button>
            </div>

            <div class="border-t border-gray-200 pt-4">
                <h4 class="text-sm font-medium text-gray-700 mb-3 flex items-center gap-2">
                    <span class="iconify" data-icon="mdi:ip-network-outline" data-width="18"></span>
                    IP地址池配置
                </h4>
                <div class="mb-3">
                    <p class="text-sm text-gray-600">配置虚拟机可分配的IP地址段</p>
                </div>
                <div id="ipaddrMapsContainer" class="space-y-2">
                    <!-- IP地址池配置行将动态添加到这里 -->
                </div>
                <div class="mt-3">
                    <button type="button" onclick="addIpaddrMapRow()"
                            class="px-3 py-1.5 bg-blue-500 text-white text-sm rounded-lg hover:bg-blue-600 flex items-center gap-1">
                        <span class="iconify" data-icon="mdi:plus" data-width="16"></span>
                        添加IP地址池
                    </button>
                </div>
            </div>

            <div class="border-t border-gray-200 pt-4">
                <h4 class="text-sm font-medium text-gray-700 mb-3 flex items-center gap-2">
                    <span class="iconify" data-icon="mdi:dns" data-width="18"></span>
                    DNS服务器配置
                </h4>
                <div class="mb-2">
                    <label class="block text-sm font-medium text-gray-600 mb-1">DNS服务器（多个用逗号分隔）</label>
                    <input type="text" name="ipaddr_dnss" id="ipaddrDnss"
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                           placeholder="例如: 8.8.8.8, 8.8.4.4">
                    <p class="text-xs text-gray-500 mt-1">为虚拟机统一配置DNS服务器</p>
                </div>
            </div>

            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">API扩展选项 (JSON格式)</label>
                <textarea name="extend_data" id="extendData" rows="2"
                          class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                          placeholder='{"key": "value"}'></textarea>
            </div>

            <div class="modal-action">
                <button type="button" onclick="document.getElementById('hostModal').close()"
                        class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50">
                    取消
                </button>
                <button type="submit"
                        class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg flex items-center gap-2">
                    <span class="iconify" data-icon="mdi:check" data-width="18"></span>
                    保存
                </button>
            </div>
        </form>
    </div>
    <form method="dialog" class="modal-backdrop">
        <button>关闭</button>
    </form>
</dialog>

<!-- 删除确认模态框 -->
<dialog id="deleteModal" class="modal">
    <div class="modal-box">
        <h3 class="font-bold text-lg flex items-center gap-2 text-red-600">
            <span class="iconify" data-icon="mdi:alert-circle" data-width="24"></span>
            确认删除
        </h3>
        <p class="py-4">确定要删除主机 "<span id="deleteHostName" class="font-medium"></span>" 吗？此操作不可恢复。</p>
        <div class="modal-action">
            <button onclick="document.getElementById('deleteModal').close()"
                    class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50">
                取消
            </button>
            <button onclick="confirmDeleteHost()"
                    class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg">
                确认删除
            </button>
        </div>
    </div>
    <form method="dialog" class="modal-backdrop">
        <button>关闭</button>
    </form>
</dialog>
{% endblock %}

{% block extra_scripts %}
<script>
    let engineTypes = {};
    let currentDeleteHost = '';

    // 渲染公网IP地址（带复制功能）
    function renderPublicAddr(addrs) {
        if (!addrs || !Array.isArray(addrs) || addrs.length === 0) {
            return '未配置';
        }
        return addrs.map(ip =>
            `<span class="cursor-pointer hover:text-blue-600 inline-flex items-center gap-1" onclick="copyToClipboard('${ip}')" title="点击复制">${ip}<span class="iconify text-gray-400 hover:text-blue-600" data-icon="mdi:content-copy" data-width="12"></span></span>`
        ).join('<br>');
    }

    // 复制到剪贴板
    function copyToClipboard(text) {
        navigator.clipboard.writeText(text).then(() => {
            showToast('已复制: ' + text, 'success');
        }).catch(() => {
            showToast('复制失败', 'error');
        });
    }

    // 解析扩展数据JSON
    function parseExtendData(value) {
        if (!value || !value.trim()) return {};
        try {
            return JSON.parse(value);
        } catch (e) {
            showToast('扩展数据JSON格式错误', 'error');
            return {};
        }
    }

    // 系统映射相关函数 =======================================

    // 添加系统映射行
    function addSystemMapRow(systemName = '', systemFile = '', minSize = '') {
        const container = document.getElementById('systemMapsContainer');
        const rowId = Date.now() + Math.random();
        const rowHtml = `
            <div class="system-map-row bg-gray-50 p-3 rounded-lg" data-row-id="${rowId}">
                <div class="grid grid-cols-1 md:grid-cols-12 gap-3 items-end">
                    <div class="md:col-span-5">
                        <label class="block text-xs font-medium text-gray-600 mb-1">外部显示系统名称</label>
                        <input type="text" 
                            class="system-name w-full px-2 py-1.5 text-sm border border-gray-300 rounded focus:ring-1 focus:ring-blue-500 focus:border-transparent" 
                            placeholder="例如: Windows 10" 
                            value="${systemName}">
                    </div>
                    <div class="md:col-span-4">
                        <label class="block text-xs font-medium text-gray-600 mb-1">镜像文件(带后缀)</label>
                        <input type="text" 
                            class="system-file w-full px-2 py-1.5 text-sm border border-gray-300 rounded focus:ring-1 focus:ring-blue-500 focus:border-transparent" 
                            placeholder="例如: windows10.qcow2" 
                            value="${systemFile}">
                    </div>
                    <div class="md:col-span-2">
                        <label class="block text-xs font-medium text-gray-600 mb-1">最低大小(GB)</label>
                        <input type="number" 
                            class="min-size w-full px-2 py-1.5 text-sm border border-gray-300 rounded focus:ring-1 focus:ring-blue-500 focus:border-transparent" 
                            placeholder="例如: 20" 
                            min="0" 
                            step="0.1"
                            value="${minSize}">
                    </div>
                    <div class="md:col-span-1">
                        <button type="button" onclick="removeSystemMapRow('${rowId}')" 
                            class="w-full px-2 py-1.5 bg-red-500 text-white text-sm rounded hover:bg-red-600 flex items-center justify-center gap-1 whitespace-nowrap">
                            <span class="iconify" data-icon="mdi:delete" data-width="16"></span>
                        </button>
                    </div>
                </div>
            </div>
        `;
        container.insertAdjacentHTML('beforeend', rowHtml);
    }

    // 删除系统映射行
    function removeSystemMapRow(rowId) {
        const row = document.querySelector(`[data-row-id="${rowId}"]`);
        if (row) {
            row.remove();
        }
    }

    // 获取系统映射数据
    function getSystemMapsData() {
        const maps = {};
        const rows = document.querySelectorAll('.system-map-row');
        rows.forEach(row => {
            const systemName = row.querySelector('.system-name').value.trim();
            const systemFile = row.querySelector('.system-file').value.trim();
            const minSize = row.querySelector('.min-size').value.trim();

            if (systemName && systemFile) {
                maps[systemName] = [systemFile, minSize || '0'];
            }
        });
        return maps;
    }

    // 加载系统映射数据
    function loadSystemMapsData(systemMaps) {
        const container = document.getElementById('systemMapsContainer');
        container.innerHTML = ''; // 清空现有内容

        if (systemMaps && typeof systemMaps === 'object') {
            for (const [systemName, config] of Object.entries(systemMaps)) {
                if (Array.isArray(config) && config.length >= 2) {
                    addSystemMapRow(systemName, config[0], config[1]);
                } else if (Array.isArray(config) && config.length >= 1) {
                    addSystemMapRow(systemName, config[0], '');
                }
            }
        }

        // 如果没有任何映射，添加一个空行作为默认
        if (Object.keys(systemMaps || {}).length === 0) {
            addSystemMapRow();
        }
    }

    // ISO镜像映射配置相关函数 =======================================

    // 添加镜像映射行
    function addImageMapItem(displayName = '', fileName = '') {
        const container = document.getElementById('imagesMapsContainer');
        const rowId = Date.now() + Math.random();
        const rowHtml = `
            <div class="image-map-row bg-gray-50 p-3 rounded-lg" data-row-id="${rowId}">
                <div class="grid grid-cols-1 md:grid-cols-12 gap-3 items-end">
                    <div class="md:col-span-5">
                        <label class="block text-xs font-medium text-gray-600 mb-1">显示名称</label>
                        <input type="text" 
                            class="display-name w-full px-2 py-1.5 text-sm border border-gray-300 rounded focus:ring-1 focus:ring-blue-500 focus:border-transparent" 
                            placeholder="例如: Ubuntu 22.04 Server" 
                            value="${displayName}">
                    </div>
                    <div class="md:col-span-6">
                        <label class="block text-xs font-medium text-gray-600 mb-1">ISO文件名</label>
                        <input type="text" 
                            class="file-name w-full px-2 py-1.5 text-sm border border-gray-300 rounded focus:ring-1 focus:ring-blue-500 focus:border-transparent" 
                            placeholder="例如: ubuntu-22.04-server.iso" 
                            value="${fileName}">
                    </div>
                    <div class="md:col-span-1">
                        <button type="button" onclick="removeImageMapRow('${rowId}')" 
                            class="w-full px-2 py-1.5 bg-red-500 text-white text-sm rounded hover:bg-red-600 flex items-center justify-center gap-1">
                            <span class="iconify" data-icon="mdi:delete" data-width="16"></span>
                        </button>
                    </div>
                </div>
            </div>
        `;
        container.insertAdjacentHTML('beforeend', rowHtml);
    }

    // 删除镜像映射行
    function removeImageMapRow(rowId) {
        const row = document.querySelector(`[data-row-id="${rowId}"]`);
        if (row) {
            row.remove();
        }
    }

    // 获取镜像映射数据
    function getImagesMapsData() {
        const maps = {};
        const rows = document.querySelectorAll('.image-map-row');
        rows.forEach(row => {
            const displayName = row.querySelector('.display-name').value.trim();
            const fileName = row.querySelector('.file-name').value.trim();

            if (displayName && fileName) {
                maps[displayName] = fileName;
            }
        });
        return maps;
    }

    // 加载镜像映射数据
    function loadImagesMapsData(imagesMaps) {
        const container = document.getElementById('imagesMapsContainer');
        container.innerHTML = ''; // 清空现有内容

        if (imagesMaps && typeof imagesMaps === 'object') {
            for (const [displayName, fileName] of Object.entries(imagesMaps)) {
                addImageMapItem(displayName, fileName);
            }
        }

        // 如果没有任何映射，添加一个空行作为默认
        if (Object.keys(imagesMaps || {}).length === 0) {
            addImageMapItem();
        }
    }

    // IP地址池配置相关函数 =======================================

    // 添加IP地址池配置行
    function addIpaddrMapRow(setName = '', vers = 'ipv4', type = 'nat', gate = '', mask = '', fromIp = '', nums = '') {
        const container = document.getElementById('ipaddrMapsContainer');
        const rowId = Date.now() + Math.random();
        const rowHtml = `
            <div class="ipaddr-map-row bg-gray-50 p-3 rounded-lg" data-row-id="${rowId}">
                <!-- 第一行：基本配置 -->
                <div class="grid grid-cols-1 md:grid-cols-12 gap-3 items-end mb-3">
                    <div class="md:col-span-3">
                        <label class="block text-xs font-medium text-gray-600 mb-1">配置名称</label>
                        <input type="text"
                            class="set-name w-full px-2 py-1.5 text-sm border border-gray-300 rounded focus:ring-1 focus:ring-blue-500 focus:border-transparent"
                            placeholder="例如: default"
                            value="${setName}">
                    </div>
                    <div class="md:col-span-2">
                        <label class="block text-xs font-medium text-gray-600 mb-1">IP版本</label>
                        <select class="ip-vers w-full px-2 py-1.5 text-sm border border-gray-300 rounded focus:ring-1 focus:ring-blue-500 focus:border-transparent">
                            <option value="ipv4" ${vers === 'ipv4' ? 'selected' : ''}>IPv4</option>
                            <option value="ipv6" ${vers === 'ipv6' ? 'selected' : ''}>IPv6</option>
                        </select>
                    </div>
                    <div class="md:col-span-2">
                        <label class="block text-xs font-medium text-gray-600 mb-1">网络类型</label>
                        <select class="ip-type w-full px-2 py-1.5 text-sm border border-gray-300 rounded focus:ring-1 focus:ring-blue-500 focus:border-transparent">
                            <option value="nat" ${type === 'nat' ? 'selected' : ''}>NAT</option>
                            <option value="pub" ${type === 'pub' ? 'selected' : ''}>PUB</option>
                        </select>
                    </div>
                    <div class="md:col-span-4">
                        <label class="block text-xs font-medium text-gray-600 mb-1">数量</label>
                        <input type="number"
                            class="ip-nums w-full px-2 py-1.5 text-sm border border-gray-300 rounded focus:ring-1 focus:ring-blue-500 focus:border-transparent"
                            placeholder="100"
                            min="1"
                            value="${nums}">
                    </div>
                    <div class="md:col-span-1">
                        <button type="button" onclick="removeIpaddrMapRow('${rowId}')"
                            class="w-full px-2 py-1.5 bg-red-500 text-white text-sm rounded hover:bg-red-600 flex items-center justify-center gap-1">
                            <span class="iconify" data-icon="mdi:delete" data-width="16"></span>
                        </button>
                    </div>
                </div>
                <!-- 第二行：网络配置 -->
                <div class="grid grid-cols-1 md:grid-cols-12 gap-3 items-end">
                    <div class="md:col-span-4">
                        <label class="block text-xs font-medium text-gray-600 mb-1">起始IP地址</label>
                        <input type="text"
                            class="ip-from w-full px-2 py-1.5 text-sm border border-gray-300 rounded focus:ring-1 focus:ring-blue-500 focus:border-transparent"
                            placeholder="例如: 192.168.1.100"
                            value="${fromIp}">
                    </div>
                    <div class="md:col-span-4">
                        <label class="block text-xs font-medium text-gray-600 mb-1">网关地址</label>
                        <input type="text"
                            class="ip-gate w-full px-2 py-1.5 text-sm border border-gray-300 rounded focus:ring-1 focus:ring-blue-500 focus:border-transparent"
                            placeholder="例如: 192.168.1.1"
                            value="${gate}">
                    </div>
                    <div class="md:col-span-4">
                        <label class="block text-xs font-medium text-gray-600 mb-1">子网掩码</label>
                        <input type="text"
                            class="ip-mask w-full px-2 py-1.5 text-sm border border-gray-300 rounded focus:ring-1 focus:ring-blue-500 focus:border-transparent"
                            placeholder="例如: 255.255.255.0"
                            value="${mask}">
                    </div>
                </div>
            </div>
        `;
        container.insertAdjacentHTML('beforeend', rowHtml);
    }

    // 删除IP地址池配置行
    function removeIpaddrMapRow(rowId) {
        const row = document.querySelector(`[data-row-id="${rowId}"]`);
        if (row) {
            row.remove();
        }
    }

    // 获取IP地址池配置数据
    function getIpaddrMapsData() {
        const maps = {};
        const rows = document.querySelectorAll('.ipaddr-map-row');
        rows.forEach(row => {
            const setName = row.querySelector('.set-name').value.trim();
            const vers = row.querySelector('.ip-vers').value;
            const type = row.querySelector('.ip-type').value;
            const gate = row.querySelector('.ip-gate').value.trim();
            const mask = row.querySelector('.ip-mask').value.trim();
            const fromIp = row.querySelector('.ip-from').value.trim();
            const nums = parseInt(row.querySelector('.ip-nums').value) || 0;

            if (setName && fromIp && nums > 0) {
                maps[setName] = {
                    vers: vers,
                    type: type,
                    gate: gate,
                    mask: mask,
                    from: fromIp,
                    nums: nums
                };
            }
        });
        return maps;
    }

    // 加载IP地址池配置数据
    function loadIpaddrMapsData(ipaddrMaps) {
        const container = document.getElementById('ipaddrMapsContainer');
        container.innerHTML = ''; // 清空现有内容

        if (ipaddrMaps && typeof ipaddrMaps === 'object') {
            for (const [setName, config] of Object.entries(ipaddrMaps)) {
                if (config && typeof config === 'object') {
                    addIpaddrMapRow(
                        setName,
                        config.vers || 'ipv4',
                        config.type || 'nat',
                        config.gate || '',
                        config.mask || '',
                        config.from || '',
                        config.nums || ''
                    );
                }
            }
        }

        // 如果没有任何配置，添加一个空行作为默认
        if (Object.keys(ipaddrMaps || {}).length === 0) {
            addIpaddrMapRow();
        }
    }

    // 页面加载完成后执行
    $(document).ready(function () {
        loadEngineTypes();
        loadHosts();
    });

    // 加载引擎类型
    async function loadEngineTypes() {
        const result = await apiRequest('/api/system/engine');
        if (result && result.code === 200) {
            const data = result.data;
            engineTypes = data.engine_types || data; // 兼容新旧格式
            const select = document.getElementById('hostType');
            select.innerHTML = '<option value="">请选择类型</option>';

            for (const [type, config] of Object.entries(engineTypes)) {
                if (config.enabled) {
                    const option = document.createElement('option');
                    option.value = type;
                    option.textContent = `${config.description} (${type})`;
                    select.appendChild(option);
                }
            }

            // 添加主机类型选择事件监听
            select.addEventListener('change', function() {
                const selectedType = this.value;
                showHostTypeInfo(selectedType);
            });
        }
    }

    // 显示主机类型信息
    function showHostTypeInfo(type) {
        const infoContainer = document.getElementById('hostTypeInfo');
        const messagesContainer = document.getElementById('hostTypeMessages');
        const messagesList = document.getElementById('hostTypeMessagesList');
        const optionalContainer = document.getElementById('hostTypeOptional');
        const optionalList = document.getElementById('hostTypeOptionalList');

        if (!type || !engineTypes[type]) {
            infoContainer.classList.add('hidden');
            return;
        }

        const config = engineTypes[type];
        let hasInfo = false;

        // 显示 Messages
        if (config.messages && config.messages.length > 0) {
            messagesList.innerHTML = '';
            config.messages.forEach(msg => {
                const li = document.createElement('li');
                li.textContent = msg;
                messagesList.appendChild(li);
            });
            messagesContainer.classList.remove('hidden');
            hasInfo = true;
        } else {
            messagesContainer.classList.add('hidden');
        }

        // 显示 Optional
        if (config.options && Object.keys(config.options).length > 0) {
            optionalList.innerHTML = '';
            for (const [key, description] of Object.entries(config.options)) {
                const div = document.createElement('div');
                div.className = 'flex items-start gap-2';
                div.innerHTML = `
                    <span class="iconify text-blue-600 mt-0.5" data-icon="mdi:chevron-right" data-width="16"></span>
                    <span><strong>${key}:</strong> ${description}</span>
                `;
                optionalList.appendChild(div);
            }
            optionalContainer.classList.remove('hidden');
            hasInfo = true;
        } else {
            optionalContainer.classList.add('hidden');
        }

        // 显示或隐藏整个信息容器
        if (hasInfo) {
            infoContainer.classList.remove('hidden');
        } else {
            infoContainer.classList.add('hidden');
        }
    }

    // 加载主机列表
    async function loadHosts() {
        const container = document.getElementById('hostsList');
        container.innerHTML = `
            <div class="col-span-full text-center py-16 text-gray-500">
                <span class="iconify animate-pulse-slow text-gray-400" data-icon="mdi:loading" data-width="48"></span>
                <p class="mt-4" data-i18n="加载中...">加载中...</p>
            </div>
        `;

        const result = await apiRequest('/api/server/detail');
        if (result && result.code === 200) {
            const hosts = result.data;
            const count = Object.keys(hosts).length;
            document.getElementById('hostCount').textContent = count;

            if (count === 0) {
                container.innerHTML = `
                    <div class="col-span-full text-center py-16">
                        <span class="iconify text-gray-300" data-icon="mdi:server-off" data-width="64"></span>
                        <p class="mt-4 text-gray-500">暂无主机</p>
                        <button onclick="openAddHostModal()" class="mt-4 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm">
                            添加第一个主机
                        </button>
                    </div>
                `;
                return;
            }

            container.innerHTML = '';
            // 并行获取所有主机的状态信息
            const statusPromises = Object.keys(hosts).map(name =>
                apiRequest(`/api/server/status/${name}`).catch(() => null)
            );
            const statusResults = await Promise.all(statusPromises);

            // 创建状态映射
            const statusMap = {};
            Object.keys(hosts).forEach((name, index) => {
                const statusResult = statusResults[index];
                if (statusResult && statusResult.code === 200) {
                    statusMap[name] = statusResult.data.status;
                }
            });

            for (const [name, host] of Object.entries(hosts)) {
                container.innerHTML += renderHostCard(name, host, statusMap[name]);
            }
        }
    }

    // 格式化字节大小
    function formatBytes(bytes, decimals = 2) {
        if (bytes === 0) return '0 B';
        const k = 1024;
        const dm = decimals < 0 ? 0 : decimals;
        const sizes = ['B', 'KB', 'MB', 'GB', 'TB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(dm)) + ' ' + sizes[i];
    }

    // 格式化MB大小
    function formatMB(mb) {
        if (mb >= 1024) {
            return (mb / 1024).toFixed(1) + ' GB';
        }
        return mb + ' MB';
    }

    // 获取进度条颜色
    function getProgressColor(percent) {
        if (percent >= 90) return 'bg-red-500';
        if (percent >= 75) return 'bg-orange-500';
        if (percent >= 50) return 'bg-yellow-500';
        return 'bg-green-500';
    }

    // 渲染主机卡片
    function renderHostCard(name, host, status) {
        const typeInfo = engineTypes[host.type] || {};

        // 计算各项资源使用率
        const cpuPercent = status ? Math.min(status.cpu_usage || 0, 100) : 0;
        const memPercent = status && status.mem_total > 0 ? Math.min((status.mem_usage / status.mem_total * 100), 100) : 0;
        const memUsageGB = status ? (status.mem_usage / 1024).toFixed(1) : 0;
        const memTotalGB = status ? (status.mem_total / 1024).toFixed(1) : 0;

        // 获取第一个磁盘（系统盘）
        let diskPercent = 0;
        let diskTotal = 0;
        let diskUsage = 0;
        let diskName = '系统盘';
        if (status && status.ext_usage) {
            const disks = Object.entries(status.ext_usage);
            if (disks.length > 0) {
                const [name, [total, used]] = disks[0];
                diskName = name;
                diskTotal = total;
                diskUsage = used;
                diskPercent = total > 0 ? Math.min((used / total * 100), 100) : 0;
            }
        }
        const diskUsageGB = (diskUsage / 1024).toFixed(1);
        const diskTotalGB = (diskTotal / 1024).toFixed(1);

        // 网络带宽（从network_a获取，单位Mbps）
        const networkA = status ? (status.network_a || 1000) : 1000; // Mbps
        const maxBandwidth = networkA * 1024 / 8; // 转换为KB/s
        const networkU = status ? (status.network_u || 0) : 0; // KB/s
        const networkD = status ? (status.network_d || 0) : 0; // KB/s
        const networkUPercent = Math.min((networkU / maxBandwidth * 100), 100);
        const networkDPercent = Math.min((networkD / maxBandwidth * 100), 100);

        // GPU使用率（取第一个GPU）
        let gpuPercent = 0;
        if (status && status.gpu_usage) {
            const gpuKeys = Object.keys(status.gpu_usage);
            if (gpuKeys.length > 0) {
                gpuPercent = Math.min(status.gpu_usage[gpuKeys[0]] || 0, 100);
            }
        }

        // CPU温度和功耗
        const cpuTemp = status ? (status.cpu_heats || 0) : 0;
        const cpuPower = status ? (status.cpu_power || 0) : 0;
        const cpuTempPercent = Math.min((cpuTemp / 100 * 100), 100);

        return `
            <div class="bg-white rounded-lg border border-gray-200 card-hover overflow-hidden">
                <div class="p-4">
                    <div class="flex items-start justify-between mb-3">
                        <div class="flex items-center gap-3">
                            <div class="w-12 h-12 bg-gradient-to-br from-blue-500 to-blue-600 rounded-lg flex items-center justify-center shadow-md">
                                <span class="iconify text-white" data-icon="mdi:server" data-width="28"></span>
                            </div>
                            <div>
                                <h3 class="font-semibold text-gray-800">${name}</h3>
                                <p class="text-sm text-gray-500">${typeInfo.description || host.type}</p>
                            </div>
                        </div>
                        <span class="px-2 py-1 text-xs font-medium ${host.status === 'active' ? 'text-green-700 bg-green-100' : 'text-gray-600 bg-gray-100'} rounded-full flex items-center gap-1">
                            ${host.status === 'active' ? '<span class="w-1.5 h-1.5 bg-green-500 rounded-full animate-pulse"></span>' : ''}
                            ${host.status === 'active' ? '运行中' : '已停止'}
                        </span>
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <!-- 左侧：基本信息 -->
                        <div class="space-y-2 text-sm">
                            <div class="flex items-center justify-between text-gray-600">
                                <span class="flex items-center gap-1">
                                    <span class="iconify" data-icon="mdi:ip-network" data-width="16"></span>
                                    地址
                                </span>
                                <span class="font-medium text-gray-800">${host.addr || '未配置'}</span>
                            </div>
                            <div class="flex items-center justify-between text-gray-600">
                                <span class="flex items-center gap-1">
                                    <span class="iconify" data-icon="mdi:earth" data-width="16"></span>
                                    外网IP
                                </span>
                                <span class="font-medium text-gray-800">${renderPublicAddr(host.config?.public_addr)}</span>
                            </div>
                            ${host.config?.i_kuai_addr ? `
                            <div class="flex items-center justify-between text-gray-600">
                                <span class="flex items-center gap-1">
                                    <span class="iconify" data-icon="mdi:router-network" data-width="16"></span>
                                    爱快OS
                                </span>
                                <span class="font-medium text-gray-800">${host.config.i_kuai_addr}</span>
                            </div>
                            ` : ''}
                            ${host.config?.ports_start && host.config?.ports_close ? `
                            <div class="flex items-center justify-between text-gray-600">
                                <span class="flex items-center gap-1">
                                    <span class="iconify" data-icon="mdi:network-outline" data-width="16"></span>
                                    端口范围
                                </span>
                                <span class="font-medium text-gray-800">${host.config.ports_start}-${host.config.ports_close}</span>
                            </div>
                            ` : ''}
                            ${host.config?.remote_port ? `
                            <div class="flex items-center justify-between text-gray-600">
                                <span class="flex items-center gap-1">
                                    <span class="iconify" data-icon="mdi:remote-desktop" data-width="16"></span>
                                    VNC端口
                                </span>
                                <span class="font-medium text-gray-800">${host.config.remote_port}</span>
                            </div>
                            ` : ''}
                            ${host.config?.system_maps && Object.keys(host.config.system_maps).length > 0 ? `
                            <div class="flex items-center justify-between text-gray-600">
                                <span class="flex items-center gap-1">
                                    <span class="iconify" data-icon="mdi:file-table-outline" data-width="16"></span>
                                    系统映射
                                </span>
                                <span class="font-medium text-gray-800">${Object.keys(host.config.system_maps).length} 个</span>
                            </div>
                            ` : ''}
                            <div class="flex items-center justify-between text-gray-600">
                                <span class="flex items-center gap-1">
                                    <span class="iconify" data-icon="mdi:cube-outline" data-width="16"></span>
                                    虚拟机
                                </span>
                                <span class="font-medium text-gray-800">${host.vm_count || 0} 台</span>
                            </div>
                        </div>

                        <!-- 右侧：资源状态 -->
                        <div class="space-y-2 text-sm">
                            ${status ? `
                            <!-- CPU -->
                            <div>
                                <div class="flex items-center justify-between text-gray-600 mb-1">
                                    <span class="flex items-center gap-1" title="${status.cpu_model || 'CPU'}">
                                        <span class="iconify" data-icon="mdi:chip" data-width="14"></span>
                                        ${status.cpu_model || 'CPU'}
                                    </span>
                                    <span class="text-xs">${status.cpu_total || 0}核 ${cpuPercent.toFixed(1)}%</span>
                                </div>
                                <div class="w-full bg-gray-200 rounded-full h-2">
                                    <div class="${getProgressColor(cpuPercent)} h-2 rounded-full transition-all" style="width: ${cpuPercent}%"></div>
                                </div>
                            </div>
                            
                            <!-- 内存 -->
                            <div>
                                <div class="flex items-center justify-between text-gray-600 mb-1">
                                    <span class="flex items-center gap-1">
                                        <span class="iconify" data-icon="mdi:memory" data-width="14"></span>
                                        内存
                                    </span>
                                    <span class="text-xs">${memUsageGB}GB/${memTotalGB}GB ${memPercent.toFixed(1)}%</span>
                                </div>
                                <div class="w-full bg-gray-200 rounded-full h-2">
                                    <div class="${getProgressColor(memPercent)} h-2 rounded-full transition-all" style="width: ${memPercent}%"></div>
                                </div>
                            </div>
                            
                            <!-- 系统盘 -->
                            <div>
                                <div class="flex items-center justify-between text-gray-600 mb-1">
                                    <span class="flex items-center gap-1">
                                        <span class="iconify" data-icon="mdi:harddisk" data-width="14"></span>
                                        ${diskName}
                                    </span>
                                    <span class="text-xs">${diskUsageGB}GB/${diskTotalGB}GB ${diskPercent.toFixed(1)}%</span>
                                </div>
                                <div class="w-full bg-gray-200 rounded-full h-2">
                                    <div class="${getProgressColor(diskPercent)} h-2 rounded-full transition-all" style="width: ${diskPercent}%"></div>
                                </div>
                            </div>
                            
                            <!-- 网络带宽 -->
                            <div>
                                <div class="flex items-center justify-between text-gray-600 mb-1">
                                    <span class="flex items-center gap-1">
                                        <span class="iconify" data-icon="mdi:network" data-width="14"></span>
                                        网络
                                    </span>
                                    <span class="text-xs">↑${(networkU / 1024).toFixed(1)}MB/s ↓${(networkD / 1024).toFixed(1)}MB/s</span>
                                </div>
                                <div class="w-full bg-gray-200 rounded-full h-2 flex gap-0.5">
                                    <div class="bg-blue-500 h-2 rounded-l-full transition-all" style="width: ${networkUPercent / 2}%"></div>
                                    <div class="bg-green-500 h-2 rounded-r-full transition-all" style="width: ${networkDPercent / 2}%"></div>
                                </div>
                            </div>
                            
                            <!-- GPU -->
                            <div>
                                <div class="flex items-center justify-between text-gray-600 mb-1">
                                    <span class="flex items-center gap-1">
                                        <span class="iconify" data-icon="mdi:expansion-card" data-width="14"></span>
                                        GPU
                                    </span>
                                    <span class="text-xs">${status.gpu_total || 0}个 ${gpuPercent.toFixed(1)}%</span>
                                </div>
                                <div class="w-full bg-gray-200 rounded-full h-2">
                                    <div class="${getProgressColor(gpuPercent)} h-2 rounded-full transition-all" style="width: ${gpuPercent}%"></div>
                                </div>
                            </div>
                            
                            <!-- CPU温度和功耗 -->
                            <div>
                                <div class="flex items-center justify-between text-gray-600 mb-1">
                                    <span class="flex items-center gap-1">
                                        <span class="iconify" data-icon="mdi:thermometer" data-width="14"></span>
                                        温度/功耗
                                    </span>
                                    <span class="text-xs">${cpuTemp}℃ ${cpuPower}W</span>
                                </div>
                                <div class="w-full bg-gray-200 rounded-full h-2">
                                    <div class="${getProgressColor(cpuTempPercent)} h-2 rounded-full transition-all" style="width: ${cpuTempPercent}%"></div>
                                </div>
                            </div>
                            ` : '<div class="text-center text-gray-400 py-8 text-xs">暂无状态数据</div>'}
                        </div>
                    </div>
                </div>

                <div class="border-t border-gray-200 px-4 py-3 bg-gray-50 flex items-center justify-between">
                    <a href="/hosts/${name}/vms" class="text-blue-600 hover:text-blue-800 text-sm font-medium flex items-center gap-1">
                        <span class="iconify" data-icon="mdi:cube-outline" data-width="16"></span>
                        虚拟机管理
                    </a>
                    <div class="flex items-center gap-2">
                        <button onclick="scanHostBackups('${name}')"
                            class="p-2 rounded-lg hover:bg-purple-100 text-purple-600" title="扫描备份">
                            <span class="iconify" data-icon="mdi:backup-restore" data-width="18"></span>
                        </button>
                        <button onclick="scanHostVMs('${name}')"
                            class="p-2 rounded-lg hover:bg-orange-100 text-orange-600" title="扫描虚拟机">
                            <span class="iconify" data-icon="mdi:radar" data-width="18"></span>
                        </button>
                        <button onclick="toggleHost('${name}', ${host.status !== 'active'})"
                            class="p-2 rounded-lg hover:bg-gray-200 text-gray-600" title="${host.status === 'active' ? '停止' : '启动'}">
                            <span class="iconify" data-icon="${host.status === 'active' ? 'mdi:stop' : 'mdi:play'}" data-width="18"></span>
                        </button>
                        <button onclick="editHost('${name}')"
                            class="p-2 rounded-lg hover:bg-gray-200 text-gray-600" title="编辑">
                            <span class="iconify" data-icon="mdi:pencil" data-width="18"></span>
                        </button>
                        <button onclick="deleteHost('${name}')"
                            class="p-2 rounded-lg hover:bg-red-100 text-red-600" title="删除">
                            <span class="iconify" data-icon="mdi:delete" data-width="18"></span>
                        </button>
                    </div>
                </div>
            </div>
        `;
    }

    // 打开添加主机模态框
    function openAddHostModal() {
        document.getElementById('modalTitle').innerHTML = `
            <span class="iconify text-blue-600" data-icon="mdi:server-plus" data-width="24"></span>
            添加主机
        `;
        document.getElementById('editMode').value = 'add';
        document.getElementById('hostForm').reset();
        document.getElementById('hostName').disabled = false;
        // 初始化系统映射为空
        loadSystemMapsData({});
        loadImagesMapsData({});
        // 隐藏主机类型信息
        document.getElementById('hostTypeInfo').classList.add('hidden');
        document.getElementById('hostModal').showModal();
    }

    // 编辑主机
    async function editHost(name) {
        const result = await apiRequest(`/api/server/detail/${name}`);
        if (result && result.code === 200) {
            const host = result.data;

            document.getElementById('modalTitle').innerHTML = `
                <span class="iconify text-blue-600" data-icon="mdi:server-edit" data-width="24"></span>
                编辑主机
            `;
            document.getElementById('editMode').value = 'edit';
            document.getElementById('originalName').value = name;
            document.getElementById('hostName').value = name;
            document.getElementById('hostName').disabled = true;
            document.getElementById('hostType').value = host.type;

            const config = host.config || {};
            document.getElementById('serverAddr').value = config.server_addr || '';
            document.getElementById('serverUser').value = config.server_user || '';
            document.getElementById('serverPass').value = config.server_pass || '';
            document.getElementById('filterName').value = config.filter_name || '';
            document.getElementById('imagesPath').value = config.images_path || '';
            document.getElementById('dvdromPath').value = config.dvdrom_path || '';  // 光盘镜像存储路径
            document.getElementById('systemPath').value = config.system_path || '';
            document.getElementById('backupPath').value = config.backup_path || '';
            document.getElementById('externPath').value = config.extern_path || '';
            document.getElementById('launchPath').value = config.launch_path || '';
            document.getElementById('serverPort').value = config.server_port || '';  // 服务访问端口
            document.getElementById('networkNat').value = config.network_nat || '';
            document.getElementById('networkPub').value = config.network_pub || '';
            document.getElementById('iKuaiAddr').value = config.i_kuai_addr || '';
            document.getElementById('iKuaiUser').value = config.i_kuai_user || '';
            document.getElementById('iKuaiPass').value = config.i_kuai_pass || '';
            document.getElementById('portsStart').value = config.ports_start || '';
            document.getElementById('portsClose').value = config.ports_close || '';
            document.getElementById('remotePort').value = config.remote_port || '';
            document.getElementById('limitsNums').value = config.limits_nums || '';
            loadSystemMapsData(config.system_maps || {});
            loadImagesMapsData(config.images_maps || {});
            loadIpaddrMapsData(config.ipaddr_maps || {});
            document.getElementById('ipaddrDnss').value = (config.ipaddr_dnss || []).join(', ');
            document.getElementById('publicAddr').value = (config.public_addr || []).join(', ');
            document.getElementById('extendData').value = config.extend_data ? JSON.stringify(config.extend_data, null, 2) : '';
            
            // 显示主机类型信息
            showHostTypeInfo(host.type);
            
            document.getElementById('hostModal').showModal();
        }
    }

    // 删除主机
    function deleteHost(name) {
        currentDeleteHost = name;
        document.getElementById('deleteHostName').textContent = name;
        document.getElementById('deleteModal').showModal();
    }

    // 确认删除主机
    async function confirmDeleteHost() {
        if (!currentDeleteHost) return;

        const result = await apiRequest(`/api/server/delete/${currentDeleteHost}`, 'DELETE');
        if (result && result.code === 200) {
            showToast('主机已删除', 'success');
            document.getElementById('deleteModal').close();
            loadHosts();
        } else {
            showToast(result?.msg || '删除失败', 'error');
        }
        currentDeleteHost = '';
    }

    // 切换主机状态
    async function toggleHost(name, enable) {
        const result = await apiRequest(`/api/server/powers/${name}`, 'POST', {enable});
        if (result && result.code === 200) {
            showToast(result.msg, 'success');
            loadHosts();
        } else {
            showToast(result?.msg || '操作失败', 'error');
        }
    }

    // 扫描主机上的虚拟机
    async function scanHostVMs(hostName) {
        // 显示扫描中状态
        Swal.fire({
            title: '扫描中...',
            html: `正在扫描主机 "<strong>${hostName}</strong>" 上的虚拟机`,
            allowOutsideClick: false,
            allowEscapeKey: false,
            showConfirmButton: false,
            didOpen: () => {
                Swal.showLoading();
            }
        });

        try {
            const result = await apiRequest(`/api/client/scaner/${hostName}`, 'POST', {});

            if (result && result.code === 200) {
                const data = result.data || {};
                const scanned = data.scanned || 0;
                const added = data.added || 0;

                Swal.fire({
                    icon: 'success',
                    title: '扫描完成',
                    html: `扫描到 <strong>${scanned}</strong> 台虚拟机<br>新增 <strong>${added}</strong> 台虚拟机`,
                    timer: 3000,
                    showConfirmButton: true,
                    confirmButtonText: '确定'
                });

                // 刷新主机列表以更新虚拟机数量
                loadHosts();
            } else {
                Swal.fire({
                    icon: 'error',
                    title: '扫描失败',
                    text: result?.msg || '扫描虚拟机失败，请重试'
                });
            }
        } catch (error) {
            Swal.fire({
                icon: 'error',
                title: '扫描失败',
                text: '网络错误或服务器异常'
            });
        }
    }

    // 扫描主机备份文件
    async function scanHostBackups(hostName) {
        // 显示扫描中状态
        Swal.fire({
            title: '扫描中...',
            html: `正在扫描主机 "<strong>${hostName}</strong>" 的备份文件`,
            allowOutsideClick: false,
            allowEscapeKey: false,
            showConfirmButton: false,
            didOpen: () => {
                Swal.showLoading();
            }
        });

        try {
            const result = await apiRequest(`/api/server/backup/scan/${hostName}`, 'POST', {});

            if (result && result.code === 200) {
                Swal.fire({
                    icon: 'success',
                    title: '扫描完成',
                    text: '备份文件扫描成功',
                    timer: 2000,
                    showConfirmButton: true,
                    confirmButtonText: '确定'
                });

                // 刷新主机列表
                loadHosts();
            } else {
                Swal.fire({
                    icon: 'error',
                    title: '扫描失败',
                    text: result?.msg || '扫描备份文件失败，请重试'
                });
            }
        } catch (error) {
            Swal.fire({
                icon: 'error',
                title: '扫描失败',
                text: '网络错误或服务器异常'
            });
        }
    }

    // 表单提交
    document.getElementById('hostForm').addEventListener('submit', async (e) => {
        e.preventDefault();

        const editMode = document.getElementById('editMode').value;
        const name = document.getElementById('hostName').value;
        const type = document.getElementById('hostType').value;

        const config = {
            server_type: type,
            server_addr: document.getElementById('serverAddr').value,
            server_user: document.getElementById('serverUser').value,
            server_pass: document.getElementById('serverPass').value,
            filter_name: document.getElementById('filterName').value,
            images_path: document.getElementById('imagesPath').value,
            dvdrom_path: document.getElementById('dvdromPath').value,  // 光盘镜像存储路径
            system_path: document.getElementById('systemPath').value,
            backup_path: document.getElementById('backupPath').value,
            extern_path: document.getElementById('externPath').value,
            launch_path: document.getElementById('launchPath').value,
            server_port: parseInt(document.getElementById('serverPort').value) || 0,  // 服务访问端口
            network_nat: document.getElementById('networkNat').value,
            network_pub: document.getElementById('networkPub').value,
            i_kuai_addr: document.getElementById('iKuaiAddr').value,
            i_kuai_user: document.getElementById('iKuaiUser').value,
            i_kuai_pass: document.getElementById('iKuaiPass').value,
            ports_start: parseInt(document.getElementById('portsStart').value) || 0,
            ports_close: parseInt(document.getElementById('portsClose').value) || 0,
            remote_port: parseInt(document.getElementById('remotePort').value) || 0,
            limits_nums: parseInt(document.getElementById('limitsNums').value) || 0,
            system_maps: getSystemMapsData(),
            images_maps: getImagesMapsData(),
            ipaddr_maps: getIpaddrMapsData(),
            ipaddr_dnss: document.getElementById('ipaddrDnss').value.split(',').map(s => s.trim()).filter(s => s),
            public_addr: document.getElementById('publicAddr').value.split(',').map(s => s.trim()).filter(s => s),
            extend_data: parseExtendData(document.getElementById('extendData').value)
        };

        let result;
        if (editMode === 'add') {
            result = await apiRequest('/api/server/create', 'POST', {name, type, config});
        } else {
            const originalName = document.getElementById('originalName').value;
            result = await apiRequest(`/api/server/update/${originalName}`, 'PUT', {config});
        }

        if (result && result.code === 200) {
            showToast(editMode === 'add' ? '主机添加成功' : '主机更新成功', 'success');
            document.getElementById('hostModal').close();
            loadHosts();
        } else {
            showToast(result?.msg || '操作失败', 'error');
        }
    });
</script>
{% endblock %}
