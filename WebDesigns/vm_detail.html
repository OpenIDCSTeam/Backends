{% extends "base.html" %}
{% from 'partials/vm_config_form.html' import resource_config, network_config %}

{% block content %}
<style>
    /* 降低编辑模态框的z-index */
    #vmEditModal {
        z-index: 50 !important;
    }

    #vmEditModal::backdrop {
        z-index: 49 !important;
    }

    /* SweetAlert2 弹窗置顶样式 - 确保在所有模态框之上 */
    .swal2-container {
        z-index: 10000 !important;
    }
    
    /* 自定义确认对话框样式 */
    .transform {
        transform-origin: center;
    }
    .scale-95 {
        transform: scale(0.95);
        opacity: 0.9;
    }
    .scale-100 {
        transform: scale(1);
        opacity: 1;
    }
    .transition-all {
        transition: all 0.15s ease-in-out;
    }
</style>

<!-- 面包屑导航 -->
<div class="mb-6">
    <div class="flex items-center text-sm text-gray-500">
        <a href="/hosts" class="hover:text-blue-600">主机管理</a>
        <span class="iconify mx-2" data-icon="mdi:chevron-right" data-width="16"></span>
        <a href="/hosts/{{ hs_name }}/vms" class="hover:text-blue-600">{{ hs_name }}</a>
        <span class="iconify mx-2" data-icon="mdi:chevron-right" data-width="16"></span>
        <span class="text-gray-700 font-medium">{{ vm_uuid }}</span>
    </div>
</div>

<!-- 隐藏的当前用户信息 -->
<div id="currentUserContainer" style="display: none;" data-current-user="{{ username if username else '' }}"></div>

<!-- 虚拟机头部信息 -->
<div class="bg-white rounded-lg border border-gray-200 p-4 mb-4">
    <div class="flex items-center justify-between">
        <div class="flex items-center gap-3">
            <div id="vmIconBg"
                 class="w-12 h-12 bg-gradient-to-br from-purple-500 to-purple-600 rounded-lg flex items-center justify-center shadow-md">
                <span class="iconify text-white" data-icon="mdi:cube-outline" data-width="28"></span>
            </div>
            <div>
                <h1 class="text-lg font-semibold text-gray-800">{{ vm_uuid }}</h1>
                <p id="vmOsName" class="text-sm text-gray-500">加载中...</p>
                <div class="flex items-center gap-2 mt-1">
                    <span class="text-xs text-gray-400">系统密码:</span>
                    <input type="password" id="vmOsPass" readonly
                           class="text-xs text-gray-600 bg-transparent border-none p-0 w-24"
                           value="********">
                    <button type="button" onclick="togglePasswordVisibility()"
                            class="text-gray-400 hover:text-gray-600 transition-colors"
                            title="查看/隐藏密码">
                        <span id="eyeIcon" class="iconify" data-icon="mdi:eye-outline" data-width="16"></span>
                    </button>
                    <button type="button" onclick="copyPassword()"
                            class="text-gray-400 hover:text-gray-600 transition-colors"
                            title="复制密码">
                        <span class="iconify" data-icon="mdi:content-copy" data-width="16"></span>
                    </button>
                    <span class="text-xs text-gray-400 ml-4">VNC密码:</span>
                    <input type="password" id="vmVncPass" readonly
                           class="text-xs text-gray-600 bg-transparent border-none p-0 w-24"
                           value="********">
                    <button type="button" onclick="toggleVncPasswordVisibility()"
                            class="text-gray-400 hover:text-gray-600 transition-colors"
                            title="查看/隐藏VNC密码">
                        <span id="vncEyeIcon" class="iconify" data-icon="mdi:eye-outline" data-width="16"></span>
                    </button>
                    <button type="button" onclick="copyVncPassword()"
                            class="text-gray-400 hover:text-gray-600 transition-colors"
                            title="复制VNC密码">
                        <span class="iconify" data-icon="mdi:content-copy" data-width="16"></span>
                    </button>
                </div>
            </div>
        </div>
        <div class="flex items-center gap-3">
            <div id="vmStatus">
                <span class="px-3 py-1 text-sm font-medium text-gray-600 bg-gray-100 rounded-full">加载中...</span>
            </div>
            <button id="changePasswordBtn" onclick="showChangePasswordModal()" style="display: none;"
                    class="px-3 py-1.5 text-sm font-medium text-blue-700 bg-blue-50 hover:bg-blue-100 border border-blue-200 rounded-lg transition flex items-center gap-1">
                <span class="iconify" data-icon="mdi:key" data-width="16"></span>
                修改密码
            </button>
        </div>
    </div>
</div>

<!-- Tab导航 -->
<div role="tablist" class="tabs tabs-boxed bg-white p-2 rounded-lg shadow-sm mb-6">
    <a role="tab" class="tab tab-active" onclick="switchTab('info')">
        <span class="iconify mr-1" data-icon="mdi:information-outline" data-width="18"></span>
        信息
    </a>
    <a role="tab" class="tab" onclick="switchTab('nat')">
        <span class="iconify mr-1" data-icon="mdi:swap-horizontal" data-width="18"></span>
        NAT端口转发
    </a>
    <a role="tab" class="tab" onclick="switchTab('ip')">
        <span class="iconify mr-1" data-icon="mdi:ip-network" data-width="18"></span>
        IP地址管理
    </a>
    <a role="tab" class="tab" onclick="switchTab('proxy')">
        <span class="iconify mr-1" data-icon="mdi:web" data-width="18"></span>
        反向代理
    </a>
    <a role="tab" class="tab" onclick="switchTab('hdd')">
        <span class="iconify mr-1" data-icon="mdi:harddisk" data-width="18"></span>
        数据盘
    </a>
    <a role="tab" class="tab" onclick="switchTab('iso')">
        <span class="iconify mr-1" data-icon="mdi:disc" data-width="18"></span>
        ISO挂载
    </a>
    <a role="tab" class="tab" onclick="switchTab('backup')">
        <span class="iconify mr-1" data-icon="mdi:backup-restore" data-width="18"></span>
        备份管理
    </a>
    <a role="tab" class="tab" onclick="switchTab('owners')">
        <span class="iconify mr-1" data-icon="mdi:account-multiple" data-width="18"></span>
        用户管理
    </a>
</div>

<!-- Tab内容 -->
<div id="tabContent">
    <!-- 信息Tab -->
    <div id="infoTab" class="tab-pane active">
        <!-- IP地址信息 -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
            <div class="bg-white rounded-lg border border-gray-200 p-4">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 bg-blue-100 rounded-lg flex items-center justify-center">
                        <span class="iconify text-blue-600" data-icon="mdi:ip-network" data-width="24"></span>
                    </div>
                    <div class="flex-1">
                        <p class="text-sm text-gray-600">虚拟机IPv4地址</p>
                        <p id="vmIPv4" class="text-base font-mono font-medium text-gray-800 mt-0.5">-</p>
                    </div>
                </div>
            </div>
            <div class="bg-white rounded-lg border border-gray-200 p-4">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 bg-purple-100 rounded-lg flex items-center justify-center">
                        <span class="iconify text-purple-600" data-icon="mdi:ip-network-outline" data-width="24"></span>
                    </div>
                    <div class="flex-1">
                        <p class="text-sm text-gray-600">虚拟机IPv6地址</p>
                        <p id="vmIPv6" class="text-sm font-mono font-medium text-gray-800 break-all mt-0.5">-</p>
                    </div>
                </div>
            </div>
            <div class="bg-white rounded-lg border border-gray-200 p-4">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 bg-green-100 rounded-lg flex items-center justify-center">
                        <span class="iconify text-green-600" data-icon="mdi:earth" data-width="24"></span>
                    </div>
                    <div class="flex-1">
                        <p class="text-sm text-gray-600">外网访问IP</p>
                        <div id="vmPublicAddr" class="text-sm font-mono font-medium text-gray-800 mt-0.5">-</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 虚拟机操作 -->
        <div class="bg-white rounded-lg border border-gray-200 p-4 mb-4">
            <h2 class="text-base font-semibold text-gray-800 mb-3 flex items-center gap-2">
                <span class="iconify text-gray-500" data-icon="mdi:cog" data-width="20"></span>
                虚拟机操作
            </h2>
            <div id="vmOperationBtns" class="flex flex-wrap gap-2">
                <button id="btn_start" onclick="vmPower('start')"
                        class="vm-power-btn px-3 py-2 text-sm font-medium text-green-700 bg-green-50 hover:bg-green-100 border border-green-200 rounded-lg transition flex items-center gap-1">
                    <span class="iconify" data-icon="mdi:play" data-width="18"></span>
                    启动
                </button>
                <button id="btn_stop" onclick="vmPower('stop')"
                        class="vm-power-btn px-3 py-2 text-sm font-medium text-yellow-700 bg-yellow-50 hover:bg-yellow-100 border border-yellow-200 rounded-lg transition flex items-center gap-1">
                    <span class="iconify" data-icon="mdi:stop" data-width="18"></span>
                    关机
                </button>
                <button id="btn_reset" onclick="vmPower('reset')"
                        class="vm-power-btn px-3 py-2 text-sm font-medium text-blue-700 bg-blue-50 hover:bg-blue-100 border border-blue-200 rounded-lg transition flex items-center gap-1">
                    <span class="iconify" data-icon="mdi:restart" data-width="18"></span>
                    重启
                </button>

                <button id="btn_pause" onclick="vmPower('pause')"
                        class="vm-power-btn px-3 py-2 text-sm font-medium text-yellow-700 bg-yellow-50 hover:bg-yellow-100 border border-yellow-200 rounded-lg transition flex items-center gap-1">
                    <span class="iconify" data-icon="mdi:pause" data-width="18"></span>
                    暂停
                </button>
                <button id="btn_resume" onclick="vmPower('resume')"
                        class="vm-power-btn px-3 py-2 text-sm font-medium text-indigo-700 bg-indigo-50 hover:bg-indigo-100 border border-indigo-200 rounded-lg transition flex items-center gap-1">
                    <span class="iconify" data-icon="mdi:play-pause" data-width="18"></span>
                    恢复
                </button>
                <button onclick="openEditVM()"
                        class="px-3 py-2 text-sm font-medium text-purple-700 bg-purple-50 hover:bg-purple-100 border border-purple-200 rounded-lg transition flex items-center gap-1">
                    <span class="iconify" data-icon="mdi:pencil" data-width="18"></span>
                    编辑配置
                </button>

                <button id="btn_hard_stop" onclick="vmPower('hard_stop')"
                        class="vm-power-btn px-3 py-2 text-sm font-medium text-orange-700 bg-orange-50 hover:bg-orange-100 border border-orange-200 rounded-lg transition flex items-center gap-1">
                    <span class="iconify" data-icon="mdi:power-off" data-width="18"></span>
                    强制关机
                </button>
                <button id="btn_hard_reset" onclick="vmPower('hard_reset')"
                        class="vm-power-btn px-3 py-2 text-sm font-medium text-orange-700 bg-orange-50 hover:bg-orange-100 border border-orange-200 rounded-lg transition flex items-center gap-1">
                    <span class="iconify" data-icon="mdi:restart-alert" data-width="18"></span>
                    强制重启
                </button>
                <button onclick="showReinstallModal()"
                        class="vm-power-btn px-3 py-2 text-sm font-medium text-red-700 bg-red-50 hover:bg-red-100 border border-red-200 rounded-lg transition flex items-center gap-1">
                    <span class="iconify" data-icon="mdi:restart-alert" data-width="18"></span>
                    重装系统
                </button>
                <button id="btn_delete" onclick="confirmDeleteVM()"
                        class="vm-power-btn px-3 py-2 text-sm font-medium text-red-700 bg-red-50 hover:bg-red-100 border border-red-200 rounded-lg transition flex items-center gap-1">
                    <span class="iconify" data-icon="mdi:delete" data-width="18"></span>
                    删除虚拟机
                </button>
                <button id="btn_vnc" onclick="openVNCConsole()"
                        class="vm-power-btn px-3 py-2 text-sm font-medium text-cyan-700 bg-cyan-50 hover:bg-cyan-100 border border-cyan-200 rounded-lg transition flex items-center gap-1">
                    <span class="iconify" data-icon="mdi:monitor" data-width="18"></span>
                    VNC 控制台
                </button>
            </div>
        </div>

        <!-- 资源配置信息 -->
        <div class="bg-white rounded-lg border border-gray-200 p-4 mb-4">
            <h2 class="text-base font-semibold text-gray-800 mb-3 flex items-center gap-2">
                <span class="iconify text-gray-500" data-icon="mdi:chip" data-width="20"></span>
                资源配置
            </h2>
            <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
                <!-- CPU -->
                <div class="bg-gray-50 rounded-lg p-3 border border-gray-200">
                    <p class="text-xs text-gray-500">CPU核心</p>
                    <p id="vmCpu" class="text-lg font-medium text-gray-800 mt-1">-</p>
                    <div class="mt-2">
                        <div class="flex justify-between text-xs text-gray-500 mb-1">
                            <span>利用率</span>
                            <span id="vmCpuPerText">0%</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-1.5">
                            <div id="vmCpuPerBar" class="bg-blue-500 h-1.5 rounded-full transition-all"
                                 style="width: 0%"></div>
                        </div>
                    </div>
                </div>
                <!-- 内存 -->
                <div class="bg-gray-50 rounded-lg p-3 border border-gray-200">
                    <p class="text-xs text-gray-500">RAM内存</p>
                    <p id="vmMemory" class="text-lg font-medium text-gray-800 mt-1">-</p>
                    <div class="mt-2">
                        <div class="flex justify-between text-xs text-gray-500 mb-1">
                            <span id="vmMemUsageText">已用 0 MB</span>
                            <span id="vmMemPerText">0%</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-1.5">
                            <div id="vmMemPerBar" class="bg-green-500 h-1.5 rounded-full transition-all"
                                 style="width: 0%"></div>
                        </div>
                    </div>
                </div>
                <!-- 硬盘 -->
                <div class="bg-gray-50 rounded-lg p-3 border border-gray-200">
                    <p class="text-xs text-gray-500">HDD硬盘</p>
                    <p id="vmDisk" class="text-lg font-medium text-gray-800 mt-1">-</p>
                    <div class="mt-2">
                        <div class="flex justify-between text-xs text-gray-500 mb-1">
                            <span id="vmHddUsageText">已用 0 MB</span>
                            <span id="vmHddPerText">0%</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-1.5">
                            <div id="vmHddPerBar" class="bg-yellow-500 h-1.5 rounded-full transition-all"
                                 style="width: 0%"></div>
                        </div>
                    </div>
                </div>
                <!-- GPU显存 -->
                <div class="bg-gray-50 rounded-lg p-3 border border-gray-200">
                    <p class="text-xs text-gray-500">GPU显存</p>
                    <p id="vmGpu" class="text-lg font-medium text-gray-800 mt-1">-</p>
                    <div class="mt-2">
                        <div class="flex justify-between text-xs text-gray-500 mb-1">
                            <span id="vmGpuUsageText">已用 0 MB</span>
                            <span id="vmGpuPerText">0%</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-1.5">
                            <div id="vmGpuPerBar" class="bg-purple-500 h-1.5 rounded-full transition-all"
                                 style="width: 0%"></div>
                        </div>
                    </div>
                </div>
                <!-- 上行带宽 -->
                <div class="bg-gray-50 rounded-lg p-3 border border-gray-200">
                    <p class="text-xs text-gray-500">上行带宽</p>
                    <p id="vmSpeedU" class="text-lg font-medium text-gray-800 mt-1">-</p>
                    <div class="mt-2">
                        <div class="flex justify-between text-xs text-gray-500 mb-1">
                            <span id="vmNetUsageText">已用 0 Mbps</span>
                            <span id="vmNetPerText">0%</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-1.5">
                            <div id="vmNetPerBar" class="bg-cyan-500 h-1.5 rounded-full transition-all"
                                 style="width: 0%"></div>
                        </div>
                    </div>
                </div>
                <!-- 下行带宽 -->
                <div class="bg-gray-50 rounded-lg p-3 border border-gray-200">
                    <p class="text-xs text-gray-500">下行带宽</p>
                    <p id="vmSpeedD" class="text-lg font-medium text-gray-800 mt-1">-</p>
                    <div class="mt-2">
                        <div class="flex justify-between text-xs text-gray-500 mb-1">
                            <span id="vmNetDUsageText">已用 0 Mbps</span>
                            <span id="vmNetDPerText">0%</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-1.5">
                            <div id="vmNetDPerBar" class="bg-teal-500 h-1.5 rounded-full transition-all"
                                 style="width: 0%"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 网络配置信息 -->
        <div class="bg-white rounded-lg border border-gray-200 p-4 mb-4">
            <h2 class="text-base font-semibold text-gray-800 mb-3 flex items-center gap-2">
                <span class="iconify text-gray-500" data-icon="mdi:ethernet" data-width="20"></span>
                网络配置
            </h2>
            <div class="grid grid-cols-2 md:grid-cols-3 gap-4 mb-4">
                <!-- NAT端口数 -->
                <div class="bg-gray-50 rounded-lg p-3 border border-gray-200">
                    <p class="text-xs text-gray-500">NAT端口数</p>
                    <p id="vmNatNum" class="text-lg font-medium text-gray-800 mt-1">-</p>
                    <div class="mt-2">
                        <div class="flex justify-between text-xs text-gray-500 mb-1">
                            <span id="vmNatUsageText">已用 0 个</span>
                            <span id="vmNatPerText">0%</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-1.5">
                            <div id="vmNatPerBar" class="bg-orange-500 h-1.5 rounded-full transition-all"
                                 style="width: 0%"></div>
                        </div>
                    </div>
                </div>
                <!-- WEB代理 -->
                <div class="bg-gray-50 rounded-lg p-3 border border-gray-200">
                    <p class="text-xs text-gray-500">WEB代理</p>
                    <p id="vmWebNum" class="text-lg font-medium text-gray-800 mt-1">-</p>
                    <div class="mt-2">
                        <div class="flex justify-between text-xs text-gray-500 mb-1">
                            <span id="vmWebUsageText">已用 0 个</span>
                            <span id="vmWebPerText">0%</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-1.5">
                            <div id="vmWebPerBar" class="bg-pink-500 h-1.5 rounded-full transition-all"
                                 style="width: 0%"></div>
                        </div>
                    </div>
                </div>
                <!-- 流量限制 -->
                <div class="bg-gray-50 rounded-lg p-3 border border-gray-200">
                    <p class="text-xs text-gray-500">NET流量限制</p>
                    <p id="vmTraffic" class="text-lg font-medium text-gray-800 mt-1">-</p>
                    <div class="mt-2">
                        <div class="flex justify-between text-xs text-gray-500 mb-1">
                            <span id="vmFluUsageText">已用 0 MB</span>
                            <span id="vmFluPerText">0%</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-1.5">
                            <div id="vmFluPerBar" class="bg-red-500 h-1.5 rounded-full transition-all"
                                 style="width: 0%"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 网卡列表 -->
            <h3 class="text-sm font-medium text-gray-700 mb-2">网卡列表</h3>
            <div id="nicList" class="space-y-2">
                <p class="text-sm text-gray-500">加载中...</p>
            </div>
        </div>

        <!-- 数据监控 -->
        <div class="bg-white rounded-lg border border-gray-200 p-4 mb-4 w-full">
            <h2 class="text-base font-semibold text-gray-800 mb-3 flex items-center gap-2">
                <span class="iconify text-gray-500" data-icon="mdi:chart-line" data-width="20"></span>
                数据监控
            </h2>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 w-full">
                <!-- CPU使用率 -->
                <div class="bg-gray-50 rounded-lg p-4 border border-gray-200 w-full">
                    <div id="cpuChart" style="width: 100%; height: 300px;"></div>
                </div>
                <!-- 内存使用率 -->
                <div class="bg-gray-50 rounded-lg p-4 border border-gray-200 w-full">
                    <div id="memChart" style="width: 100%; height: 300px;"></div>
                </div>
                <!-- 硬盘使用率 -->
                <div class="bg-gray-50 rounded-lg p-4 border border-gray-200 w-full">
                    <div id="hddChart" style="width: 100%; height: 300px;"></div>
                </div>
                <!-- GPU使用率 -->
                <div class="bg-gray-50 rounded-lg p-4 border border-gray-200 w-full">
                    <div id="gpuChart" style="width: 100%; height: 300px;"></div>
                </div>
                <!-- 上行带宽 -->
                <div class="bg-gray-50 rounded-lg p-4 border border-gray-200 w-full">
                    <div id="netUChart" style="width: 100%; height: 300px;"></div>
                </div>
                <!-- 下行带宽 -->
                <div class="bg-gray-50 rounded-lg p-4 border border-gray-200 w-full">
                    <div id="netDChart" style="width: 100%; height: 300px;"></div>
                </div>
            </div>
        </div>

        <!-- 运行状态 -->
        <!--        <div class="bg-white rounded-lg border border-gray-200 p-4">-->
        <!--            <h2 class="text-base font-semibold text-gray-800 mb-3 flex items-center gap-2">-->
        <!--                <span class="iconify text-gray-500" data-icon="mdi:chart-line" data-width="20"></span>-->
        <!--                运行状态-->
        <!--            </h2>-->
        <!--            <div id="vmStatusInfo" class="grid grid-cols-2 md:grid-cols-4 gap-4">-->
        <!--                <p class="col-span-full text-sm text-gray-500">加载中...</p>-->
        <!--            </div>-->
        <!--        </div>-->
    </div>

    <!-- NAT端口转发Tab -->
    <div id="natTab" class="tab-pane" style="display: none;">
        <div class="bg-white rounded-lg border border-gray-200 p-4">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-base font-semibold text-gray-800 flex items-center gap-2">
                    <span class="iconify text-gray-500" data-icon="mdi:swap-horizontal" data-width="20"></span>
                    NAT端口转发规则
                </h2>
                <button onclick="showAddNATModal()"
                        class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition flex items-center gap-2">
                    <span class="iconify" data-icon="mdi:plus" data-width="18"></span>
                    添加规则
                </button>
            </div>
            <div id="natRulesList">
                <p class="text-center text-gray-500 py-8 text-sm">加载中...</p>
            </div>
        </div>
    </div>

    <!-- IP地址管理Tab -->
    <div id="ipTab" class="tab-pane" style="display: none;">
        <div class="bg-white rounded-lg border border-gray-200 p-4">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-base font-semibold text-gray-800 flex items-center gap-2">
                    <span class="iconify text-gray-500" data-icon="mdi:ip-network" data-width="20"></span>
                    IP地址管理
                </h2>
                <button onclick="showAddIPModal()"
                        class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition flex items-center gap-2">
                    <span class="iconify" data-icon="mdi:plus" data-width="18"></span>
                    添加IP地址
                </button>
            </div>
            <div id="ipAddressList">
                <p class="text-center text-gray-500 py-8 text-sm">加载中...</p>
            </div>
        </div>
    </div>

    <!-- 反向代理Tab -->
    <div id="proxyTab" class="tab-pane" style="display: none;">
        <div class="bg-white rounded-lg border border-gray-200 p-4">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-base font-semibold text-gray-800 flex items-center gap-2">
                    <span class="iconify text-gray-500" data-icon="mdi:web" data-width="20"></span>
                    反向代理配置
                </h2>
                <button onclick="showAddProxyModal()"
                        class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition flex items-center gap-2">
                    <span class="iconify" data-icon="mdi:plus" data-width="18"></span>
                    添加代理
                </button>
            </div>
            <div id="proxyList">
                <p class="text-center text-gray-500 py-8 text-sm">加载中...</p>
            </div>
        </div>
    </div>

    <!-- 数据盘Tab -->
    <div id="hddTab" class="tab-pane" style="display: none;">
        <div class="bg-white rounded-lg border border-gray-200 p-4">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-base font-semibold text-gray-800 flex items-center gap-2">
                    <span class="iconify text-gray-500" data-icon="mdi:harddisk" data-width="20"></span>
                    数据盘管理
                </h2>
                <button onclick="showAddHDDModal()"
                        class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition flex items-center gap-2">
                    <span class="iconify" data-icon="mdi:plus" data-width="18"></span>
                    挂载数据盘
                </button>
            </div>
            <div id="hddList">
                <p class="text-center text-gray-500 py-8 text-sm">加载中...</p>
            </div>
        </div>
    </div>

    <!-- ISO挂载Tab -->
    <div id="isoTab" class="tab-pane" style="display: none;">
        <div class="bg-white rounded-lg border border-gray-200 p-4">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-base font-semibold text-gray-800 flex items-center gap-2">
                    <span class="iconify text-gray-500" data-icon="mdi:disc" data-width="20"></span>
                    ISO镜像管理
                </h2>
                <button onclick="showAddISOModal()"
                        class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition flex items-center gap-2">
                    <span class="iconify" data-icon="mdi:plus" data-width="18"></span>
                    挂载ISO
                </button>
            </div>
            <div id="isoList">
                <p class="text-center text-gray-500 py-8 text-sm">加载中...</p>
            </div>
        </div>
    </div>

    <!-- 备份管理Tab -->
    <div id="backupTab" class="tab-pane" style="display: none;">
        <div class="bg-white rounded-lg border border-gray-200 p-4">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-base font-semibold text-gray-800 flex items-center gap-2">
                    <span class="iconify text-gray-500" data-icon="mdi:backup-restore" data-width="20"></span>
                    备份管理
                </h2>
                <button onclick="showCreateBackupModal()"
                        class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition flex items-center gap-2">
                    <span class="iconify" data-icon="mdi:plus" data-width="18"></span>
                    创建备份
                </button>
            </div>
            <div id="backupList">
                <p class="text-center text-gray-500 py-8 text-sm">加载中...</p>
            </div>
        </div>
    </div>

    <!-- 用户管理Tab -->
    <div id="ownersTab" class="tab-pane" style="display: none;">
        <div class="bg-white rounded-lg border border-gray-200 p-4">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-base font-semibold text-gray-800 flex items-center gap-2">
                    <span class="iconify text-gray-500" data-icon="mdi:account-multiple" data-width="20"></span>
                    虚拟机分享管理
                </h2>
                <button id="addOwnerBtn" onclick="showAddOwnerModal()"
                        class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition flex items-center gap-2">
                    <span class="iconify" data-icon="mdi:account-plus" data-width="18"></span>
                    添加使用者
                </button>
            </div>
            <div id="ownersList">
                <p class="text-center text-gray-500 py-8 text-sm">加载中...</p>
            </div>
        </div>
    </div>
</div>

<!-- 添加NAT规则模态框 -->
<dialog id="addNATModal" class="modal">
    <div class="modal-box max-w-lg">
        <h3 class="font-bold text-lg mb-4 flex items-center gap-2">
            <span class="iconify text-purple-600" data-icon="mdi:swap-horizontal" data-width="24"></span>
            添加NAT端口转发规则
        </h3>
        <form id="addNATForm" class="space-y-4">
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-600 mb-1">外网端口 (WAN)</label>
                    <input type="number" id="natExternalPort" min="1" max="65535"
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                           placeholder="留空自动分配">
                    <p class="text-xs text-gray-500 mt-1">留空将自动分配可用端口</p>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-600 mb-1">内网端口 (LAN) *</label>
                    <input type="number" id="natInternalPort" required min="1" max="65535"
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                           placeholder="1-65535">
                </div>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-600 mb-1">内网地址 *</label>
                <select id="natInternalIP" required
                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                    <option value="">请选择IP地址</option>
                </select>
                <p class="text-xs text-gray-500 mt-1">从虚拟机已分配的IP地址中选择</p>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-600 mb-1">备注</label>
                <input type="text" id="natDescription"
                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                       placeholder="端口用途说明">
            </div>
            <div class="modal-action">
                <button type="button" onclick="closeNATModal()"
                        class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50">
                    取消
                </button>
                <button type="submit"
                        class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg flex items-center gap-2">
                    <span class="iconify" data-icon="mdi:check" data-width="18"></span>
                    添加
                </button>
            </div>
        </form>
    </div>
    <form method="dialog" class="modal-backdrop">
        <button>关闭</button>
    </form>
</dialog>

<!-- 添加IP地址模态框 -->
<dialog id="addIPModal" class="modal">
    <div class="modal-box max-w-lg">
        <h3 class="font-bold text-lg mb-4 flex items-center gap-2">
            <span class="iconify text-purple-600" data-icon="mdi:ip-network" data-width="24"></span>
            添加网卡
        </h3>
        <form id="addIPForm" class="space-y-4">
            <div>
                <label class="block text-sm font-medium text-gray-600 mb-1">网卡类型 *</label>
                <select id="ipNicType" required
                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                        onchange="updateNicTypeHint()">
                    <option value="nat">内网(NAT)</option>
                    <option value="pub">公网(Public)</option>
                </select>
                <p id="nicTypeHint" class="text-xs text-gray-500 mt-1">选择网卡类型后可查看配额状态</p>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-600 mb-1">IPv4地址</label>
                <input type="text" id="ipAddress"
                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                       placeholder="留空自动分配，例如: 192.168.1.100">
                <p class="text-xs text-gray-500 mt-1">留空将由后端自动分配IP地址</p>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-600 mb-1">IPv6地址</label>
                <input type="text" id="ipAddress6"
                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                       placeholder="例如: 2001:db8::1">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-600 mb-1">网关</label>
                <input type="text" id="ipGateway"
                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                       placeholder="例如: 192.168.1.1">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-600 mb-1">子网掩码</label>
                <input type="text" id="ipNetmask" value="255.255.255.0"
                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                       placeholder="默认: 255.255.255.0">
            </div>
            <!-- IP配额信息 -->
            <div id="ipQuotaInfo" class="bg-gray-50 p-3 rounded-lg border border-gray-200">
                <h5 class="text-sm font-semibold text-gray-700 mb-2">IP配额信息</h5>
                <div id="quotaDetails" class="text-xs text-gray-600 space-y-1">
                    <!-- 配额信息将通过JavaScript动态加载 -->
                </div>
            </div>
            <div class="modal-action">
                <button type="button" onclick="closeIPModal()"
                        class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50">
                    取消
                </button>
                <button type="submit"
                        class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg flex items-center gap-2">
                    <span class="iconify" data-icon="mdi:check" data-width="18"></span>
                    添加
                </button>
            </div>
        </form>
    </div>
    <form method="dialog" class="modal-backdrop">
        <button>关闭</button>
    </form>
</dialog>

<!-- 编辑IP地址模态框 -->
<dialog id="editIPModal" class="modal">
    <div class="modal-box max-w-lg">
        <h3 class="font-bold text-lg mb-4 flex items-center gap-2">
            <span class="iconify text-purple-600" data-icon="mdi:pencil" data-width="24"></span>
            编辑网卡配置
        </h3>
        <form id="editIPForm" class="space-y-4">
            <input type="hidden" id="editNicName">
            <div>
                <label class="block text-sm font-medium text-gray-600 mb-1">网卡名称</label>
                <input type="text" id="editNicNameDisplay" disabled
                       class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-100 text-gray-600 cursor-not-allowed">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-600 mb-1">IPv4地址</label>
                <input type="text" id="editIpAddress"
                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                       placeholder="例如: 192.168.1.100">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-600 mb-1">IPv6地址</label>
                <input type="text" id="editIpAddress6"
                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                       placeholder="例如: 2001:db8::1">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-600 mb-1">网关</label>
                <input type="text" id="editIpGateway"
                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                       placeholder="例如: 192.168.1.1">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-600 mb-1">子网掩码</label>
                <input type="text" id="editIpNetmask"
                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                       placeholder="默认: 255.255.255.0">
            </div>
            <div class="modal-action">
                <button type="button" onclick="closeEditIPModal()"
                        class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50">
                    取消
                </button>
                <button type="submit"
                        class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg flex items-center gap-2">
                    <span class="iconify" data-icon="mdi:check" data-width="18"></span>
                    保存
                </button>
            </div>
        </form>
    </div>
    <form method="dialog" class="modal-backdrop">
        <button>关闭</button>
    </form>
</dialog>

<!-- 添加代理模态框 -->
<dialog id="addProxyModal" class="modal">
    <div class="modal-box max-w-lg">
        <h3 class="font-bold text-lg mb-4 flex items-center gap-2">
            <span class="iconify text-purple-600" data-icon="mdi:web" data-width="24"></span>
            添加反向代理
        </h3>
        <form id="addProxyForm" class="space-y-4">
            <div>
                <label class="block text-sm font-medium text-gray-600 mb-1">域名 *</label>
                <input type="text" id="proxyDomain" required
                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                       placeholder="example.com">
            </div>
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-600 mb-1">后端IP *</label>
                    <select id="proxyBackendIP" required
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                        <option value="">请选择网卡地址</option>
                    </select>
                    <p class="text-xs text-gray-500 mt-1">从虚拟机网卡地址中选择</p>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-600 mb-1">后端端口 *</label>
                    <input type="number" id="proxyBackendPort" required min="1" max="65535" value="80"
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                </div>
            </div>

            <hr class="my-4">

            <div class="flex items-center gap-3">
                <input type="checkbox" id="proxySSLEnabled" class="checkbox checkbox-primary">
                <label for="proxySSLEnabled" class="text-sm font-medium text-gray-700">启用 HTTPS (SSL/TLS)</label>
            </div>

            <!--            <div id="sslOptions" style="display: none;" class="space-y-4 p-4 bg-gray-50 rounded-lg">-->
            <!--                <div>-->
            <!--                    <label class="block text-sm font-medium text-gray-600 mb-1">SSL证书类型</label>-->
            <!--                    <select id="proxySSLType"-->
            <!--                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">-->
            <!--                        <option value="auto">自动申请证书 (Let's Encrypt)</option>-->
            <!--                        <option value="self-signed">自签名证书</option>-->
            <!--                        <option value="custom">自定义证书</option>-->
            <!--                    </select>-->
            <!--                </div>-->
            <!--                <div id="customCertFields" style="display: none;" class="space-y-4">-->
            <!--                    <div>-->
            <!--                        <label class="block text-sm font-medium text-gray-600 mb-1">SSL证书内容</label>-->
            <!--                        <textarea id="proxySSLCert" rows="3"-->
            <!--                                  class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent font-mono text-sm"-->
            <!--                                  placeholder="-&#45;&#45;&#45;&#45;BEGIN CERTIFICATE-&#45;&#45;&#45;&#45;"></textarea>-->
            <!--                    </div>-->
            <!--                    <div>-->
            <!--                        <label class="block text-sm font-medium text-gray-600 mb-1">SSL私钥内容</label>-->
            <!--                        <textarea id="proxySSLKey" rows="3"-->
            <!--                                  class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent font-mono text-sm"-->
            <!--                                  placeholder="-&#45;&#45;&#45;&#45;BEGIN PRIVATE KEY-&#45;&#45;&#45;&#45;"></textarea>-->
            <!--                    </div>-->
            <!--                </div>-->
            <!--            </div>-->

            <div>
                <label class="block text-sm font-medium text-gray-600 mb-1">描述</label>
                <input type="text" id="proxyDescription"
                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                       placeholder="代理用途说明">
            </div>

            <div class="modal-action">
                <button type="button" onclick="closeProxyModal()"
                        class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50">
                    取消
                </button>
                <button type="submit"
                        class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg flex items-center gap-2">
                    <span class="iconify" data-icon="mdi:check" data-width="18"></span>
                    添加
                </button>
            </div>
        </form>
    </div>
    <form method="dialog" class="modal-backdrop">
        <button>关闭</button>
    </form>
</dialog>

<!-- 添加数据盘模态框 -->
<dialog id="addHDDModal" class="modal">
    <div class="modal-box max-w-lg">
        <h3 class="font-bold text-lg mb-4 flex items-center gap-2">
            <span class="iconify text-purple-600" data-icon="mdi:harddisk" data-width="24"></span>
            挂载数据盘
        </h3>
        <form id="addHDDForm" class="space-y-4">
            <div>
                <label class="block text-sm font-medium text-gray-600 mb-1">磁盘名称 *</label>
                <input type="text" id="hddName" required
                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                       placeholder="例如: data_disk_01"
                       oninput="validateHDDName(this)">
                <p id="hddNameError" class="text-xs text-red-600 mt-1" style="display: none;"></p>
                <p class="text-xs text-gray-500 mt-1">只能包含数字和字母，不能包含特殊符号和中文</p>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-600 mb-1">磁盘大小 (MB) *</label>
                <input type="number" id="hddSize" required min="1024"
                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                       placeholder="例如: 10240">
                <p class="text-xs text-gray-500 mt-1">最小1024MB (1GB)</p>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-600 mb-1">磁盘类型</label>
                <select id="hddType"
                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                    <option value="0">普通磁盘</option>
                </select>
            </div>
            <div class="modal-action">
                <button type="button" onclick="closeHDDModal()"
                        class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50">
                    取消
                </button>
                <button type="submit"
                        class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg flex items-center gap-2">
                    <span class="iconify" data-icon="mdi:check" data-width="18"></span>
                    挂载
                </button>
            </div>
        </form>
    </div>
    <form method="dialog" class="modal-backdrop">
        <button>关闭</button>
    </form>
</dialog>

<!-- 移交数据盘所有权模态框 -->
<!-- 移交数据盘确认模态框 -->
<dialog id="transferHDDConfirmModal" class="modal">
    <div class="modal-box max-w-md">
        <h3 class="font-bold text-lg flex items-center gap-2 text-blue-600">
            <span class="iconify" data-icon="mdi:swap-horizontal" data-width="24"></span>
            移交数据盘
        </h3>
        <p class="py-4">确定要移交数据盘 "<span id="transferHddName" class="font-medium"></span>" 吗？</p>

        <!-- 目标虚拟机输入 -->
        <div class="mb-4">
            <label class="block text-sm font-medium text-gray-600 mb-1">目标虚拟机UUID *</label>
            <input type="text" id="transferTargetVM" required
                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                   placeholder="输入目标虚拟机UUID">
            <p class="text-xs text-gray-500 mt-1">数据盘将从当前虚拟机移交到目标虚拟机</p>
        </div>

        <!-- 重要提示 -->
        <div class="mb-4 bg-blue-50 border border-blue-200 rounded-lg p-3">
            <p class="text-sm text-blue-700 flex items-start gap-2">
                <span class="iconify mt-0.5" data-icon="mdi:information" data-width="16"></span>
                <span>目标机器不会自动挂载接收的硬盘</span>
            </p>
        </div>

        <!-- 确认勾选 -->
        <div class="space-y-3 mb-6">
            <label class="flex items-start gap-2 cursor-pointer bg-yellow-50 border border-yellow-200 rounded-lg p-3">
                <input type="checkbox" id="transferConfirmCheck"
                       class="mt-1 w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500"
                       onchange="toggleTransferConfirmButton()">
                <span class="text-sm text-gray-700">
                    我同意关闭当前虚拟机执行操作
                </span>
            </label>
        </div>

        <div class="modal-action">
            <button onclick="closeTransferHDDConfirmModal()"
                    class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50">
                取消
            </button>
            <button onclick="executeTransferHDD()"
                    id="executeTransferBtn"
                    class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg disabled:opacity-50 disabled:cursor-not-allowed"
                    disabled>
                确认移交
            </button>
        </div>
    </div>
    <form method="dialog" class="modal-backdrop">
        <button>关闭</button>
    </form>
</dialog>

<!-- 挂载数据盘确认模态框 -->
<dialog id="mountHDDConfirmModal" class="modal">
    <div class="modal-box max-w-md">
        <h3 class="font-bold text-lg flex items-center gap-2 text-purple-600">
            <span class="iconify" data-icon="mdi:harddisk-plus" data-width="24"></span>
            挂载数据盘
        </h3>
        <p class="py-4">确定要挂载数据盘到虚拟机 "<span id="mountVmName" class="font-medium">{{ vm_uuid }}</span>" 吗？
        </p>

        <!-- 磁盘信息显示 -->
        <div class="mb-4 bg-purple-50 border border-purple-200 rounded-lg p-3">
            <p class="text-sm text-gray-700 mb-1">磁盘名称：</p>
            <code id="mountHddName" class="text-sm font-mono text-purple-700"></code>
        </div>

        <!-- 确认勾选 -->
        <div class="space-y-3 mb-6">
            <label class="flex items-start gap-2 cursor-pointer bg-yellow-50 border border-yellow-200 rounded-lg p-3">
                <input type="checkbox" id="mountConfirmCheck"
                       class="mt-1 w-4 h-4 text-purple-600 border-gray-300 rounded focus:ring-purple-500"
                       onchange="toggleMountConfirmButton()">
                <span class="text-sm text-gray-700">
                    我同意关闭当前虚拟机执行操作
                </span>
            </label>
        </div>

        <div class="modal-action">
            <button onclick="closeMountHDDConfirmModal()"
                    class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50">
                取消
            </button>
            <button onclick="executeMountHDD()"
                    id="executeMountBtn"
                    class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg disabled:opacity-50 disabled:cursor-not-allowed"
                    disabled>
                确认挂载
            </button>
        </div>
    </div>
    <form method="dialog" class="modal-backdrop">
        <button>关闭</button>
    </form>
</dialog>

<!-- 卸载数据盘确认模态框 -->
<dialog id="unmountHDDConfirmModal" class="modal">
    <div class="modal-box max-w-md">
        <h3 class="font-bold text-lg flex items-center gap-2 text-orange-600">
            <span class="iconify" data-icon="mdi:eject" data-width="24"></span>
            卸载数据盘
        </h3>
        <p class="py-4">确定要卸载数据盘 "<span id="unmountHddName" class="font-medium"></span>" 吗？</p>

        <!-- 确认勾选 -->
        <div class="space-y-3 mb-6">
            <label class="flex items-start gap-2 cursor-pointer bg-yellow-50 border border-yellow-200 rounded-lg p-3">
                <input type="checkbox" id="unmountConfirmCheck"
                       class="mt-1 w-4 h-4 text-orange-600 border-gray-300 rounded focus:ring-orange-500"
                       onchange="toggleUnmountConfirmButton()">
                <span class="text-sm text-gray-700">
                    我同意关闭当前虚拟机执行操作
                </span>
            </label>
        </div>

        <div class="modal-action">
            <button onclick="closeUnmountHDDConfirmModal()"
                    class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50">
                取消
            </button>
            <button onclick="executeUnmountHDD()"
                    id="executeUnmountBtn"
                    class="bg-orange-600 hover:bg-orange-700 text-white px-4 py-2 rounded-lg disabled:opacity-50 disabled:cursor-not-allowed"
                    disabled>
                确认卸载
            </button>
        </div>
    </div>
    <form method="dialog" class="modal-backdrop">
        <button>关闭</button>
    </form>
</dialog>

<!-- 删除数据盘确认模态框 -->
<dialog id="deleteHDDConfirmModal" class="modal">
    <div class="modal-box max-w-md">
        <h3 class="font-bold text-lg flex items-center gap-2 text-red-600">
            <span class="iconify" data-icon="mdi:delete" data-width="24"></span>
            删除数据盘
        </h3>
        <p class="py-4">确定要删除数据盘 "<span id="deleteHddName" class="font-medium"></span>" 吗？</p>

        <!-- 警告信息 -->
        <div class="mb-4 bg-red-50 border border-red-200 rounded-lg p-3">
            <p class="text-sm text-red-700">⚠️ 此操作不可恢复，磁盘数据将被永久删除！</p>
        </div>

        <!-- 确认勾选 -->
        <div class="space-y-3 mb-6">
            <label class="flex items-start gap-2 cursor-pointer bg-yellow-50 border border-yellow-200 rounded-lg p-3">
                <input type="checkbox" id="deleteConfirmCheck"
                       class="mt-1 w-4 h-4 text-red-600 border-gray-300 rounded focus:ring-red-500"
                       onchange="toggleDeleteConfirmButton()">
                <span class="text-sm text-gray-700">
                    我同意关闭当前虚拟机执行操作
                </span>
            </label>
        </div>

        <div class="modal-action">
            <button onclick="closeDeleteHDDConfirmModal()"
                    class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50">
                取消
            </button>
            <button onclick="executeDeleteHDD()"
                    id="executeDeleteBtn"
                    class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg disabled:opacity-50 disabled:cursor-not-allowed"
                    disabled>
                确认删除
            </button>
        </div>
    </div>
    <form method="dialog" class="modal-backdrop">
        <button>关闭</button>
    </form>
</dialog>

<!-- 添加ISO模态框 -->
<dialog id="addISOModal" class="modal">
    <div class="modal-box max-w-lg">
        <h3 class="font-bold text-lg mb-4 flex items-center gap-2">
            <span class="iconify text-purple-600" data-icon="mdi:disc" data-width="24"></span>
            挂载ISO镜像
        </h3>
        <form id="addISOForm" class="space-y-4">
            <div>
                <label class="block text-sm font-medium text-gray-600 mb-1">选择ISO镜像 *</label>
                <select id="isoFileSelect" required
                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                    <option value="">请选择ISO镜像文件</option>
                </select>
                <p class="text-xs text-gray-500 mt-1">从服务器可用的ISO镜像中选择</p>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-600 mb-1">挂载名称 *</label>
                <input type="text" id="isoName" required
                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                       placeholder="例如: system_iso (仅支持英文和数字)">
                <p class="text-xs text-gray-500 mt-1">挂载名称只能包含英文字母和数字</p>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-600 mb-1">备注</label>
                <input type="text" id="isoHint"
                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                       placeholder="例如: 系统安装盘">
                <p class="text-xs text-gray-500 mt-1">可选，用于说明此ISO的用途</p>
            </div>

            <!-- 确认勾选 -->
            <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-3">
                <label class="flex items-start gap-2 cursor-pointer">
                    <input type="checkbox" id="isoMountConfirmCheck"
                           class="mt-1 w-4 h-4 text-purple-600 border-gray-300 rounded focus:ring-purple-500"
                           onchange="toggleIsoMountConfirmButton()">
                    <span class="text-sm text-gray-700">
                        我已同意强制关机此虚拟机
                    </span>
                </label>
            </div>

            <div class="modal-action">
                <button type="button" onclick="closeISOModal()"
                        class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50">
                    取消
                </button>
                <button type="submit" id="confirmIsoMountBtn"
                        class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg flex items-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed"
                        disabled>
                    <span class="iconify" data-icon="mdi:check" data-width="18"></span>
                    挂载
                </button>
            </div>
        </form>
    </div>
    <form method="dialog" class="modal-backdrop">
        <button>关闭</button>
    </form>
</dialog>

<!-- 卸载ISO确认模态框 -->
<dialog id="unmountISOConfirmModal" class="modal">
    <div class="modal-box max-w-md">
        <h3 class="font-bold text-lg flex items-center gap-2 text-orange-600">
            <span class="iconify" data-icon="mdi:eject" data-width="24"></span>
            卸载ISO镜像
        </h3>
        <p class="py-4">确定要卸载ISO镜像 "<span id="unmountIsoName" class="font-medium"></span>" 吗？</p>

        <!-- 确认勾选 -->
        <div class="space-y-3 mb-6">
            <label class="flex items-start gap-2 cursor-pointer bg-yellow-50 border border-yellow-200 rounded-lg p-3">
                <input type="checkbox" id="unmountIsoConfirmCheck"
                       class="mt-1 w-4 h-4 text-orange-600 border-gray-300 rounded focus:ring-orange-500"
                       onchange="toggleUnmountIsoConfirmButton()">
                <span class="text-sm text-gray-700">
                    我已同意强制关机此虚拟机
                </span>
            </label>
        </div>

        <div class="modal-action">
            <button onclick="closeUnmountISOConfirmModal()"
                    class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50">
                取消
            </button>
            <button onclick="executeUnmountISO()"
                    id="executeUnmountIsoBtn"
                    class="bg-orange-600 hover:bg-orange-700 text-white px-4 py-2 rounded-lg disabled:opacity-50 disabled:cursor-not-allowed"
                    disabled>
                确认卸载
            </button>
        </div>
    </div>
    <form method="dialog" class="modal-backdrop">
        <button>关闭</button>
    </form>
</dialog>

<!-- 创建备份模态框 -->
<dialog id="createBackupModal" class="modal">
    <div class="modal-box max-w-lg">
        <h3 class="font-bold text-lg mb-4 flex items-center gap-2">
            <span class="iconify text-purple-600" data-icon="mdi:backup-restore" data-width="24"></span>
            创建备份
        </h3>
        <form id="createBackupForm" class="space-y-4">
            <div>
                <label class="block text-sm font-medium text-gray-600 mb-1">备份说明 *</label>
                <input type="text" id="backupTips" required
                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                       placeholder="例如: 系统更新前备份">
                <p class="text-xs text-gray-500 mt-1">请输入备份的说明信息</p>
            </div>

            <!-- 确认勾选 -->
            <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-3">
                <label class="flex items-start gap-2 cursor-pointer">
                    <input type="checkbox" id="backupConfirmCheck"
                           class="mt-1 w-4 h-4 text-purple-600 border-gray-300 rounded focus:ring-purple-500"
                           onchange="toggleBackupConfirmButton()">
                    <span class="text-sm text-gray-700">
                        我已确认停止当前虚拟机进行操作
                    </span>
                </label>
            </div>

            <div class="modal-action">
                <button type="button" onclick="closeCreateBackupModal()"
                        class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50">
                    取消
                </button>
                <button type="submit" id="confirmBackupBtn"
                        class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg flex items-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed"
                        disabled>
                    <span class="iconify" data-icon="mdi:check" data-width="18"></span>
                    创建
                </button>
            </div>
        </form>
    </div>
    <form method="dialog" class="modal-backdrop">
        <button>关闭</button>
    </form>
</dialog>

<!-- 添加所有者模态框 -->
<dialog id="addOwnerModal" class="modal">
    <div class="modal-box max-w-lg">
        <h3 class="font-bold text-lg mb-4 flex items-center gap-2">
            <span class="iconify text-blue-600" data-icon="mdi:account-plus" data-width="24"></span>
            添加分享人
        </h3>
        <form id="addOwnerForm" class="space-y-4">
            <div>
                <label class="block text-sm font-medium text-gray-600 mb-1">用户名 *</label>
                <input type="text" id="ownerUsername" required
                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                       placeholder="请输入用户名">
                <p class="text-xs text-gray-500 mt-1">添加后该用户将共享此虚拟机的资源配额</p>
            </div>

            <div class="modal-action">
                <button type="button" onclick="closeAddOwnerModal()"
                        class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50">
                    取消
                </button>
                <button type="submit"
                        class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg flex items-center gap-2">
                    <span class="iconify" data-icon="mdi:check" data-width="18"></span>
                    添加
                </button>
            </div>
        </form>
    </div>
    <form method="dialog" class="modal-backdrop">
        <button>关闭</button>
    </form>
</dialog>

<!-- 移交所有者模态框 -->
<dialog id="transferOwnershipModal" class="modal">
    <div class="modal-box max-w-lg">
        <h3 class="font-bold text-lg mb-4 flex items-center gap-2">
            <span class="iconify text-orange-600" data-icon="mdi:swap-horizontal" data-width="24"></span>
            移交虚拟机所有权
        </h3>
        <form id="transferOwnershipForm" class="space-y-4">
            <div>
                <label class="block text-sm font-medium text-gray-600 mb-1">新所有者用户名 *</label>
                <input type="text" id="newOwnerUsername" required
                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent"
                       placeholder="请输入新所有者的用户名">
                <p class="text-xs text-gray-500 mt-1">移交后该用户将成为虚拟机的所有者，占用资源配额，您将不再占用此虚拟机资源配额</p>
            </div>

            <div class="space-y-2">
                <label class="flex items-center gap-2 cursor-pointer">
                    <input type="checkbox" id="keepAccessCheckbox"
                           class="w-4 h-4 text-orange-600 border-gray-300 rounded focus:ring-orange-500">
                    <span class="text-sm text-gray-700">继续保留这个虚拟机的访问权限</span>
                </label>
                <div class="ml-6 space-y-2">
                    <div class="flex items-start space-x-2">
                        <svg class="w-4 h-4 text-blue-500 mt-0.5 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd"
                                  d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z"
                                  clip-rule="evenodd"/>
                        </svg>
                        <p class="text-sm text-blue-600">勾选将继续保留此虚拟机的访问权限，但不再是所有者</p>
                    </div>
                </div>
            </div>

            <div class="space-y-2">
                <label class="flex items-center gap-2 cursor-pointer">
                    <input type="checkbox" id="confirmTransferCheckbox" required
                           class="w-4 h-4 text-red-600 border-gray-300 rounded focus:ring-red-500">
                    <span class="text-sm text-gray-700">我确认移交此虚拟机所有者权限</span>
                </label>
                <div class="ml-6 space-y-2">
                    <div class="flex items-start space-x-2">
                        <svg class="w-4 h-4 text-red-500 mt-0.5 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd"
                                  d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z"
                                  clip-rule="evenodd"/>
                        </svg>
                        <p class="text-sm text-red-600 font-medium">此操作将立即执行且<strong>不可撤销</strong>，请谨慎确认所有者转移
                        </p>
                    </div>
                    <div class="flex items-start space-x-2">
                        <svg class="w-4 h-4 text-red-500 mt-0.5 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd"
                                  d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z"
                                  clip-rule="evenodd"/>
                        </svg>
                        <p class="text-sm text-orange-600">新的所有者必须拥有足够的<strong>可用资源配额</strong>才能完成移交
                        </p>
                    </div>
                    <div class="flex items-start space-x-2">
                        <svg class="w-4 h-4 text-red-500 mt-0.5 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd"
                                  d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z"
                                  clip-rule="evenodd"/>
                        </svg>
                        <p class="text-sm text-orange-600">新的所有者必须拥有对应主机的<strong>访问权限</strong>才能完成移交
                        </p>
                    </div>
                </div>
            </div>

            <div class="modal-action">
                <button type="button" onclick="closeTransferOwnershipModal()"
                        class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50">
                    取消
                </button>
                <button type="submit" id="transferOwnershipBtn"
                        class="bg-orange-600 hover:bg-orange-700 text-white px-4 py-2 rounded-lg flex items-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed">
                    <span class="iconify" data-icon="mdi:swap-horizontal" data-width="18"></span>
                    移交所有权
                </button>
            </div>
        </form>
    </div>
    <form method="dialog" class="modal-backdrop">
        <button>关闭</button>
    </form>
</dialog>

<!-- 删除确认模态框 -->
<dialog id="deleteModal" class="modal">
    <div class="modal-box">
        <h3 class="font-bold text-lg flex items-center gap-2 text-red-600">
            <span class="iconify" data-icon="mdi:alert-circle" data-width="24"></span>
            确认删除
        </h3>
        <p class="py-4">确定要删除虚拟机 "<span id="deleteVmName" class="font-medium">{{ vm_uuid }}</span>" 吗？此操作不可恢复。
        </p>
        <div class="mb-4">
            <label class="block text-sm font-medium text-gray-600 mb-2">请输入虚拟机名称确认删除：</label>
            <input type="text" id="deleteConfirmInput"
                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent"
                   placeholder="{{ vm_uuid }}">
            <p class="text-xs text-gray-500 mt-1">请输入 <code class="text-red-600">{{ vm_uuid }}</code> 以确认删除</p>
        </div>
        <div class="modal-action">
            <button onclick="document.getElementById('deleteModal').close(); document.getElementById('deleteConfirmInput').value='';"
                    class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50">
                取消
            </button>
            <button onclick="executeDeleteVM()"
                    class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg">
                确认删除
            </button>
        </div>
    </div>
    <form method="dialog" class="modal-backdrop">
        <button>关闭</button>
    </form>
</dialog>

<!-- 还原备份确认模态框 -->
<dialog id="restoreBackupModal" class="modal">
    <div class="modal-box max-w-md">
        <h3 class="font-bold text-lg flex items-center gap-2 text-blue-600">
            <span class="iconify" data-icon="mdi:restore" data-width="24"></span>
            还原备份
        </h3>
        <p class="py-4">为虚拟机 "<span id="restoreVmName" class="font-medium">{{ vm_uuid }}</span>" 还原备份
        </p>

        <!-- 备份信息显示 -->
        <div class="mb-4 bg-blue-50 border border-blue-200 rounded-lg p-3">
            <p class="text-sm text-gray-700 mb-1">备份名称：</p>
            <code id="restoreBackupName" class="text-sm font-mono text-blue-700"></code>
        </div>

        <!-- 确认勾选 -->
        <div class="space-y-3 mb-6">
            <label class="flex items-start gap-2 cursor-pointer bg-yellow-50 border border-yellow-200 rounded-lg p-3">
                <input type="checkbox" id="restoreConfirmCheck1"
                       class="mt-1 w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500"
                       onchange="toggleRestoreConfirmButton()">
                <span class="text-sm text-gray-700">
                    我已确认停止当前虚拟机进行操作
                </span>
            </label>

            <label class="flex items-start gap-2 cursor-pointer bg-red-50 border border-red-200 rounded-lg p-3">
                <input type="checkbox" id="restoreConfirmCheck2"
                       class="mt-1 w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500"
                       onchange="toggleRestoreConfirmButton()">
                <span class="text-sm text-gray-700">
                    我已确认备份数据，将丢失系统盘数据
                </span>
            </label>
        </div>

        <div class="modal-action">
            <button onclick="closeRestoreBackupModal()"
                    class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50">
                取消
            </button>
            <button onclick="executeRestore()"
                    id="executeRestoreBtn"
                    class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg disabled:opacity-50 disabled:cursor-not-allowed"
                    disabled>
                确认还原
            </button>
        </div>
    </div>
    <form method="dialog" class="modal-backdrop">
        <button>关闭</button>
    </form>
</dialog>

<!-- 重装系统确认模态框 -->
<dialog id="reinstallModal" class="modal">
    <div class="modal-box max-w-md">
        <h3 class="font-bold text-lg flex items-center gap-2 text-amber-600">
            <span class="iconify" data-icon="mdi:restart-alert" data-width="24"></span>
            重装系统
        </h3>
        <p class="py-4">为虚拟机 "<span id="reinstallVmName" class="font-medium">{{ vm_uuid }}</span>" 重装系统
        </p>

        <!-- 系统选择 -->
        <div class="mb-4">
            <label class="block text-sm font-medium text-gray-600 mb-2">选择操作系统：</label>
            <select id="reinstallOsSelect"
                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-transparent">
                <option value="">请选择操作系统</option>
                <!-- 操作系统选项将从主机的system_maps动态加载 -->
            </select>
        </div>

        <!-- 确认勾选 -->
        <div class="mb-6">
            <label class="flex items-start gap-2 cursor-pointer">
                <input type="checkbox" id="reinstallConfirmCheck"
                       class="mt-1 w-4 h-4 text-amber-600 border-gray-300 rounded focus:ring-amber-500">
                <span class="text-sm text-gray-700">
                    我已备份数据，确认重装系统将清空系统盘数据
                </span>
            </label>
        </div>

        <div class="modal-action">
            <button onclick="closeReinstallModal()"
                    class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50">
                取消
            </button>
            <button onclick="executeReinstall()"
                    id="executeReinstallBtn"
                    class="bg-amber-600 hover:bg-amber-700 text-white px-4 py-2 rounded-lg disabled:opacity-50 disabled:cursor-not-allowed"
                    disabled>
                确认重装
            </button>
        </div>
    </div>
    <form method="dialog" class="modal-backdrop">
        <button>关闭</button>
    </form>
</dialog>

<!-- 修改密码模态框 -->
<dialog id="changePasswordModal" class="modal">
    <div class="modal-box max-w-md">
        <h3 class="font-bold text-lg flex items-center gap-2 text-blue-600">
            <span class="iconify" data-icon="mdi:key" data-width="24"></span>
            修改虚拟机密码
        </h3>
        <form id="changePasswordForm" class="mt-4 space-y-4">
            <div>
                <label class="block text-sm font-medium text-gray-600 mb-1">新密码 *</label>
                <div class="flex gap-2">
                    <input type="text" id="newPassword" required
                           class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                           placeholder="至少8位，包含字母、数字、特殊符号中的两种"
                           oninput="onPasswordInput()">
                    <button type="button" onclick="generateNewPassword()"
                            class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors flex items-center gap-1 whitespace-nowrap">
                        <span class="iconify" data-icon="mdi:refresh" data-width="18"></span>
                        随机
                    </button>
                </div>
                <p id="newPasswordError" class="text-xs text-red-600 mt-1" style="display: none;"></p>
                <p class="text-xs text-gray-500 mt-1">密码长度不得低于8位，且至少包含字母、数字、特殊符号中的两种</p>
            </div>

            <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-3">
                <label class="flex items-start gap-2 cursor-pointer">
                    <input type="checkbox" id="confirmForceShutdownPassword"
                           class="mt-1 w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500"
                           onchange="togglePasswordConfirmButton()">
                    <span class="text-sm text-gray-700">
                        我已确认强制关闭虚拟机以修改密码
                    </span>
                </label>
            </div>

            <div class="modal-action">
                <button type="button" onclick="closeChangePasswordModal()"
                        class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50">
                    取消
                </button>
                <button type="submit" id="confirmPasswordChange"
                        class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg flex items-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed"
                        disabled>
                    <span class="iconify" data-icon="mdi:check" data-width="18"></span>
                    确认修改
                </button>
            </div>
        </form>
    </div>
    <form method="dialog" class="modal-backdrop">
        <button>关闭</button>
    </form>
</dialog>

<!-- 电源操作确认模态框 -->
<dialog id="powerConfirmModal" class="modal">
    <div class="modal-box">
        <h3 class="font-bold text-lg flex items-center gap-2" id="powerConfirmTitle">
            <span class="iconify text-blue-600" data-icon="mdi:information" data-width="24"></span>
            确认操作
        </h3>
        <p class="py-4" id="powerConfirmMsg">确定要执行此操作吗？</p>
        <div class="modal-action">
            <button onclick="closePowerConfirmModal()"
                    class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50">
                取消
            </button>
            <button onclick="executePowerAction()" id="powerConfirmBtn"
                    class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg">
                确认
            </button>
        </div>
    </div>
    <form method="dialog" class="modal-backdrop">
        <button>关闭</button>
    </form>
</dialog>

<!-- 编辑配置保存确认模态框 -->
<dialog id="editConfirmModal" class="modal">
    <div class="modal-box">
        <h3 class="font-bold text-lg flex items-center gap-2 text-purple-600">
            <span class="iconify" data-icon="mdi:content-save" data-width="24"></span>
            确认保存
        </h3>
        <p class="py-4">确定要保存对虚拟机 "<span class="font-medium">{{ vm_uuid }}</span>" 的配置修改吗？</p>
        <div class="modal-action">
            <button onclick="document.getElementById('editConfirmModal').close()"
                    class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50">
                取消
            </button>
            <button onclick="executeEditSave()"
                    class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg">
                确认保存
            </button>
        </div>
    </div>
    <form method="dialog" class="modal-backdrop">
        <button>关闭</button>
    </form>
</dialog>

<!-- 编辑虚拟机配置模态框 -->
<dialog id="vmEditModal" class="modal">
    <div class="modal-box max-w-3xl max-h-[90vh] flex flex-col">
        <h3 class="font-bold text-lg flex items-center gap-2 flex-shrink-0">
            <span class="iconify text-purple-600" data-icon="mdi:cube-outline" data-width="24"></span>
            编辑虚拟机配置
        </h3>
        <form id="vmEditForm" class="mt-4 flex flex-col flex-1 overflow-hidden">
            <!-- 可滚动内容区域 -->
            <div class="flex-1 overflow-y-auto space-y-4 pr-2">
                <!-- 基本信息 -->
                <div class="border border-gray-200 rounded-lg p-4">
                    <h4 class="text-sm font-medium text-gray-700 mb-3 flex items-center gap-2">
                        <span class="iconify" data-icon="mdi:information" data-width="18"></span>
                        基本信息
                    </h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium text-gray-600 mb-1">虚拟机UUID *</label>
                            <div class="flex gap-2">
                                <input type="text" name="vm_uuid" id="editVmUuid" disabled
                                       class="flex-1 px-3 py-2 border border-gray-300 rounded-lg bg-gray-100 text-gray-600 cursor-not-allowed"
                                       placeholder="例如: vm_test001">
                                <button type="button" disabled
                                        class="px-4 py-2 bg-gray-300 text-gray-500 rounded-lg cursor-not-allowed flex items-center gap-1 whitespace-nowrap min-w-[80px] opacity-50">
                                    <span class="iconify" data-icon="mdi:refresh" data-width="18"></span>
                                    随机
                                </button>
                            </div>
                        </div>
                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium text-gray-600 mb-1">操作系统</label>
                            <select name="os_name" id="editOsName"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                                <option value="">请选择</option>
                                <!-- 操作系统选项将从主机的system_maps动态加载 -->
                            </select>
                        </div>
                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium text-gray-600 mb-1">系统密码</label>
                            <div class="flex gap-2">
                                <input type="text" name="os_pass" id="editOsPass"
                                       class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                                       placeholder="设置系统登录密码"
                                       oninput="syncOsPassToVncPass()">
                                <button type="button" onclick="generateEditOsPass()"
                                        class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors flex items-center gap-1 whitespace-nowrap min-w-[80px]">
                                    <span class="iconify" data-icon="mdi:refresh" data-width="18"></span>
                                    随机
                                </button>
                            </div>
                            <p id="editOsPassError" class="text-xs text-red-600 mt-1" style="display: none;"></p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-600 mb-1">VNC密码</label>
                            <input type="text" name="vc_pass" id="editVcPass"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                                   placeholder="VNC远程密码"
                                   oninput="validatePasswordInput('editVcPass', 'editVcPassError')">
                            <p id="editVcPassError" class="text-xs text-red-600 mt-1" style="display: none;"></p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-600 mb-1">VNC端口</label>
                            <div class="flex gap-2">
                                <input type="number" name="vc_port" id="editVcPort" min="1" max="65535"
                                       class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                                       placeholder="VNC远程端口">
                                <button type="button" onclick="generateRandomVncPortForInput()"
                                        class="px-3 py-2 bg-blue-50 hover:bg-blue-100 text-blue-600 border border-blue-200 rounded-lg text-sm flex items-center gap-1"
                                        title="生成随机端口">
                                    <span class="iconify" data-icon="mdi:dice-6" data-width="16"></span>
                                    随机
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                {{ resource_config('edit') }}

                {{ network_config('edit', true) }}
            </div>
            <!-- 可滚动内容区域结束 -->

            <!-- 按钮区域固定在底部 -->
            <div class="modal-action flex-shrink-0 pt-4 border-t border-gray-200 mt-4">
                <button type="button" onclick="document.getElementById('vmEditModal').close()"
                        class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50">
                    取消
                </button>
                <button type="submit"
                        class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg flex items-center gap-2">
                    <span class="iconify" data-icon="mdi:check" data-width="18"></span>
                    保存配置
                </button>
            </div>
        </form>
    </div>
    <form method="dialog" class="modal-backdrop">
        <button>关闭</button>
    </form>
</dialog>
{% endblock %}

{% block extra_scripts %}
<!-- 引入 ECharts -->
<script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
<script>
    const hostName = '{{ hs_name }}';
    const vmUuid = '{{ vm_uuid }}';
    let vmData = null;
    let hostData = null;
    let hostSystemMaps = {}; // 存储主机的系统映射

    // 状态文字映射
    const statusMap = {
        'STOPPED': {text: '已停止', color: 'text-gray-600 bg-gray-100', icon: 'mdi:stop-circle'},
        'STARTED': {text: '运行中', color: 'text-green-700 bg-green-100', icon: 'mdi:check-circle', pulse: true},
        'SUSPEND': {text: '已暂停', color: 'text-yellow-700 bg-yellow-100', icon: 'mdi:pause-circle'},
        'ON_STOP': {text: '停止中', color: 'text-orange-600 bg-orange-100', icon: 'mdi:loading'},
        'ON_OPEN': {text: '启动中', color: 'text-blue-600 bg-blue-100', icon: 'mdi:loading'},
        'CRASHED': {text: '已崩溃', color: 'text-red-700 bg-red-100', icon: 'mdi:alert-circle'},
        'UNKNOWN': {text: '未知', color: 'text-gray-500 bg-gray-100', icon: 'mdi:help-circle'}
    };

    // 获取网络类型显示名称
    function getNicTypeDisplay(nicType) {
        const typeMap = {
            'nat': '内网',
            'pub': '外网',
            'bridged': '桥接',
            'host-only': '仅主机'
        };
        return typeMap[nicType] || nicType;
    }

    // 切换密码可见性
    function togglePasswordVisibility() {
        const passInput = document.getElementById('vmOsPass');
        const eyeIcon = document.getElementById('eyeIcon');
        const actualPassword = $(passInput).data('password') || '';

        if (passInput.type === 'password') {
            // 当前是隐藏状态，切换为显示
            passInput.type = 'text';
            passInput.value = actualPassword || '(无密码)';
            eyeIcon.setAttribute('data-icon', 'mdi:eye-off-outline');
        } else {
            // 当前是显示状态，切换为隐藏
            passInput.type = 'password';
            passInput.value = '********';
            eyeIcon.setAttribute('data-icon', 'mdi:eye-outline');
        }
    }

    // 复制密码到剪贴板
    function copyPassword() {
        const passInput = document.getElementById('vmOsPass');
        const password = $(passInput).data('password') || passInput.value;

        if (!password) {
            showToast('没有可复制的密码', 'warning');
            return;
        }

        // 使用现代剪贴板API
        if (navigator.clipboard && navigator.clipboard.writeText) {
            navigator.clipboard.writeText(password).then(() => {
                showToast('密码已复制到剪贴板', 'success');
            }).catch(err => {
                console.error('复制失败:', err);
                fallbackCopyPassword(password);
            });
        } else {
            fallbackCopyPassword(password);
        }
    }

    // 备用复制方法（兼容旧浏览器）
    function fallbackCopyPassword(password) {
        const textarea = document.createElement('textarea');
        textarea.value = password;
        textarea.style.position = 'fixed';
        textarea.style.opacity = '0';
        document.body.appendChild(textarea);
        textarea.select();

        try {
            document.execCommand('copy');
            showToast('密码已复制到剪贴板', 'success');
        } catch (err) {
            console.error('复制失败:', err);
            showToast('复制失败，请手动复制', 'error');
        }

        document.body.removeChild(textarea);
    }

    // 切换VNC密码可见性
    function toggleVncPasswordVisibility() {
        const passInput = document.getElementById('vmVncPass');
        const eyeIcon = document.getElementById('vncEyeIcon');
        const actualPassword = $(passInput).data('password') || '';

        if (passInput.type === 'password') {
            // 当前是隐藏状态，切换为显示
            passInput.type = 'text';
            passInput.value = actualPassword || '(无密码)';
            eyeIcon.setAttribute('data-icon', 'mdi:eye-off-outline');
        } else {
            // 当前是显示状态，切换为隐藏
            passInput.type = 'password';
            passInput.value = '********';
            eyeIcon.setAttribute('data-icon', 'mdi:eye-outline');
        }
    }

    // 复制VNC密码到剪贴板
    function copyVncPassword() {
        const passInput = document.getElementById('vmVncPass');
        const password = $(passInput).data('password') || passInput.value;

        if (!password) {
            showToast('没有可复制的VNC密码', 'warning');
            return;
        }

        // 使用现代剪贴板API
        if (navigator.clipboard && navigator.clipboard.writeText) {
            navigator.clipboard.writeText(password).then(() => {
                showToast('VNC密码已复制到剪贴板', 'success');
            }).catch(err => {
                console.error('复制失败:', err);
                fallbackCopyVncPassword(password);
            });
        } else {
            fallbackCopyVncPassword(password);
        }
    }

    // 备用复制VNC密码方法（兼容旧浏览器）
    function fallbackCopyVncPassword(password) {
        const textarea = document.createElement('textarea');
        textarea.value = password;
        textarea.style.position = 'fixed';
        textarea.style.opacity = '0';
        document.body.appendChild(textarea);
        textarea.select();

        try {
            document.execCommand('copy');
            showToast('VNC密码已复制到剪贴板', 'success');
        } catch (err) {
            console.error('复制失败:', err);
            showToast('复制失败，请手动复制', 'error');
        }

        document.body.removeChild(textarea);
    }

    $(document).ready(function () {
        loadVMInfo();
        loadHostInfo();
        loadNATRules();
        loadIPAddresses();
        loadProxyConfigs();
        loadHDDList();
        loadISOList();
        loadBackupList();
        
        // 初始化自定义确认对话框
        initConfirmDialog();

        // 表单提交处理
        $('#addNATForm').on('submit', function (e) {
            e.preventDefault();
            submitNATRule();
        });

        $('#addIPForm').on('submit', function (e) {
            e.preventDefault();
            submitIPAddress();
        });

        $('#editIPForm').on('submit', function (e) {
            e.preventDefault();
            submitEditIPAddress();
        });

        $('#addProxyForm').on('submit', function (e) {
            e.preventDefault();
            submitProxyConfig();
        });

        $('#addHDDForm').on('submit', function (e) {
            e.preventDefault();
            submitHDD();
        });

        $('#transferHDDForm').on('submit', function (e) {
            e.preventDefault();
            submitTransferHDD();
        });

        $('#addISOForm').on('submit', function (e) {
            e.preventDefault();
            submitISO();
        });

        $('#createBackupForm').on('submit', function (e) {
            e.preventDefault();
            submitBackup();
        });

        // 添加所有者表单提交处理
        $('#addOwnerForm').on('submit', function (e) {
            e.preventDefault();
            submitAddOwner();
        });

        // 移交所有权表单提交处理
        $('#transferOwnershipForm').on('submit', function (e) {
            e.preventDefault();
            submitTransferOwnership();
        });

        // 移交所有权表单输入监听
        $('#newOwnerUsername, #confirmTransferCheckbox').on('input change', function () {
            toggleTransferOwnershipButton();
        });

        // 编辑虚拟机表单提交处理
        $('#vmEditForm').on('submit', function (e) {
            e.preventDefault();

            try {
                pendingEditVmData = collectEditVmFormData();
                // 如果返回null，说明密码验证失败，直接返回不提交
                if (pendingEditVmData === null) {
                    return;
                }
            } catch (error) {
                // 显示验证错误
                Swal.fire({
                    icon: 'error',
                    title: '配置验证失败',
                    text: error.message,
                    confirmButtonText: '确定'
                });
                return;
            }

            // 先关闭编辑框
            document.getElementById('vmEditModal').close();

            // 使用SweetAlert2确认保存
            Swal.fire({
                title: '保存确认',
                html: `
                    <p class="mb-4">确定要保存对虚拟机 "<strong>${vmUuid}</strong>" 的配置修改吗？</p>
                    <label class="flex items-center justify-center gap-2 cursor-pointer">
                        <input type="checkbox" id="confirmForceShutdown" class="w-4 h-4 text-purple-600 border-gray-300 rounded focus:ring-purple-500">
                        <span class="text-sm text-gray-700">我已确认强制关闭虚拟机</span>
                    </label>
                `,
                icon: 'question',
                showCancelButton: true,
                confirmButtonColor: '#9333ea',
                cancelButtonColor: '#6b7280',
                confirmButtonText: '确认保存',
                cancelButtonText: '取消',
                reverseButtons: true,
                customClass: {
                    container: 'swal-on-top'
                },
                preConfirm: () => {
                    const checkbox = document.getElementById('confirmForceShutdown');
                    if (!checkbox.checked) {
                        Swal.showValidationMessage('请先勾选确认强制关闭虚拟机');
                        return false;
                    }
                    return true;
                }
            }).then((result) => {
                if (result.isConfirmed) {
                    // 显示保存中状态
                    Swal.fire({
                        title: '保存中...',
                        html: '正在保存虚拟机配置',
                        allowOutsideClick: false,
                        allowEscapeKey: false,
                        showConfirmButton: false,
                        didOpen: () => {
                            Swal.showLoading();
                        }
                    });

                    submitEditVmForm(pendingEditVmData);
                    pendingEditVmData = null;
                } else {
                    // 用户取消，重新打开编辑框
                    document.getElementById('vmEditModal').showModal();
                }
            });
        });

        // SSL选项显示/隐藏
        $('#proxySSLEnabled').on('change', function () {
            if ($(this).is(':checked')) {
                $('#sslOptions').slideDown(200);
            } else {
                $('#sslOptions').slideUp(200);
            }
        });

        $('#proxySSLType').on('change', function () {
            if ($(this).val() === 'custom') {
                $('#customCertFields').slideDown(200);
            } else {
                $('#customCertFields').slideUp(200);
            }
        });

        // 定时刷新状态
        setInterval(loadVMInfo, 15000);
    });

    // Tab切换
    function switchTab(tabName) {
        document.querySelectorAll('.tab-pane').forEach(pane => pane.style.display = 'none');
        document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('tab-active'));

        const tabMap = {
            'info': 'infoTab',
            'nat': 'natTab',
            'ip': 'ipTab',
            'proxy': 'proxyTab',
            'hdd': 'hddTab',
            'iso': 'isoTab',
            'backup': 'backupTab',
            'owners': 'ownersTab'
        };
        const selectedPane = document.getElementById(tabMap[tabName]);
        if (selectedPane) selectedPane.style.display = 'block';

        event.target.classList.add('tab-active');

        // 切换到owners tab时加载所有者列表
        if (tabName === 'owners') {
            loadOwnersList();
        }
    }

    // 复制到剪贴板
    function copyToClipboard(text) {
        navigator.clipboard.writeText(text).then(() => {
            showToast('已复制: ' + text, 'success');
        }).catch(() => {
            showToast('复制失败', 'error');
        });
    }

    // 加载主机信息（获取公网IP和系统映射）
    async function loadHostInfo() {
        const result = await apiRequest(`/api/client/os-images/${hostName}`);
        if (result && result.code === 200) {
            const hostData = result.data;
            hostSystemMaps = hostData.system_maps || {}; // 初始化系统映射
            // 注意：公网IP需要从主机详情获取，这里暂时不处理
        }
    }

    // 渲染外网访问IP
    function renderPublicAddr(addrs) {
        const container = $('#vmPublicAddr');
        if (!addrs || !Array.isArray(addrs) || addrs.length === 0) {
            container.text('未配置');
            return;
        }

        const ipHtml = addrs.map(ip =>
            `<span class="inline-flex items-center gap-1 cursor-pointer hover:text-green-600 mr-2" onclick="copyToClipboard('${ip}')" title="点击复制">
                ${ip}
                <span class="iconify text-gray-400 hover:text-green-600" data-icon="mdi:content-copy" data-width="12"></span>
            </span>`
        ).join('');
        container.html(ipHtml);
    }

    // 加载虚拟机信息
    async function loadVMInfo() {
        const result = await apiRequest(`/api/client/detail/${hostName}/${vmUuid}`);
        if (result && result.code === 200) {
            vmData = result.data;
            renderVMInfo(vmData);

            // 初始化操作系统选项（用于编辑时）
            const config = vmData.config || {};
            updateOsOptions(config.os_name || '');
        } else {
            showToast(result?.msg || '加载失败', 'error');
        }
    }

    // 更新操作系统下拉选项
    function updateOsOptions(selectedOsName = '') {
        const osSelect = document.getElementById('editOsName');
        // 保留"请选择"选项
        osSelect.innerHTML = '<option value="">请选择</option>';

        // 从system_maps添加选项
        for (const [osName, osConfig] of Object.entries(hostSystemMaps)) {
            const option = document.createElement('option');
            // osConfig是数组 [镜像文件, 最小大小]
            const imageFile = Array.isArray(osConfig) ? osConfig[0] : osConfig;
            option.value = imageFile; // 值设置为镜像文件名
            option.textContent = osName; // 显示文本为系统名称
            // 如果是编辑模式且匹配当前值，则选中
            if (selectedOsName && imageFile === selectedOsName) {
                option.selected = true;
            }
            osSelect.appendChild(option);
        }
    }

    // 渲染虚拟机信息
    function renderVMInfo(data) {
        const config = data.config || {};
        // status现在是数组 list[HWStatus]，取第一个元素的ac_status作为电源状态
        const statusList = data.status || [];
        // 获取最新的状态（数组的最后一个元素）
        const firstStatus = statusList.length > 0 ? statusList[statusList.length - 1] : {};
        const powerStatus = firstStatus.ac_status || 'UNKNOWN';
        const statusInfo = statusMap[powerStatus] || statusMap['UNKNOWN'];

        // 更新状态
        $('#vmStatus').html(`
            <span class="px-3 py-1 text-sm font-medium ${statusInfo.color} rounded-full flex items-center gap-1">
                ${statusInfo.pulse ? '<span class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></span>' : ''}
                ${statusInfo.text}
            </span>
        `);

        // 如果虚拟机处于运行中状态，显示修改密码按钮
        if (powerStatus === 'STARTED') {
            $('#changePasswordBtn').show();
        } else {
            $('#changePasswordBtn').hide();
        }

        // 更新操作系统
        $('#vmOsName').text(config.os_name || '未知系统');

        // 更新系统密码
        const osPass = config.os_pass || '';
        $('#vmOsPass').data('password', osPass); // 存储实际密码
        // 如果没有密码，显示8位星号；如果有密码，也显示8位星号（隐藏状态）
        $('#vmOsPass').val('********');
        $('#vmOsPass').attr('type', 'password');

        // 更新VNC密码
        const vncPass = config.vc_pass || '';
        $('#vmVncPass').data('password', vncPass); // 存储实际VNC密码
        // 如果没有密码，显示8位星号；如果有密码，也显示8位星号（隐藏状态）
        $('#vmVncPass').val('********');
        $('#vmVncPass').attr('type', 'password');

        // 更新资源配置 - CPU
        $('#vmCpu').text((config.cpu_num || 0) + ' 核');
        const cpuPer = firstStatus.cpu_usage || 0;
        $('#vmCpuPerText').text(cpuPer + '%');
        $('#vmCpuPerBar').css('width', Math.min(cpuPer, 100) + '%')
            .removeClass('bg-green-500 bg-blue-500 bg-yellow-500 bg-orange-500 bg-red-500')
            .addClass(getProgressBarColor(cpuPer));

        // 更新资源配置 - 内存
        const memTotal = config.mem_num || 0;
        const memUsageMB = firstStatus.mem_usage || 0;
        const memPer = memTotal > 0 ? Math.round(memUsageMB / memTotal * 100) : 0;
        $('#vmMemory').text(formatMemory(memTotal));
        $('#vmMemUsageText').text('已用 ' + memPer + '%');
        $('#vmMemPerText').text(memPer + '%');
        $('#vmMemPerBar').css('width', Math.min(memPer, 100) + '%')
            .removeClass('bg-green-500 bg-blue-500 bg-yellow-500 bg-orange-500 bg-red-500')
            .addClass(getProgressBarColor(memPer));

        // 更新资源配置 - 硬盘
        const hddTotal = config.hdd_num || 0;
        const hddUsage = firstStatus.hdd_usage || 0;
        const hddPer = hddTotal > 0 ? Math.round(hddUsage / hddTotal * 100) : 0;
        $('#vmDisk').text(formatDisk(hddTotal));
        $('#vmHddUsageText').text('已用 ' + formatDisk(hddUsage));
        $('#vmHddPerText').text(hddPer + '%');
        $('#vmHddPerBar').css('width', Math.min(hddPer, 100) + '%')
            .removeClass('bg-green-500 bg-blue-500 bg-yellow-500 bg-orange-500 bg-red-500')
            .addClass(getProgressBarColor(hddPer));

        // 更新资源配置 - GPU显存
        const gpuMem = config.gpu_mem || 0;
        const gpuUsage = firstStatus.gpu_total || 0;  // gpu_total在HWStatus中代表已用显存
        const gpuPer = gpuMem > 0 ? Math.round(gpuUsage / gpuMem * 100) : 0;
        $('#vmGpu').text(gpuMem + ' MB');
        $('#vmGpuUsageText').text('已用 ' + gpuUsage + ' MB');
        $('#vmGpuPerText').text(gpuPer + '%');
        $('#vmGpuPerBar').css('width', Math.min(gpuPer, 100) + '%')
            .removeClass('bg-green-500 bg-blue-500 bg-yellow-500 bg-orange-500 bg-red-500')
            .addClass(getProgressBarColor(gpuPer));

        // 更新资源配置 - 上行带宽
        const speedU = config.speed_u || 0;
        const netUsage = firstStatus.network_u || 0;
        const netPer = speedU > 0 ? Math.round(netUsage / speedU * 100) : 0;
        $('#vmSpeedU').text(speedU + ' Mbps');
        $('#vmNetUsageText').text('已用 ' + netUsage + ' Mbps');
        $('#vmNetPerText').text(netPer + '%');
        $('#vmNetPerBar').css('width', Math.min(netPer, 100) + '%')
            .removeClass('bg-green-500 bg-blue-500 bg-yellow-500 bg-orange-500 bg-red-500')
            .addClass(getProgressBarColor(netPer));

        // 更新资源配置 - 下行带宽
        const speedD = config.speed_d || 0;
        const netDUsage = firstStatus.network_d || 0;
        const netDPer = speedD > 0 ? Math.round(netDUsage / speedD * 100) : 0;
        $('#vmSpeedD').text(speedD + ' Mbps');
        $('#vmNetDUsageText').text('已用 ' + netDUsage + ' Mbps');
        $('#vmNetDPerText').text(netDPer + '%');
        $('#vmNetDPerBar').css('width', Math.min(netDPer, 100) + '%')
            .removeClass('bg-green-500 bg-blue-500 bg-yellow-500 bg-orange-500 bg-red-500')
            .addClass(getProgressBarColor(netDPer));

        // 更新资源配置 - 反向代理
        const webNum = config.web_num || 0;
        const webUsage = firstStatus.web_usage || 0;
        const webPer = webNum > 0 ? Math.round(webUsage / webNum * 100) : 0;
        $('#vmWebNum').text(webNum + ' 个');
        $('#vmWebUsageText').text('已用 ' + webUsage + ' 个');
        $('#vmWebPerText').text(webPer + '%');
        $('#vmWebPerBar').css('width', Math.min(webPer, 100) + '%')
            .removeClass('bg-green-500 bg-blue-500 bg-yellow-500 bg-orange-500 bg-red-500')
            .addClass(getProgressBarColor(webPer));

        // 更新网络配置 - NAT端口数
        const natNum = config.nat_num || 0;
        const natUsage = firstStatus.nat_usage || 0;
        const natPer = natNum > 0 ? Math.round(natUsage / natNum * 100) : 0;
        $('#vmNatNum').text(natNum + ' 个');
        $('#vmNatUsageText').text('已用 ' + natUsage + ' 个');
        $('#vmNatPerText').text(natPer + '%');
        $('#vmNatPerBar').css('width', Math.min(natPer, 100) + '%')
            .removeClass('bg-green-500 bg-blue-500 bg-yellow-500 bg-orange-500 bg-red-500')
            .addClass(getProgressBarColor(natPer));

        // 更新网络配置 - 流量限制
        const fluNum = config.flu_num || 0;
        const fluUsage = firstStatus.flu_usage || 0;
        const fluPer = fluNum > 0 ? Math.round(fluUsage / fluNum * 100) : 0;
        $('#vmTraffic').text(fluNum > 0 ? formatTraffic(fluNum) : '无限制');
        $('#vmFluUsageText').text('已用 ' + formatTraffic(fluUsage));
        $('#vmFluPerText').text(fluPer + '%');
        $('#vmFluPerBar').css('width', Math.min(fluPer, 100) + '%')
            .removeClass('bg-green-500 bg-blue-500 bg-yellow-500 bg-orange-500 bg-red-500')
            .addClass(getProgressBarColor(fluPer));

        // 更新网卡列表
        const nicAll = config.nic_all || {};
        if (Object.keys(nicAll).length > 0) {
            let nicHtml = '<div class="space-y-3">';
            for (const [nicName, nicConfig] of Object.entries(nicAll)) {
                nicHtml += `
                    <div class="bg-gray-50 rounded-lg p-3 border border-gray-200">
                        <div class="flex items-center justify-between mb-2">
                            <span class="font-medium text-gray-200 inline-block text-left" style="width: 100px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${nicName}</span>
                            <span class="px-2 py-0.5 text-xs font-medium text-gray-600 bg-gray-200 rounded">${getNicTypeDisplay(nicConfig.nic_type || 'nat')}</span>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-3 text-sm">
                            <div class="flex items-center gap-2">
                                <span class="text-gray-500 whitespace-nowrap">IPv4:</span>
                                <span class="font-mono text-gray-700 inline-block text-left" style="width: 100px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${nicConfig.ip4_addr || '-'}</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <span class="text-gray-500 whitespace-nowrap">IPv6:</span>
                                <span class="font-mono text-gray-700 break-all">${nicConfig.ip6_addr || '-'}</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <span class="text-gray-500 whitespace-nowrap">MAC:</span>
                                <span class="font-mono text-gray-700 break-all">${nicConfig.mac_addr || '-'}</span>
                            </div>
                        </div>
                    </div>
                `;
            }
            nicHtml += '</div>';
            $('#nicList').html(nicHtml);

            // 提取主IP
            const firstNic = Object.values(nicAll)[0];
            if (firstNic && firstNic.ip4_addr) {
                $('#vmIPv4').text(firstNic.ip4_addr);
            }
            if (firstNic && firstNic.ip6_addr) {
                $('#vmIPv6').text(firstNic.ip6_addr);
            }

            // 更新网卡选择下拉框
            let nicOptions = '';
            for (const nicName of Object.keys(nicAll)) {
                nicOptions += `<option value="${nicName}">${nicName}</option>`;
            }
            $('#ipNic').html(nicOptions);

            // 绘制历史数据图表
            drawHistoryCharts(statusList);
        } else {
            $('#nicList').html('<p class="text-sm text-gray-500">暂无网卡配置</p>');
        }

        // 更新运行状态
        if (status && Object.keys(status).length > 0) {
            let statusHtml = '';
            if (status.cpu_usage !== undefined) {
                statusHtml += `
                    <div class="bg-gray-50 rounded-lg p-3 border border-gray-200">
                        <p class="text-xs text-gray-500">CPU使用率</p>
                        <p class="text-lg font-medium text-gray-800 mt-1">${status.cpu_usage.toFixed(1)}%</p>
                    </div>
                `;
            }
            if (status.mem_usage !== undefined) {
                statusHtml += `
                    <div class="bg-gray-50 rounded-lg p-3 border border-gray-200">
                        <p class="text-xs text-gray-500">内存使用率</p>
                        <p class="text-lg font-medium text-gray-800 mt-1">${status.mem_usage.toFixed(1)}%</p>
                    </div>
                `;
            }
            if (status.disk_usage !== undefined) {
                statusHtml += `
                    <div class="bg-gray-50 rounded-lg p-3 border border-gray-200">
                        <p class="text-xs text-gray-500">磁盘使用率</p>
                        <p class="text-lg font-medium text-gray-800 mt-1">${status.disk_usage.toFixed(1)}%</p>
                    </div>
                `;
            }
            if (status.network_rx !== undefined || status.network_tx !== undefined) {
                statusHtml += `
                    <div class="bg-gray-50 rounded-lg p-3 border border-gray-200">
                        <p class="text-xs text-gray-500">网络流量</p>
                        <p class="text-sm font-medium text-gray-800 mt-1">
                            ↓${formatBytes(status.network_rx || 0)} / ↑${formatBytes(status.network_tx || 0)}
                        </p>
                    </div>
                `;
            }
            $('#vmStatusInfo').html(statusHtml || '<p class="col-span-full text-sm text-gray-500">暂无运行状态数据</p>');
        } else {
            $('#vmStatusInfo').html('<p class="col-span-full text-sm text-gray-500">暂无运行状态数据</p>');
        }
    }

    // 电源操作 - 需要确认的操作列表
    const powerActionNames = {
        'start': '启动',
        'stop': '关机',
        'hard_stop': '强制关机',
        'reset': '重启',
        'hard_reset': '强制重启',
        'pause': '暂停',
        'resume': '恢复'
    };

    let pendingPowerAction = null;

    // 电源操作 - 显示确认弹窗
    function vmPower(action) {
        pendingPowerAction = action;
        const actionName = powerActionNames[action] || action;

        // 设置确认弹窗内容
        document.getElementById('powerConfirmTitle').innerHTML = `
            <span class="iconify text-blue-600" data-icon="mdi:information" data-width="24"></span>
            确认${actionName}
        `;
        document.getElementById('powerConfirmMsg').textContent = `确定要对虚拟机 "${vmUuid}" 执行${actionName}操作吗？`;

        // 根据操作类型设置按钮颜色
        const btn = document.getElementById('powerConfirmBtn');
        btn.className = 'px-4 py-2 rounded-lg text-white ';
        if (action === 'start' || action === 'resume') {
            btn.className += 'bg-green-600 hover:bg-green-700';
        } else if (action === 'hard_stop' || action === 'hard_reset') {
            btn.className += 'bg-red-600 hover:bg-red-700';
        } else if (action === 'stop') {
            btn.className += 'bg-yellow-600 hover:bg-yellow-700';
        } else {
            btn.className += 'bg-blue-600 hover:bg-blue-700';
        }

        document.getElementById('powerConfirmModal').showModal();
    }

    // 关闭电源确认弹窗
    function closePowerConfirmModal() {
        document.getElementById('powerConfirmModal').close();
        pendingPowerAction = null;
    }

    // 操作进行中的loading toast id
    let loadingToastId = null;
    const POWER_ACTION_TIMEOUT = 60000; // 60秒超时

    // 显示带转圈的加载提示
    function showLoadingToast(message) {
        const container = document.getElementById('toast-container');
        const toastId = 'loading-toast-' + Date.now();

        const toast = document.createElement('div');
        toast.id = toastId;
        toast.className = 'bg-blue-500 text-white px-4 py-3 rounded-lg shadow-lg flex items-center gap-2 animate-fade-in';
        toast.innerHTML = `
            <svg class="animate-spin h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <span>${message}</span>
        `;

        container.appendChild(toast);
        return toastId;
    }

    // 关闭加载提示
    function hideLoadingToast(toastId) {
        const toast = document.getElementById(toastId);
        if (toast) {
            toast.classList.add('opacity-0', 'transition-opacity', 'duration-300');
            setTimeout(() => toast.remove(), 300);
        }
    }

    // 禁用所有虚拟机操作按钮（电源、删除、VNC）
    function disablePowerButtons() {
        document.querySelectorAll('.vm-power-btn').forEach(btn => {
            btn.disabled = true;
            btn.classList.add('opacity-50', 'cursor-not-allowed');
        });
    }

    // 启用所有虚拟机操作按钮（电源、删除、VNC）
    function enablePowerButtons() {
        document.querySelectorAll('.vm-power-btn').forEach(btn => {
            btn.disabled = false;
            btn.classList.remove('opacity-50', 'cursor-not-allowed');
        });
    }

    // 执行电源操作
    async function executePowerAction() {
        if (!pendingPowerAction) return;

        const action = pendingPowerAction;
        const actionName = powerActionNames[action] || action;
        closePowerConfirmModal();

        // 禁用操作按钮
        disablePowerButtons();

        // 显示加载提示
        loadingToastId = showLoadingToast(`正在执行${actionName}操作...`);

        // 设置60秒超时
        const timeoutPromise = new Promise((_, reject) => {
            setTimeout(() => reject(new Error('timeout')), POWER_ACTION_TIMEOUT);
        });

        // API请求
        const apiPromise = apiRequest(`/api/client/powers/${hostName}/${vmUuid}`, 'POST', {action});

        try {
            // 使用Promise.race处理超时
            const result = await Promise.race([apiPromise, timeoutPromise]);

            // 关闭加载提示
            if (loadingToastId) {
                hideLoadingToast(loadingToastId);
                loadingToastId = null;
            }

            if (result && result.code === 200) {
                showToast(result.msg || '操作成功', 'success');
                setTimeout(loadVMInfo, 1000);
            } else {
                showToast(result?.msg || '操作失败', 'error');
            }
        } catch (error) {
            // 关闭加载提示
            if (loadingToastId) {
                hideLoadingToast(loadingToastId);
                loadingToastId = null;
            }

            if (error.message === 'timeout') {
                showToast(`${actionName}操作超时（60秒），请检查虚拟机状态`, 'warning');
            } else {
                showToast('操作失败: ' + (error.message || '未知错误'), 'error');
            }
        } finally {
            // 启用操作按钮
            enablePowerButtons();
        }
    }

    // 删除确认
    function confirmDeleteVM() {
        document.getElementById('deleteModal').showModal();
    }

    // 执行删除
    async function executeDeleteVM() {
        const confirmInput = document.getElementById('deleteConfirmInput').value;
        if (confirmInput !== vmUuid) {
            showToast('请输入正确的虚拟机名称以确认删除', 'error');
            return;
        }

        try {
            const result = await apiRequest(`/api/client/delete/${hostName}/${vmUuid}`, 'DELETE');
            if (result && result.code === 200) {
                showToast('虚拟机已删除', 'success');
                document.getElementById('deleteModal').close();
                document.getElementById('deleteConfirmInput').value = '';
                setTimeout(() => window.location.href = '/', 1000);
            } else {
                showToast(result?.msg || '删除失败', 'error');
                document.getElementById('deleteModal').close();
                document.getElementById('deleteConfirmInput').value = '';
                // 删除失败后也跳转到首页
                setTimeout(() => window.location.href = '/', 1500);
            }
        } catch (error) {
            showToast('网络错误或服务器异常', 'error');
            document.getElementById('deleteModal').close();
            document.getElementById('deleteConfirmInput').value = '';
            // 网络错误后也跳转到首页
            setTimeout(() => window.location.href = '/', 1500);
        }
    }

    // 密码验证函数：最低12位，且至少包含字母、数字、特殊符号中的两种
    function validatePassword(password, fieldName) {
        if (password.length < 12) {
            throw new Error(`${fieldName}长度不得低于12位`);
        }

        let typeCount = 0;
        if (/[a-zA-Z]/.test(password)) typeCount++; // 包含字母
        if (/[0-9]/.test(password)) typeCount++; // 包含数字
        if (/[^a-zA-Z0-9]/.test(password)) typeCount++; // 包含特殊符号

        if (typeCount < 2) {
            throw new Error(`${fieldName}必须至少包含字母、数字、特殊符号中的两种`);
        }
    }

    // 切换确认按钮的启用/禁用状态
    function togglePasswordConfirmButton() {
        const confirmButton = document.getElementById('confirmPasswordChange');
        const confirmCheck = document.getElementById('confirmForceShutdownPassword');
        const newPasswordInput = document.getElementById('newPassword');
        const password = newPasswordInput.value.trim();

        // 检查是否可以启用按钮：复选框已勾选 且 密码为空或密码有效
        const isCheckboxChecked = confirmCheck.checked;

        let isPasswordValid = false;
        if (!password) {
            // 密码为空时，认为有效（用户不修改密码）
            isPasswordValid = true;
        } else {
            // 密码不为空时，手动验证密码是否有效（不调用validatePasswordInput避免循环）
            let errors = [];

            // 检查长度
            if (password.length < 8) {
                errors.push('密码长度不得低于8位');
            }

            // 检查复杂度
            let typeCount = 0;
            if (/[a-zA-Z]/.test(password)) typeCount++; // 包含字母
            if (/[0-9]/.test(password)) typeCount++; // 包含数字
            if (/[^a-zA-Z0-9]/.test(password)) typeCount++; // 包含特殊符号

            if (typeCount < 2) {
                errors.push('必须至少包含字母、数字、特殊符号中的两种');
            }

            isPasswordValid = errors.length === 0;
        }

        if (isCheckboxChecked && isPasswordValid) {
            confirmButton.disabled = false;
        } else {
            confirmButton.disabled = true;
        }
    }

    // 实时密码验证函数（用于输入框实时验证）
    // 密码输入处理函数
    function onPasswordInput() {
        validatePasswordInput('newPassword', 'newPasswordError');
        togglePasswordConfirmButton();
    }

    function validatePasswordInput(inputId, errorId) {
        const input = document.getElementById(inputId);
        const errorElement = document.getElementById(errorId);
        const password = input.value;

        // 如果密码为空，不显示错误
        if (!password) {
            errorElement.style.display = 'none';
            input.classList.remove('border-red-500');
            return true;
        }

        let errors = [];

        // 检查长度
        if (password.length < 8) {
            errors.push('密码长度不得低于8位');
        }

        // 检查复杂度
        let typeCount = 0;
        if (/[a-zA-Z]/.test(password)) typeCount++; // 包含字母
        if (/[0-9]/.test(password)) typeCount++; // 包含数字
        if (/[^a-zA-Z0-9]/.test(password)) typeCount++; // 包含特殊符号

        if (typeCount < 2) {
            errors.push('必须至少包含字母、数字、特殊符号中的两种');
        }

        // 显示或隐藏错误信息
        if (errors.length > 0) {
            errorElement.textContent = errors.join('；');
            errorElement.style.display = 'block';
            input.classList.add('border-red-500');
            return false;
        } else {
            errorElement.style.display = 'none';
            input.classList.remove('border-red-500');
            return true;
        }
    }

    // 生成随机密码（8位，包含字母、数字、特殊符号）
    function generateRandomPassword(length = 8) {
        const letters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz';
        const numbers = '0123456789';
        const allChars = letters + numbers;

        let password = '';
        // 确保至少包含一个字母、一个数字
        password += letters.charAt(Math.floor(Math.random() * letters.length));
        password += numbers.charAt(Math.floor(Math.random() * numbers.length));
        // 填充剩余字符
        for (let i = 2; i < length; i++) {
            password += allChars.charAt(Math.floor(Math.random() * allChars.length));
        }

        // 打乱顺序
        return password.split('').sort(() => Math.random() - 0.5).join('');
    }

    // 生成随机VNC端口，范围5900-6999
    function generateRandomVncPort() {
        return Math.floor(Math.random() * (6999 - 5900 + 1)) + 5900;
    }

    // 为输入框生成随机VNC端口
    function generateRandomVncPortForInput() {
        const randomPort = generateRandomVncPort();
        document.getElementById('editVcPort').value = randomPort;
    }

    // 同步系统密码到VNC密码
    function syncOsPassToVncPass() {
        const osPass = document.getElementById('editOsPass').value;
        document.getElementById('editVcPass').value = osPass;
        // 触发实时验证
        validatePasswordInput('editOsPass', 'editOsPassError');
        validatePasswordInput('editVcPass', 'editVcPassError');
    }

    // 生成编辑模式的随机系统密码，并同步到VNC密码
    function generateEditOsPass() {
        const randomPass = generateRandomPassword(8);
        document.getElementById('editOsPass').value = randomPass;
        document.getElementById('editVcPass').value = randomPass;
        // 触发实时验证
        validatePasswordInput('editOsPass', 'editOsPassError');
        validatePasswordInput('editVcPass', 'editVcPassError');
    }

    // 显示修改密码模态框
    function showChangePasswordModal() {
        document.getElementById('newPassword').value = '';
        document.getElementById('confirmForceShutdownPassword').checked = false;
        document.getElementById('changePasswordModal').showModal();
    }

    // 关闭修改密码模态框
    function closeChangePasswordModal() {
        document.getElementById('changePasswordModal').close();
    }

    // 生成新密码
    function generateNewPassword() {
        const randomPass = generateRandomPassword(8);
        document.getElementById('newPassword').value = randomPass;
        // 触发实时验证
        validatePasswordInput('newPassword', 'newPasswordError');
    }

    // 修改密码表单提交
    document.addEventListener('DOMContentLoaded', function () {
        const changePasswordForm = document.getElementById('changePasswordForm');
        if (changePasswordForm) {
            changePasswordForm.addEventListener('submit', async function (e) {
                e.preventDefault();

                const newPassword = document.getElementById('newPassword').value;
                const confirmCheck = document.getElementById('confirmForceShutdownPassword').checked;

                // 如果按钮是禁用状态，直接返回（说明验证条件未满足）
                const confirmButton = document.getElementById('confirmPasswordChange');
                if (confirmButton.disabled) {
                    return;
                }

                // 触发实时验证并检查是否有错误
                const isValid = validatePasswordInput('newPassword', 'newPasswordError');
                if (!isValid) {
                    // 如果验证失败，不提交表单，错误信息已经在输入框下方显示
                    return;
                }

                // 关闭模态框
                closeChangePasswordModal();

                // 显示保存中状态
                Swal.fire({
                    title: '修改中...',
                    html: '正在修改虚拟机密码',
                    allowOutsideClick: false,
                    allowEscapeKey: false,
                    showConfirmButton: false,
                    didOpen: () => {
                        Swal.showLoading();
                    }
                });

                // 构建密码修改数据
                const passwordData = {
                    password: newPassword
                };

                // 调用密码修改API
                const result = await apiRequest(`/api/client/password/${hostName}/${vmUuid}`, 'POST', passwordData);

                if (result && result.code === 200) {
                    Swal.fire({
                        icon: 'success',
                        title: '修改成功',
                        text: '虚拟机密码已修改',
                        timer: 1500,
                        showConfirmButton: false
                    }).then(() => {
                        location.reload(); // 刷新页面
                    });
                } else {
                    Swal.fire({
                        icon: 'error',
                        title: '修改失败',
                        text: result?.msg || '修改失败，请重试'
                    });
                }
            });
        }
    });

    // 编辑虚拟机 - 直接弹出编辑窗口
    let editNicCounter = 0;
    let pendingEditVmData = null;

    async function openEditVM() {
        // 加载当前虚拟机配置并显示编辑弹窗
        const result = await apiRequest(`/api/client/detail/${hostName}/${vmUuid}`);
        if (result && result.code === 200) {
            const vm = result.data;
            const config = vm.config || {};

            // 填充表单数据
            document.getElementById('editVmUuid').value = vmUuid;

            // 先更新操作系统选项，并传递当前系统名称以正确选中
            updateOsOptions(config.os_name || '');

            document.getElementById('editOsPass').value = config.os_pass || '';
            document.getElementById('editVcPass').value = config.vc_pass || '';
            // VNC端口如果为空则生成随机端口
            const vcPort = config.vc_port || generateRandomVncPort();
            document.getElementById('editVcPort').value = vcPort;
            document.getElementById('editCpuNum').value = config.cpu_num ?? 0;
            document.getElementById('editMemNum').value = config.mem_num ?? 0;
            document.getElementById('editHddNum').value = config.hdd_num ?? 0;
            document.getElementById('editGpuNum').value = config.gpu_num || 0;
            document.getElementById('editGpuMem').value = config.gpu_mem || 0;
            document.getElementById('editSpeedU').value = config.speed_u || 100;
            document.getElementById('editSpeedD').value = config.speed_d || 100;
            document.getElementById('editNatNum').value = config.nat_num || 0;
            document.getElementById('editFluNum').value = config.flu_num || 0;
            document.getElementById('editWebNum').value = config.web_num || 0;

            // 加载网卡配置
            document.getElementById('editNicConfigs').innerHTML = '';
            editNicCounter = 0;
            const nicAll = config.nic_all || {};
            for (const [nicName, nicConfig] of Object.entries(nicAll)) {
                editNicCounter++;
                const nicHtml = `
                    <div class="flex items-center gap-2 p-2 bg-gray-50 rounded-lg" id="edit_nic_${editNicCounter}">
                        <input style="width: 100px" type="text" name="edit_nic_name_${editNicCounter}" value="${nicName}" placeholder="网卡名称"
                            class="flex-1 px-2 py-1 text-sm border border-gray-300 rounded">
                        <select name="edit_nic_type_${editNicCounter}" class="px-2 py-1 text-sm border border-gray-300 rounded">
                            <option value="nat" ${nicConfig.nic_type === 'nat' ? 'selected' : ''}>内网</option>
                            <option value="pub" ${nicConfig.nic_type === 'pub' ? 'selected' : ''}>公网</option>
                        </select>
                <input type="text" style="width: 100px" name="edit_nic_ip_${editNicCounter}" value="${nicConfig.ip4_addr || ''}" placeholder="IPv4地址"
                    class="flex-1 px-2 py-1 text-sm border border-gray-300 rounded">
                <input type="text" name="edit_nic_ip6_${editNicCounter}" value="${nicConfig.ip6_addr || ''}" placeholder="IPv6地址"
                    class="flex-1 px-2 py-1 text-sm border border-gray-300 rounded">
                        <button type="button" onclick="removeEditNicConfig(${editNicCounter})" class="p-1 text-red-500 hover:bg-red-50 rounded">
                            <span class="iconify" data-icon="mdi:close" data-width="16"></span>
                        </button>
                    </div>
                `;
                document.getElementById('editNicConfigs').insertAdjacentHTML('beforeend', nicHtml);
            }

            document.getElementById('vmEditModal').showModal();
        } else {
            showToast(result?.msg || '加载虚拟机配置失败', 'error');
        }
    }

    // 添加网卡配置
    function addEditNicConfig() {
        editNicCounter++;
        const container = document.getElementById('editNicConfigs');

        // 自动生成网卡名称：ethernet0, ethernet1, ethernet2...
        const existingNics = Array.from(container.querySelectorAll('[id^="edit_nic_"]')).map(div => {
            const nameInput = div.querySelector(`[name^="edit_nic_name_"]`);
            return nameInput ? nameInput.value.trim() : '';
        }).filter(name => name);

        let nicIndex = 0;
        let nicName = `ethernet${nicIndex}`;
        while (existingNics.includes(nicName)) {
            nicIndex++;
            nicName = `ethernet${nicIndex}`;
        }

        const nicHtml = `
            <div class="flex items-center gap-2 p-2 bg-gray-50 rounded-lg" id="edit_nic_${editNicCounter}">
                <input type="text" style="width: 100px" name="edit_nic_name_${editNicCounter}" value="${nicName}" placeholder="网卡名称"
                    class="flex-1 px-2 py-1 text-sm border border-gray-300 rounded">
                <select name="edit_nic_type_${editNicCounter}" class="px-2 py-1 text-sm border border-gray-300 rounded">
                    <option value="nat">内网</option>
                    <option value="pub">公网</option>
                </select>
                <input type="text" style="width: 100px" name="edit_nic_ip_${editNicCounter}" placeholder="IPv4地址 (必填)" required
                    class="flex-1 px-2 py-1 text-sm border border-gray-300 rounded">
                <input type="text" name="edit_nic_ip6_${editNicCounter}" placeholder="IPv6地址"
                    class="flex-1 px-2 py-1 text-sm border border-gray-300 rounded">
                <button type="button" onclick="removeEditNicConfig(${editNicCounter})" class="p-1 text-red-500 hover:bg-red-50 rounded">
                    <span class="iconify" data-icon="mdi:close" data-width="16"></span>
                </button>
            </div>
        `;
        container.insertAdjacentHTML('beforeend', nicHtml);
    }

    // 移除网卡配置
    function removeEditNicConfig(id) {
        document.getElementById(`edit_nic_${id}`).remove();
    }

    // 收集编辑表单数据
    function collectEditVmFormData() {
        // 收集网卡配置
        const nicAll = {};
        const nicContainers = document.querySelectorAll('[id^="edit_nic_"]');
        nicContainers.forEach((container) => {
            const nicName = container.querySelector(`[name^="edit_nic_name_"]`).value.trim();
            const nicType = container.querySelector(`[name^="edit_nic_type_"]`).value;
            const nicIp = container.querySelector(`[name^="edit_nic_ip_"]`).value.trim();
            const nicIp6 = container.querySelector(`[name^="edit_nic_ip6_"]`)?.value.trim() || '';

            // 验证：如果有网卡名称，则IPv4地址必填
            if (nicName) {
                if (!nicIp) {
                    throw new Error(`网卡 "${nicName}" 的IPv4地址为必填项`);
                }
                nicAll[nicName] = {
                    nic_type: nicType,
                    ip4_addr: nicIp,
                    ip6_addr: nicIp6
                };
            }
        });

        // 获取密码
        const osPass = document.getElementById('editOsPass').value;
        const vcPass = document.getElementById('editVcPass').value;

        // 验证密码：如果填写了密码，则必须满足要求
        if (osPass) {
            const isOsPassValid = validatePasswordInput('editOsPass', 'editOsPassError');
            if (!isOsPassValid) {
                return null; // 返回null表示验证失败，不提交表单
            }
        }
        if (vcPass) {
            const isVcPassValid = validatePasswordInput('editVcPass', 'editVcPassError');
            if (!isVcPassValid) {
                return null; // 返回null表示验证失败，不提交表单
            }
        }

        // 获取VNC端口，如果为空则生成随机端口
        let vcPort = document.getElementById('editVcPort').value;
        if (!vcPort) {
            vcPort = generateRandomVncPort();
            document.getElementById('editVcPort').value = vcPort;
        }

        return {
            vm_uuid: vmUuid,
            os_name: document.getElementById('editOsName').value,
            os_pass: osPass,
            vc_pass: vcPass,
            vc_port: parseInt(vcPort) || 0,
            cpu_num: parseInt(document.getElementById('editCpuNum').value) || 0,
            mem_num: parseInt(document.getElementById('editMemNum').value) || 0,
            hdd_num: parseInt(document.getElementById('editHddNum').value) || 0,
            gpu_num: parseInt(document.getElementById('editGpuNum').value) || 0,
            gpu_mem: parseInt(document.getElementById('editGpuMem').value) || 0,
            speed_u: parseInt(document.getElementById('editSpeedU').value) || 100,
            speed_d: parseInt(document.getElementById('editSpeedD').value) || 100,
            nat_num: parseInt(document.getElementById('editNatNum').value) || 0,
            flu_num: parseInt(document.getElementById('editFluNum').value) || 0,
            web_num: parseInt(document.getElementById('editWebNum').value) || 0,
            nic_all: nicAll
        };
    }

    // 提交编辑虚拟机表单
    async function submitEditVmForm(vmData) {
        const result = await apiRequest(`/api/client/update/${hostName}/${vmUuid}`, 'PUT', vmData);

        if (result && result.code === 200) {
            // 先关闭弹窗
            document.getElementById('vmEditModal').close();
            // 再显示成功消息
            Swal.fire({
                icon: 'success',
                title: '保存成功',
                text: '虚拟机配置已保存',
                timer: 1500,
                showConfirmButton: false
            }).then(() => {
                location.reload(); // 刷新页面
            });
        } else {
            Swal.fire({
                icon: 'error',
                title: '保存失败',
                text: result?.msg || '保存失败，请重试'
            });
        }
    }

    // 编辑配置保存确认
    let pendingEditSaveCallback = null;

    function confirmEditSave(callback) {
        pendingEditSaveCallback = callback;
        document.getElementById('editConfirmModal').showModal();
    }

    function executeEditSave() {
        document.getElementById('editConfirmModal').close();
        if (pendingEditSaveCallback) {
            pendingEditSaveCallback();
            pendingEditSaveCallback = null;
        }
    }

    // VNC控制台
    async function openVNCConsole() {
        showToast('正在获取VNC控制台地址...', 'info');
        const result = await apiRequest(`/api/client/remote/${hostName}/${vmUuid}`);
        if (result && result.code === 200 && result.data) {
            const vncUrl = result.data;
            if (vncUrl) {
                window.open(vncUrl, '_blank');
            } else {
                showToast('VNC控制台地址为空', 'error');
            }
        } else {
            showToast(result?.msg || '获取VNC控制台失败', 'error');
        }
    }

    // ==================== NAT端口转发 ====================
    async function loadNATRules() {
        const result = await apiRequest(`/api/client/natget/${hostName}/${vmUuid}`);
        if (result && result.code === 200) {
            renderNATRules(result.data || []);
        } else {
            $('#natRulesList').html('<p class="text-center text-gray-500 py-8 text-sm">暂无端口转发规则</p>');
        }
    }

    function renderNATRules(rules) {
        if (!rules || rules.length === 0) {
            $('#natRulesList').html('<p class="text-center text-gray-500 py-8 text-sm">暂无端口转发规则</p>');
            return;
        }

        let html = `
            <div class="overflow-x-auto">
                <table class="table table-sm w-full">
                    <thead>
                        <tr class="bg-gray-50">
                            <th class="text-xs text-gray-600">外网端口</th>
                            <th class="text-xs text-gray-600">内网端口</th>
                            <th class="text-xs text-gray-600">内网地址</th>
                            <th class="text-xs text-gray-600">备注</th>
                            <th class="text-xs text-gray-600">操作</th>
                        </tr>
                    </thead>
                    <tbody>
        `;

        rules.forEach((r, idx) => {
            html += `
                <tr class="hover">
                    <td><code class="text-sm font-mono text-gray-700">${r.wan_port || '-'}</code></td>
                    <td><code class="text-sm font-mono text-gray-700">${r.lan_port || '-'}</code></td>
                    <td><code class="text-sm font-mono text-gray-600">${r.lan_addr || '-'}</code></td>
                    <td class="text-sm text-gray-600">${r.nat_tips || '-'}</td>
                    <td>
                        <button onclick="deleteNATRule(${idx})" class="px-2 py-1 text-xs font-medium text-red-700 bg-red-50 hover:bg-red-100 border border-red-200 rounded transition">删除</button>
                    </td>
                </tr>
            `;
        });

        html += '</tbody></table></div>';
        $('#natRulesList').html(html);
    }

    function showAddNATModal() {
        // 填充IP地址选项
        const ipSelect = $('#natInternalIP');
        ipSelect.html('<option value="">请选择IP地址</option>');

        // 从vmData中获取IP地址列表
        if (vmData && vmData.config) {
            const config = vmData.config;
            const ipList = [];

            // 从ip_all获取IP地址
            if (config.ip_all && Array.isArray(config.ip_all)) {
                config.ip_all.forEach(ip => {
                    if (ip.address) {
                        ipList.push(ip.address);
                    }
                });
            }

            // 从nic_all获取IP地址
            if (config.nic_all && typeof config.nic_all === 'object') {
                Object.values(config.nic_all).forEach(nic => {
                    if (nic.ip4_addr && nic.ip4_addr !== '-') {
                        ipList.push(nic.ip4_addr);
                    }
                    if (nic.ip6_addr && nic.ip6_addr !== '-') {
                        ipList.push(nic.ip6_addr);
                    }
                });
            }

            // 去重并添加到下拉框
            const uniqueIPs = [...new Set(ipList)];
            uniqueIPs.forEach((ip, index) => {
                ipSelect.append(`<option value="${ip}" ${index === 0 ? 'selected' : ''}>${ip}</option>`);
            });
        }

        document.getElementById('addNATModal').showModal();
    }

    function closeNATModal() {
        document.getElementById('addNATModal').close();
        $('#addNATForm')[0].reset();
    }

    async function submitNATRule() {
        const wanPortValue = $('#natExternalPort').val();
        const data = {
            wan_port: wanPortValue ? parseInt(wanPortValue) : 0,  // 留空时传0，由后端自动分配
            lan_port: parseInt($('#natInternalPort').val()),
            lan_addr: $('#natInternalIP').val() || '',
            nat_tips: $('#natDescription').val() || ''
        };

        const result = await apiRequest(`/api/client/natadd/${hostName}/${vmUuid}`, 'POST', data);
        if (result && result.code === 200) {
            showToast('NAT规则添加成功', 'success');
            closeNATModal();
            loadNATRules();
        } else {
            showToast(result?.msg || '添加失败', 'error');
        }
    }

    async function deleteNATRule(index) {
        if (!confirm('确定要删除此NAT规则吗？')) return;

        const result = await apiRequest(`/api/client/natdel/${hostName}/${vmUuid}/${index}`, 'DELETE');
        if (result && result.code === 200) {
            showToast('NAT规则已删除', 'success');
            loadNATRules();
        } else {
            showToast(result?.msg || '删除失败', 'error');
        }
    }

    // ==================== IP地址管理 ====================
    async function loadIPAddresses() {
        const result = await apiRequest(`/api/hosts/${hostName}/vms/${vmUuid}/ip_addresses`);
        if (result && result.code === 200) {
            renderIPAddresses(result.data || []);
        } else {
            $('#ipAddressList').html('<p class="text-center text-gray-500 py-8 text-sm">暂无网卡配置</p>');
        }
    }

    function renderIPAddresses(nics) {
        if (!nics || nics.length === 0) {
            $('#ipAddressList').html('<p class="text-center text-gray-500 py-8 text-sm">暂无网卡配置</p>');
            return;
        }

        let html = '<div class="overflow-x-auto"><table class="min-w-full divide-y divide-gray-200">';
        html += '<thead class="bg-gray-50"><tr>';
        html += '<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">网卡名称</th>';
        html += '<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">MAC地址</th>';
        html += '<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">IPv4地址</th>';
        html += '<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">IPv6地址</th>';
        html += '<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">网关</th>';
        html += '<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">掩码</th>';
        html += '<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">DNS</th>';
        html += '<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">操作</th>';
        html += '</tr></thead><tbody class="bg-white divide-y divide-gray-200">';

        nics.forEach((nic) => {
            const dnsStr = Array.isArray(nic.dns_addr) ? nic.dns_addr.join(', ') : '';
            html += '<tr class="hover:bg-gray-50">';
            html += `<td class="px-4 py-3 text-sm font-medium text-gray-900">${nic.nic_name || '-'}</td>`;
            html += `<td class="px-4 py-3 text-sm font-mono text-gray-600">${nic.mac_addr || '-'}</td>`;
            html += `<td class="px-4 py-3 text-sm font-mono text-gray-600">${nic.ip4_addr || '-'}</td>`;
            html += `<td class="px-4 py-3 text-sm font-mono text-gray-600">${nic.ip6_addr || '-'}</td>`;
            html += `<td class="px-4 py-3 text-sm font-mono text-gray-600">${nic.nic_gate || '-'}</td>`;
            html += `<td class="px-4 py-3 text-sm font-mono text-gray-600">${nic.nic_mask || '-'}</td>`;
            html += `<td class="px-4 py-3 text-sm text-gray-600">${dnsStr || '-'}</td>`;
            html += '<td class="px-4 py-3 text-sm">';
            html += `<button onclick="showEditIPModal('${nic.nic_name}')" class="text-blue-600 hover:text-blue-800 mr-2" title="编辑">`;
            html += '<span class="iconify" data-icon="mdi:pencil" data-width="18"></span></button>';
            html += `<button onclick="deleteIPAddress('${nic.nic_name}')" class="text-red-600 hover:text-red-800" title="删除">`;
            html += '<span class="iconify" data-icon="mdi:delete" data-width="18"></span></button>';
            html += '</td></tr>';
        });

        html += '</tbody></table></div>';
        $('#ipAddressList').html(html);
    }

    function showAddIPModal() {
        $('#addIPForm')[0].reset();
        $('#ipNetmask').val('255.255.255.0'); // 设置默认掩码

        // 加载用户IP配额信息
        loadUserIPQuota();

        document.getElementById('addIPModal').showModal();
    }

    // 加载用户IP配额信息
    async function loadUserIPQuota() {
        try {
            const result = await apiRequest('/api/users/current');
            if (result && result.code === 200) {
                const user = result.data;
                const quotaDetails = document.getElementById('quotaDetails');

                quotaDetails.innerHTML = `
                    <div class="flex justify-between">
                        <span>内网IP配额:</span>
                        <span class="font-mono">${user.used_nat_ips || 0}/${user.quota_nat_ips || 0}</span>
                    </div>
                    <div class="flex justify-between">
                        <span>公网IP配额:</span>
                        <span class="font-mono">${user.used_pub_ips || 0}/${user.quota_pub_ips || 0}</span>
                    </div>
                `;

                // 根据配额情况更新网卡类型选项
                const ipNicType = document.getElementById('ipNicType');
                const natOption = ipNicType.querySelector('option[value="nat"]');
                const pubOption = ipNicType.querySelector('option[value="pub"]');

                // 检查内网IP配额
                if ((user.used_nat_ips || 0) >= (user.quota_nat_ips || 0)) {
                    natOption.disabled = true;
                    natOption.textContent = '内网(NAT) - 配额已用完';
                } else {
                    natOption.disabled = false;
                    natOption.textContent = '内网(NAT)';
                }

                // 检查公网IP配额
                if ((user.used_pub_ips || 0) >= (user.quota_pub_ips || 0)) {
                    pubOption.disabled = true;
                    pubOption.textContent = '公网(Public) - 配额已用完';
                } else {
                    pubOption.disabled = false;
                    pubOption.textContent = '公网(Public)';
                }

                // 如果当前选中的类型配额已用完，选择可用的类型
                if (ipNicType.value === 'nat' && natOption.disabled) {
                    ipNicType.value = 'pub';
                } else if (ipNicType.value === 'pub' && pubOption.disabled) {
                    ipNicType.value = 'nat';
                }
            }
        } catch (error) {
            console.error('加载用户配额失败:', error);
            document.getElementById('quotaDetails').innerHTML = '<div class="text-red-500">配额信息加载失败</div>';
        }
    }

    function closeIPModal() {
        document.getElementById('addIPModal').close();
        $('#addIPForm')[0].reset();
    }

    // 更新网卡类型提示
    function updateNicTypeHint() {
        const ipNicType = document.getElementById('ipNicType');
        const nicTypeHint = document.getElementById('nicTypeHint');
        const selectedOption = ipNicType.options[ipNicType.selectedIndex];

        if (selectedOption.disabled) {
            nicTypeHint.textContent = selectedOption.textContent;
            nicTypeHint.className = 'text-xs text-red-500 mt-1';
        } else {
            const type = ipNicType.value;
            if (type === 'nat') {
                nicTypeHint.textContent = '内网IP，用于虚拟机内部网络通信';
                nicTypeHint.className = 'text-xs text-gray-500 mt-1';
            } else if (type === 'pub') {
                nicTypeHint.textContent = '公网IP，用于外部网络访问';
                nicTypeHint.className = 'text-xs text-gray-500 mt-1';
            }
        }
    }

    async function submitIPAddress() {
        const data = {
            nic_type: $('#ipNicType').val(),
            ip4_addr: $('#ipAddress').val() || '',
            ip6_addr: $('#ipAddress6').val() || '',
            nic_gate: $('#ipGateway').val() || '',
            nic_mask: $('#ipNetmask').val() || '255.255.255.0'
        };

        // 先关闭模态框
        closeIPModal();

        // 显示加载动画
        Swal.fire({
            title: '正在添加网卡',
            text: '请稍候...',
            icon: 'info',
            allowOutsideClick: false,
            allowEscapeKey: false,
            showConfirmButton: false,
            didOpen: () => {
                Swal.showLoading();
            }
        });

        const result = await apiRequest(`/api/hosts/${hostName}/vms/${vmUuid}/ip_addresses`, 'POST', data);

        if (result && result.code === 200) {
            // 添加成功
            Swal.fire({
                title: '添加成功',
                text: '网卡已成功添加',
                icon: 'success',
                timer: 1500,
                showConfirmButton: false
            });
            // 延迟刷新，确保数据库已保存
            setTimeout(() => {
                loadIPAddresses();
                loadVMInfo(); // 刷新虚拟机信息
            }, 500);
        } else {
            // 添加失败
            Swal.fire({
                title: '添加失败',
                text: result?.msg || '添加网卡失败，请稍后重试',
                icon: 'error',
                confirmButtonText: '确定'
            });
        }
    }

    function showEditIPModal(nicName) {
        // 从当前列表中找到对应的网卡信息
        apiRequest(`/api/hosts/${hostName}/vms/${vmUuid}/ip_addresses`).then(result => {
            if (result && result.code === 200) {
                const nic = result.data.find(n => n.nic_name === nicName);
                if (nic) {
                    // 填充编辑表单
                    $('#editNicName').val(nic.nic_name);
                    $('#editNicNameDisplay').val(nic.nic_name);
                    $('#editIpAddress').val(nic.ip4_addr || '');
                    $('#editIpAddress6').val(nic.ip6_addr || '');
                    $('#editIpGateway').val(nic.nic_gate || '');
                    $('#editIpNetmask').val(nic.nic_mask || '255.255.255.0');
                    document.getElementById('editIPModal').showModal();
                }
            }
        });
    }

    function closeEditIPModal() {
        document.getElementById('editIPModal').close();
        $('#editIPForm')[0].reset();
    }

    async function submitEditIPAddress() {
        const nicName = $('#editNicName').val();
        const data = {
            ip4_addr: $('#editIpAddress').val() || '',
            ip6_addr: $('#editIpAddress6').val() || '',
            nic_gate: $('#editIpGateway').val() || '',
            nic_mask: $('#editIpNetmask').val() || '255.255.255.0'
        };

        // 先关闭模态框
        closeEditIPModal();

        // 显示加载动画
        Swal.fire({
            title: '正在更新网卡配置',
            text: '请稍候...',
            icon: 'info',
            allowOutsideClick: false,
            allowEscapeKey: false,
            showConfirmButton: false,
            didOpen: () => {
                Swal.showLoading();
            }
        });

        const result = await apiRequest(`/api/hosts/${hostName}/vms/${vmUuid}/ip_addresses/${nicName}`, 'PUT', data);

        if (result && result.code === 200) {
            // 更新成功
            Swal.fire({
                title: '更新成功',
                text: '网卡配置已成功更新',
                icon: 'success',
                timer: 1500,
                showConfirmButton: false
            });
            // 延迟刷新，确保数据库已保存
            setTimeout(() => {
                loadIPAddresses();
                loadVMInfo(); // 刷新虚拟机信息
            }, 500);
        } else {
            // 更新失败
            Swal.fire({
                title: '更新失败',
                text: result?.msg || '更新网卡配置失败，请稍后重试',
                icon: 'error',
                confirmButtonText: '确定'
            });
        }
    }

    async function deleteIPAddress(nicName) {
        // 使用SweetAlert2确认对话框
        const confirmResult = await Swal.fire({
            title: '确认删除',
            text: `确定要删除网卡 "${nicName}" 吗？`,
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#d33',
            cancelButtonColor: '#6b7280',
            confirmButtonText: '确定删除',
            cancelButtonText: '取消'
        });

        if (!confirmResult.isConfirmed) return;

        // 显示加载动画
        Swal.fire({
            title: '正在删除网卡',
            text: '请稍候...',
            icon: 'info',
            allowOutsideClick: false,
            allowEscapeKey: false,
            showConfirmButton: false,
            didOpen: () => {
                Swal.showLoading();
            }
        });

        const result = await apiRequest(`/api/hosts/${hostName}/vms/${vmUuid}/ip_addresses/${nicName}`, 'DELETE');

        if (result && result.code === 200) {
            // 删除成功
            Swal.fire({
                title: '删除成功',
                text: `网卡 "${nicName}" 已成功删除`,
                icon: 'success',
                timer: 1500,
                showConfirmButton: false
            });
            // 延迟刷新，确保数据库已保存
            setTimeout(() => {
                loadIPAddresses();
                loadVMInfo(); // 刷新虚拟机信息
            }, 500);
        } else {
            // 删除失败
            Swal.fire({
                title: '删除失败',
                text: result?.msg || '删除网卡失败，请稍后重试',
                icon: 'error',
                confirmButtonText: '确定'
            });
        }
    }

    // ==================== 反向代理 ====================
    async function loadProxyConfigs() {
        const result = await apiRequest(`/api/client/proxys/detail/${hostName}/${vmUuid}`);
        if (result && result.code === 200) {
            renderProxyConfigs(result.data || []);
        } else {
            $('#proxyList').html('<p class="text-center text-gray-500 py-8 text-sm">暂无反向代理配置</p>');
        }
    }

    function renderProxyConfigs(proxies) {
        if (!proxies || proxies.length === 0) {
            $('#proxyList').html('<p class="text-center text-gray-500 py-8 text-sm">暂无反向代理配置</p>');
            return;
        }

        let html = '<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">';

        proxies.forEach((p, idx) => {
            const sslEnabled = p.ssl_enabled || false;
            html += `
                <div class="bg-white border border-gray-200 rounded-lg p-4 hover:border-purple-300 hover:shadow-md transition-all">
                    <div class="flex items-center justify-between mb-3">
                        <span class="px-2 py-0.5 text-xs font-medium ${sslEnabled ? 'text-green-700 bg-green-100' : 'text-gray-600 bg-gray-100'} rounded">
                            ${sslEnabled ? 'HTTPS' : 'HTTP'}
                        </span>
                        <button onclick="deleteProxyConfig(${idx})" class="p-1 text-red-500 hover:bg-red-50 rounded">
                            <span class="iconify" data-icon="mdi:delete" data-width="18"></span>
                        </button>
                    </div>
                    <div class="bg-gray-50 rounded-lg p-3 mb-2">
                        <p class="text-xs text-gray-500">域名</p>
                        <code class="text-sm font-mono text-gray-800 break-all">${p.domain}</code>
                    </div>
                    <div class="flex items-center justify-between text-xs">
                        <span class="text-gray-500">后端</span>
                        <code class="px-2 py-0.5 font-medium font-mono text-gray-700 bg-gray-100 rounded">${p.backend_ip || '默认'}:${p.backend_port}</code>
                    </div>
                    ${p.description ? `<p class="text-xs text-gray-500 mt-2">${p.description}</p>` : ''}
                </div>
            `;
        });

        html += '</div>';
        $('#proxyList').html(html);
    }

    async function showAddProxyModal() {
        // 加载虚拟机网卡地址列表
        loadVMNetworkInterfaces();
        document.getElementById('addProxyModal').showModal();
    }

    // 加载虚拟机网卡地址列表
    function loadVMNetworkInterfaces() {
        const ipSelect = $('#proxyBackendIP');
        ipSelect.html('<option value="">请选择网卡地址</option>');

        // 从vmData中获取IP地址列表
        if (vmData && vmData.config) {
            const config = vmData.config;
            const ipList = [];

            // 从ip_all获取IP地址
            if (config.ip_all && Array.isArray(config.ip_all)) {
                config.ip_all.forEach(ip => {
                    if (ip.address) {
                        ipList.push(ip.address);
                    }
                });
            }

            // 从nic_all获取IP地址
            if (config.nic_all && typeof config.nic_all === 'object') {
                Object.values(config.nic_all).forEach(nic => {
                    if (nic.ip4_addr && nic.ip4_addr !== '-') {
                        ipList.push(nic.ip4_addr);
                    }
                });
            }

            // 去重并添加到下拉框
            const uniqueIPs = [...new Set(ipList)];
            uniqueIPs.forEach((ip, index) => {
                ipSelect.append(`<option value="${ip}" ${index === 0 ? 'selected' : ''}>${ip}</option>`);
            });
        }
    }

    function closeProxyModal() {
        document.getElementById('addProxyModal').close();
        $('#addProxyForm')[0].reset();
        $('#sslOptions').hide();
        $('#customCertFields').hide();
    }

    async function submitProxyConfig() {
        const sslEnabled = $('#proxySSLEnabled').is(':checked');
        const sslType = $('#proxySSLType').val();
        const backendIP = $('#proxyBackendIP').val();

        // 验证后端IP必须选择
        if (!backendIP) {
            showToast('请选择后端IP地址', 'error');
            return;
        }

        const data = {
            domain: $('#proxyDomain').val(),
            backend_ip: backendIP,
            backend_port: parseInt($('#proxyBackendPort').val()),
            ssl_enabled: sslEnabled,
            ssl_type: sslEnabled ? sslType : '',
            ssl_cert: sslEnabled && sslType === 'custom' ? $('#proxySSLCert').val() : '',
            ssl_key: sslEnabled && sslType === 'custom' ? $('#proxySSLKey').val() : '',
            description: $('#proxyDescription').val() || ''
        };

        const result = await apiRequest(`/api/client/proxys/create/${hostName}/${vmUuid}`, 'POST', data);
        if (result && result.code === 200) {
            showToast('代理配置添加成功', 'success');
            closeProxyModal();
            loadProxyConfigs();
        } else {
            showToast(result?.msg || '添加失败', 'error');
        }
    }

    async function deleteProxyConfig(index) {
        if (!confirm('确定要删除此代理配置吗？')) return;

        const result = await apiRequest(`/api/client/proxys/delete/${hostName}/${vmUuid}/${index}`, 'DELETE');
        if (result && result.code === 200) {
            showToast('代理配置已删除', 'success');
            loadProxyConfigs();
        } else {
            showToast(result?.msg || '删除失败', 'error');
        }
    }

    // ==================== 数据盘管理 ====================
    async function loadHDDList() {
        const result = await apiRequest(`/api/client/detail/${hostName}/${vmUuid}`);
        if (result && result.code === 200 && result.data && result.data.config) {
            const hddAll = result.data.config.hdd_all || {};
            renderHDDList(hddAll);
        } else {
            $('#hddList').html('<p class="text-center text-gray-500 py-8 text-sm">暂无数据盘</p>');
        }
    }

    function renderHDDList(hddAll) {
        if (!hddAll || Object.keys(hddAll).length === 0) {
            $('#hddList').html('<p class="text-center text-gray-500 py-8 text-sm">暂无数据盘</p>');
            return;
        }

        let html = '<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">';

        Object.entries(hddAll).forEach(([hddName, hdd]) => {
            const sizeGB = (hdd.hdd_size / 1024).toFixed(1);
            const typeText = hdd.hdd_type === 1 ? 'SSD' : 'HDD';
            const isMounted = hdd.hdd_flag === 1;
            const mountStatusBadge = isMounted
                ? '<span class="px-2 py-0.5 text-xs font-medium text-green-700 bg-green-100 rounded">已挂载</span>'
                : '<span class="px-2 py-0.5 text-xs font-medium text-gray-700 bg-gray-100 rounded">未挂载</span>';

            // 根据挂载状态显示不同的操作按钮
            let actionButtons = '';
            if (isMounted) {
                // 已挂载：显示卸载、删除按钮
                actionButtons = `
                    <button onclick="showUnmountHDDConfirmModal('${hddName}')" class="p-1 text-orange-500 hover:bg-orange-50 rounded" title="卸载">
                        <span class="iconify" data-icon="mdi:eject" data-width="18"></span>
                    </button>
                    <button onclick="showDeleteHDDConfirmModal('${hddName}')" class="p-1 text-red-500 hover:bg-red-50 rounded" title="删除">
                        <span class="iconify" data-icon="mdi:delete" data-width="18"></span>
                    </button>
                `;
            } else {
                // 未挂载：显示挂载、移交、删除按钮
                actionButtons = `
                    <button onclick="showMountHDDConfirmModal('${hddName}', ${hdd.hdd_size}, ${hdd.hdd_type})" class="p-1 text-green-500 hover:bg-green-50 rounded" title="挂载">
                        <span class="iconify" data-icon="mdi:harddisk-plus" data-width="18"></span>
                    </button>
                    <button onclick="showTransferHDDConfirmModal('${hddName}')" class="p-1 text-blue-500 hover:bg-blue-50 rounded" title="移交">
                        <span class="iconify" data-icon="mdi:swap-horizontal" data-width="18"></span>
                    </button>
                    <button onclick="showDeleteHDDConfirmModal('${hddName}')" class="p-1 text-red-500 hover:bg-red-50 rounded" title="删除">
                        <span class="iconify" data-icon="mdi:delete" data-width="18"></span>
                    </button>
                `;
            }

            html += `
                <div class="bg-white border border-gray-200 rounded-lg p-4 hover:border-purple-300 hover:shadow-md transition-all">
                    <div class="flex items-center justify-between mb-3">
                        <div class="flex gap-2">
                            <span class="px-2 py-0.5 text-xs font-medium text-blue-700 bg-blue-100 rounded">
                                ${typeText}
                            </span>
                            ${mountStatusBadge}
                        </div>
                        <div class="flex gap-1">
                            ${actionButtons}
                        </div>
                    </div>
                    <div class="bg-gray-50 rounded-lg p-3 mb-2">
                        <p class="text-xs text-gray-500">磁盘名称</p>
                        <code class="text-sm font-mono text-gray-800 break-all">${hddName}</code>
                    </div>
                    <div class="flex items-center justify-between text-xs">
                        <span class="text-gray-500">容量</span>
                        <code class="px-2 py-0.5 font-medium font-mono text-gray-700 bg-gray-100 rounded">${sizeGB} GB</code>
                    </div>
                </div>
            `;
        });

        html += '</div>';
        $('#hddList').html(html);
    }

    function showAddHDDModal() {
        $('#addHDDForm')[0].reset();
        document.getElementById('addHDDModal').showModal();
    }

    function closeHDDModal() {
        document.getElementById('addHDDModal').close();
        $('#addHDDForm')[0].reset();
        // 清除错误提示
        document.getElementById('hddNameError').style.display = 'none';
    }

    // 验证磁盘名称：只能包含数字和字母
    function validateHDDName(input) {
        const value = input.value;
        const errorElement = document.getElementById('hddNameError');
        const regex = /^[a-zA-Z0-9_]+$/; // 只允许字母、数字和下划线

        if (value && !regex.test(value)) {
            errorElement.textContent = '磁盘名称只能包含数字、字母和下划线';
            errorElement.style.display = 'block';
            input.setCustomValidity('磁盘名称只能包含数字、字母和下划线');
        } else {
            errorElement.style.display = 'none';
            input.setCustomValidity('');
        }
    }

    async function submitHDD() {
        const hddName = $('#hddName').val();
        const hddSize = parseInt($('#hddSize').val());
        const hddType = parseInt($('#hddType').val());

        // 验证磁盘名称
        const regex = /^[a-zA-Z0-9_]+$/;
        if (!regex.test(hddName)) {
            Swal.fire({
                title: '磁盘名称格式错误',
                text: '磁盘名称只能包含数字、字母和下划线，不能包含特殊符号和中文',
                icon: 'error',
                confirmButtonText: '确定'
            });
            return;
        }

        // 关闭添加模态框
        closeHDDModal();

        // 显示挂载确认模态框
        showMountHDDConfirmModal(hddName, hddSize, hddType);
    }

    // 显示挂载确认模态框
    function showMountHDDConfirmModal(hddName, hddSize, hddType) {
        const vmName = vmData?.name || vmUuid;
        document.getElementById('mountVmName').textContent = vmName;
        document.getElementById('mountHddName').textContent = hddName;

        // 重置确认勾选框
        document.getElementById('mountConfirmCheck').checked = false;
        document.getElementById('executeMountBtn').disabled = true;

        // 保存磁盘信息到全局变量
        window.currentMountHddData = {hdd_name: hddName, hdd_size: hddSize, hdd_type: hddType};

        // 显示模态框
        document.getElementById('mountHDDConfirmModal').showModal();
    }

    function closeMountHDDConfirmModal() {
        document.getElementById('mountHDDConfirmModal').close();
        window.currentMountHddData = null;
    }

    function toggleMountConfirmButton() {
        const check = document.getElementById('mountConfirmCheck');
        const confirmBtn = document.getElementById('executeMountBtn');
        confirmBtn.disabled = !check.checked;
    }

    async function executeMountHDD() {
        const data = window.currentMountHddData;
        if (!data) return;

        // 关闭模态框
        closeMountHDDConfirmModal();

        // 显示进度提示
        Swal.fire({
            title: '正在挂载数据盘',
            text: '数据盘正在挂载中，请稍候...',
            icon: 'info',
            allowOutsideClick: false,
            allowEscapeKey: false,
            showConfirmButton: false,
            didOpen: () => {
                Swal.showLoading();
            }
        });

        const result = await apiRequest(`/api/client/hdd/mount/${hostName}/${vmUuid}`, 'POST', data);
        if (result && result.code === 200) {
            Swal.fire({
                title: '挂载成功',
                text: '数据盘已成功挂载！',
                icon: 'success',
                timer: 2000,
                showConfirmButton: false
            });
            setTimeout(() => {
                loadHDDList();
            }, 2000);
        } else {
            Swal.fire({
                title: '挂载失败',
                text: result?.msg || '挂载数据盘失败，请稍后重试',
                icon: 'error',
                confirmButtonText: '确定'
            });
        }
    }

    // 显示卸载确认模态框
    function showUnmountHDDConfirmModal(hddName) {
        document.getElementById('unmountHddName').textContent = hddName;

        // 重置确认勾选框
        document.getElementById('unmountConfirmCheck').checked = false;
        document.getElementById('executeUnmountBtn').disabled = true;

        // 保存磁盘名称到全局变量
        window.currentUnmountHddName = hddName;

        // 显示模态框
        document.getElementById('unmountHDDConfirmModal').showModal();
    }

    function closeUnmountHDDConfirmModal() {
        document.getElementById('unmountHDDConfirmModal').close();
        window.currentUnmountHddName = null;
    }

    function toggleUnmountConfirmButton() {
        const check = document.getElementById('unmountConfirmCheck');
        const confirmBtn = document.getElementById('executeUnmountBtn');
        confirmBtn.disabled = !check.checked;
    }

    async function executeUnmountHDD() {
        const hddName = window.currentUnmountHddName;
        if (!hddName) return;

        // 关闭模态框
        closeUnmountHDDConfirmModal();

        // 显示进度提示
        Swal.fire({
            title: '正在卸载数据盘',
            text: '数据盘正在卸载中，请稍候...',
            icon: 'info',
            allowOutsideClick: false,
            allowEscapeKey: false,
            showConfirmButton: false,
            didOpen: () => {
                Swal.showLoading();
            }
        });

        const result = await apiRequest(`/api/client/hdd/unmount/${hostName}/${vmUuid}`, 'POST', {hdd_name: hddName});
        if (result && result.code === 200) {
            Swal.fire({
                title: '卸载成功',
                text: '数据盘已成功卸载！',
                icon: 'success',
                timer: 2000,
                showConfirmButton: false
            });
            setTimeout(() => {
                loadHDDList();
            }, 2000);
        } else {
            Swal.fire({
                title: '卸载失败',
                text: result?.msg || '卸载数据盘失败，请稍后重试',
                icon: 'error',
                confirmButtonText: '确定'
            });
        }
    }

    // 显示移交确认模态框
    function showTransferHDDConfirmModal(hddName) {
        document.getElementById('transferHddName').textContent = hddName;
        document.getElementById('transferTargetVM').value = '';

        // 重置确认勾选框
        document.getElementById('transferConfirmCheck').checked = false;
        document.getElementById('executeTransferBtn').disabled = true;

        // 保存磁盘名称到全局变量
        window.currentTransferHddName = hddName;

        // 显示模态框
        document.getElementById('transferHDDConfirmModal').showModal();
    }

    function closeTransferHDDConfirmModal() {
        document.getElementById('transferHDDConfirmModal').close();
        document.getElementById('transferTargetVM').value = '';
        window.currentTransferHddName = null;
    }

    function toggleTransferConfirmButton() {
        const check = document.getElementById('transferConfirmCheck');
        const confirmBtn = document.getElementById('executeTransferBtn');
        confirmBtn.disabled = !check.checked;
    }

    async function executeTransferHDD() {
        const hddName = window.currentTransferHddName;
        const targetVM = document.getElementById('transferTargetVM').value;

        if (!hddName || !targetVM) {
            Swal.fire({
                title: '请输入目标虚拟机',
                text: '请输入目标虚拟机UUID',
                icon: 'warning',
                confirmButtonText: '确定'
            });
            return;
        }

        // 关闭模态框
        closeTransferHDDConfirmModal();

        // 显示进度提示
        Swal.fire({
            title: '正在移交数据盘',
            text: '数据盘正在移交中，请稍候...',
            icon: 'info',
            allowOutsideClick: false,
            allowEscapeKey: false,
            showConfirmButton: false,
            didOpen: () => {
                Swal.showLoading();
            }
        });

        const data = {
            hdd_name: hddName,
            target_vm: targetVM
        };

        const result = await apiRequest(`/api/client/hdd/transfer/${hostName}/${vmUuid}`, 'POST', data);
        if (result && result.code === 200) {
            Swal.fire({
                title: '移交成功',
                text: '数据盘已成功移交！页面将自动刷新。',
                icon: 'success',
                timer: 2000,
                showConfirmButton: false
            });
            // 移交成功后刷新页面
            setTimeout(() => {
                location.reload();
            }, 2000);
        } else {
            Swal.fire({
                title: '移交失败',
                text: result?.msg || '移交数据盘失败，请稍后重试',
                icon: 'error',
                confirmButtonText: '确定'
            });
        }
    }

    // 显示删除确认模态框
    function showDeleteHDDConfirmModal(hddName) {
        document.getElementById('deleteHddName').textContent = hddName;

        // 重置确认勾选框
        document.getElementById('deleteConfirmCheck').checked = false;
        document.getElementById('executeDeleteBtn').disabled = true;

        // 保存磁盘名称到全局变量
        window.currentDeleteHddName = hddName;

        // 显示模态框
        document.getElementById('deleteHDDConfirmModal').showModal();
    }

    function closeDeleteHDDConfirmModal() {
        document.getElementById('deleteHDDConfirmModal').close();
        window.currentDeleteHddName = null;
    }

    function toggleDeleteConfirmButton() {
        const check = document.getElementById('deleteConfirmCheck');
        const confirmBtn = document.getElementById('executeDeleteBtn');
        confirmBtn.disabled = !check.checked;
    }

    async function executeDeleteHDD() {
        const hddName = window.currentDeleteHddName;
        if (!hddName) return;

        // 关闭模态框
        closeDeleteHDDConfirmModal();

        // 显示进度提示
        Swal.fire({
            title: '正在删除数据盘',
            text: '数据盘正在删除中，请稍候...',
            icon: 'info',
            allowOutsideClick: false,
            allowEscapeKey: false,
            showConfirmButton: false,
            didOpen: () => {
                Swal.showLoading();
            }
        });

        const result = await apiRequest(`/api/client/hdd/delete/${hostName}/${vmUuid}`, 'DELETE', {hdd_name: hddName});
        if (result && result.code === 200) {
            Swal.fire({
                title: '删除成功',
                text: '数据盘已成功删除！',
                icon: 'success',
                timer: 2000,
                showConfirmButton: false
            });
            setTimeout(() => {
                loadHDDList();
            }, 2000);
        } else {
            Swal.fire({
                title: '删除失败',
                text: result?.msg || '删除数据盘失败，请稍后重试',
                icon: 'error',
                confirmButtonText: '确定'
            });
        }
    }

    // ==================== ISO管理 ====================
    async function loadISOList() {
        const result = await apiRequest(`/api/client/detail/${hostName}/${vmUuid}`);
        if (result && result.code === 200 && result.data && result.data.config) {
            const isoAll = result.data.config.iso_all || [];
            renderISOList(isoAll);
        } else {
            $('#isoList').html('<p class="text-center text-gray-500 py-8 text-sm">暂无ISO挂载</p>');
        }
    }

    function renderISOList(isoAll) {
        if (!isoAll || Object.keys(isoAll).length === 0) {
            $('#isoList').html('<p class="text-center text-gray-500 py-8 text-sm">暂无ISO挂载</p>');
            return;
        }

        let html = '<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">';

        // isoAll现在是字典，遍历键值对
        Object.entries(isoAll).forEach(([isoName, iso]) => {
            html += `
                <div class="bg-white border border-gray-200 rounded-lg p-4 hover:border-purple-300 hover:shadow-md transition-all">
                    <div class="flex items-center justify-between mb-3">
                        <span class="px-2 py-0.5 text-xs font-medium text-green-700 bg-green-100 rounded">
                            ISO
                        </span>
                        <button onclick="showUnmountISOConfirmModal('${isoName}')" class="p-1 text-red-500 hover:bg-red-50 rounded" title="卸载">
                            <span class="iconify" data-icon="mdi:eject" data-width="18"></span>
                        </button>
                    </div>
                    <div class="space-y-2">
                        <div class="bg-gray-50 rounded-lg p-3">
                            <p class="text-xs text-gray-500 mb-1">挂载名称</p>
                            <code class="text-sm font-mono text-gray-800 break-all">${iso.iso_name || '-'}</code>
                        </div>
                        <div class="bg-gray-50 rounded-lg p-3">
                            <p class="text-xs text-gray-500 mb-1">文件名</p>
                            <code class="text-sm font-mono text-gray-800 break-all">${iso.iso_file || '-'}</code>
                        </div>
                        ${iso.iso_hint ? `
                        <div class="bg-blue-50 rounded-lg p-3">
                            <p class="text-xs text-gray-500 mb-1">备注</p>
                            <p class="text-sm text-gray-700">${iso.iso_hint}</p>
                        </div>
                        ` : ''}
                    </div>
                </div>
            `;
        });

        html += '</div>';
        $('#isoList').html(html);
    }

    async function showAddISOModal() {
        $('#addISOForm')[0].reset();
        $('#isoMountConfirmCheck').prop('checked', false);
        toggleIsoMountConfirmButton();

        // 加载可用的ISO镜像列表
        const result = await apiRequest(`/api/client/os-images/${hostName}`);
        if (result && result.code === 200 && result.data) {
            const imagesMaps = result.data.images_maps || {};
            const selectHtml = '<option value="">请选择ISO镜像文件</option>' +
                Object.entries(imagesMaps).map(([displayName, fileName]) =>
                    `<option value="${fileName}">${displayName} (${fileName})</option>`
                ).join('');
            $('#isoFileSelect').html(selectHtml);
        }

        document.getElementById('addISOModal').showModal();
    }

    function closeISOModal() {
        document.getElementById('addISOModal').close();
        $('#addISOForm')[0].reset();
    }

    async function submitISO() {
        const isoFile = $('#isoFileSelect').val();
        const isoName = $('#isoName').val().trim();
        const isoHint = $('#isoHint').val().trim();

        if (!isoFile) {
            showToast('请选择ISO镜像文件', 'error');
            return;
        }

        if (!isoName) {
            showToast('请输入挂载名称', 'error');
            return;
        }

        // 验证挂载名称格式（只能包含英文和数字）
        if (!/^[a-zA-Z0-9_]+$/.test(isoName)) {
            showToast('挂载名称只能包含英文字母、数字和下划线', 'error');
            return;
        }

        const data = {
            iso_name: isoName,
            iso_file: isoFile,
            iso_hint: isoHint
        };

        closeISOModal();

        // 显示进度提示
        Swal.fire({
            title: '正在挂载ISO',
            text: '请稍候...',
            allowOutsideClick: false,
            didOpen: () => {
                Swal.showLoading();
            }
        });

        const result = await apiRequest(`/api/client/iso/mount/${hostName}/${vmUuid}`, 'POST', data);

        if (result && result.code === 200) {
            Swal.fire({
                title: '挂载成功',
                text: 'ISO镜像已成功挂载',
                icon: 'success',
                timer: 2000,
                showConfirmButton: false
            });
            loadISOList();
        } else {
            Swal.fire({
                title: '挂载失败',
                text: result?.msg || '挂载失败，请稍后重试',
                icon: 'error'
            });
        }
    }

    // ISO卸载确认流程
    let currentUnmountIsoName = '';

    function showUnmountISOConfirmModal(isoName) {
        currentUnmountIsoName = isoName;
        $('#unmountIsoName').text(isoName);
        $('#unmountIsoConfirmCheck').prop('checked', false);
        toggleUnmountIsoConfirmButton();
        document.getElementById('unmountISOConfirmModal').showModal();
    }

    function closeUnmountISOConfirmModal() {
        document.getElementById('unmountISOConfirmModal').close();
        currentUnmountIsoName = '';
        $('#unmountIsoConfirmCheck').prop('checked', false);
    }

    function toggleUnmountIsoConfirmButton() {
        const isChecked = $('#unmountIsoConfirmCheck').is(':checked');
        $('#executeUnmountIsoBtn').prop('disabled', !isChecked);
    }

    async function executeUnmountISO() {
        if (!currentUnmountIsoName) return;

        // 保存ISO名称，避免在关闭模态框时被清空
        const isoNameToUnmount = currentUnmountIsoName;
        closeUnmountISOConfirmModal();

        // 显示进度提示
        Swal.fire({
            title: '正在卸载ISO',
            text: '请稍候...',
            allowOutsideClick: false,
            didOpen: () => {
                Swal.showLoading();
            }
        });

        const result = await apiRequest(`/api/client/iso/unmount/${hostName}/${vmUuid}/${isoNameToUnmount}`, 'DELETE');

        if (result && result.code === 200) {
            Swal.fire({
                title: '卸载成功',
                text: 'ISO镜像已成功卸载',
                icon: 'success',
                timer: 2000,
                showConfirmButton: false
            });
            loadISOList();
        } else {
            Swal.fire({
                title: '卸载失败',
                text: result?.msg || '卸载失败，请稍后重试',
                icon: 'error'
            });
        }
    }

    // ISO挂载确认按钮切换
    function toggleIsoMountConfirmButton() {
        const isChecked = $('#isoMountConfirmCheck').is(':checked');
        $('#confirmIsoMountBtn').prop('disabled', !isChecked);
    }

    // ==================== 备份管理 ====================
    async function loadBackupList() {
        const result = await apiRequest(`/api/client/detail/${hostName}/${vmUuid}`);
        if (result && result.code === 200 && result.data && result.data.config) {
            const backups = result.data.config.backups || [];
            renderBackupList(backups);
        } else {
            $('#backupList').html('<p class="text-center text-gray-500 py-8 text-sm">暂无备份</p>');
        }
    }

    function renderBackupList(backups) {
        if (!backups || backups.length === 0) {
            $('#backupList').html('<p class="text-center text-gray-500 py-8 text-sm">暂无备份</p>');
            return;
        }

        let html = '<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">';

        backups.forEach((backup, idx) => {
            const backupDate = backup.backup_time ? new Date(backup.backup_time * 1000).toLocaleString('zh-CN') : '未知时间';
            const backupHint = backup.backup_hint || '';
            html += `
                <div class="bg-white border border-gray-200 rounded-lg p-4 hover:border-purple-300 hover:shadow-md transition-all">
                    <div class="flex items-center justify-between mb-3">
                        <span class="px-2 py-0.5 text-xs font-medium text-purple-700 bg-purple-100 rounded">
                            备份
                        </span>
                        <div class="flex gap-1">
                            <button onclick="restoreBackup('${backup.backup_name}')" class="p-1 text-blue-500 hover:bg-blue-50 rounded" title="还原">
                                <span class="iconify" data-icon="mdi:restore" data-width="18"></span>
                            </button>
                            <button onclick="deleteBackup('${backup.backup_name}')" class="p-1 text-red-500 hover:bg-red-50 rounded" title="删除">
                                <span class="iconify" data-icon="mdi:delete" data-width="18"></span>
                            </button>
                        </div>
                    </div>
                    <div class="bg-gray-50 rounded-lg p-3 mb-2">
                        <p class="text-xs text-gray-500 mb-1">备份名称</p>
                        <code class="text-sm font-mono text-gray-800 break-all">${backup.backup_name || '-'}</code>
                    </div>
                    ${backupHint ? `
                    <div class="mb-2">
                        <p class="text-xs text-gray-500 mb-1">备份注释</p>
                        <p class="text-sm text-gray-700">${backupHint}</p>
                    </div>
                    ` : ''}
                    <div class="text-xs text-gray-500">
                        <span class="iconify inline" data-icon="mdi:clock-outline" data-width="14"></span>
                        ${backupDate}
                    </div>
                </div>
            `;
        });

        html += '</div>';
        $('#backupList').html(html);
    }

    function showCreateBackupModal() {
        $('#createBackupForm')[0].reset();
        document.getElementById('backupConfirmCheck').checked = false;
        document.getElementById('confirmBackupBtn').disabled = true;
        document.getElementById('createBackupModal').showModal();
    }

    function closeCreateBackupModal() {
        document.getElementById('createBackupModal').close();
        $('#createBackupForm')[0].reset();
    }

    function toggleBackupConfirmButton() {
        const confirmCheck = document.getElementById('backupConfirmCheck');
        const confirmBtn = document.getElementById('confirmBackupBtn');
        confirmBtn.disabled = !confirmCheck.checked;
    }

    async function submitBackup() {
        const data = {
            vm_tips: $('#backupTips').val()
        };

        // 关闭模态框
        closeCreateBackupModal();

        // 显示进度提示
        Swal.fire({
            title: '正在创建备份',
            text: '备份正在创建中，请稍候...',
            icon: 'info',
            allowOutsideClick: false,
            allowEscapeKey: false,
            showConfirmButton: false,
            didOpen: () => {
                Swal.showLoading();
            }
        });

        const result = await apiRequest(`/api/client/backup/create/${hostName}/${vmUuid}`, 'POST', data);
        if (result && result.code === 200) {
            Swal.fire({
                title: '备份创建成功',
                text: '虚拟机备份已成功创建！',
                icon: 'success',
                timer: 3000,
                showConfirmButton: false
            });
            loadBackupList();
        } else {
            Swal.fire({
                title: '备份创建失败',
                text: result?.msg || '创建备份失败，请稍后重试',
                icon: 'error',
                confirmButtonText: '确定'
            });
        }
    }

    async function restoreBackup(backupName) {
        // 显示还原确认模态框
        const vmName = vmData?.name || vmUuid;
        document.getElementById('restoreVmName').textContent = vmName;
        document.getElementById('restoreBackupName').textContent = backupName;

        // 重置确认勾选框
        document.getElementById('restoreConfirmCheck1').checked = false;
        document.getElementById('restoreConfirmCheck2').checked = false;
        document.getElementById('executeRestoreBtn').disabled = true;

        // 保存备份名称到全局变量，供executeRestore使用
        window.currentRestoreBackupName = backupName;

        // 显示模态框
        document.getElementById('restoreBackupModal').showModal();
    }

    function closeRestoreBackupModal() {
        document.getElementById('restoreBackupModal').close();
        window.currentRestoreBackupName = null;
    }

    function toggleRestoreConfirmButton() {
        const check1 = document.getElementById('restoreConfirmCheck1');
        const check2 = document.getElementById('restoreConfirmCheck2');
        const confirmBtn = document.getElementById('executeRestoreBtn');
        confirmBtn.disabled = !(check1.checked && check2.checked);
    }

    async function executeRestore() {
        const backupName = window.currentRestoreBackupName;
        if (!backupName) return;

        // 关闭模态框
        closeRestoreBackupModal();

        // 显示进度提示
        Swal.fire({
            title: '正在还原备份',
            text: '备份正在还原中，请稍候...',
            icon: 'info',
            allowOutsideClick: false,
            allowEscapeKey: false,
            showConfirmButton: false,
            didOpen: () => {
                Swal.showLoading();
            }
        });

        const result = await apiRequest(`/api/client/backup/restore/${hostName}/${vmUuid}`, 'POST', {vm_back: backupName});
        if (result && result.code === 200) {
            Swal.fire({
                title: '备份还原成功',
                text: '虚拟机备份已成功还原！页面将在3秒后自动刷新。',
                icon: 'success',
                timer: 3000,
                showConfirmButton: false
            });
            setTimeout(() => {
                location.reload();
            }, 3000);
        } else {
            Swal.fire({
                title: '备份还原失败',
                text: result?.msg || '还原备份失败，请稍后重试',
                icon: 'error',
                confirmButtonText: '确定'
            });
        }
    }

    async function deleteBackup(backupName) {
        if (!confirm(`确定要删除备份 "${backupName}" 吗？此操作不可恢复！`)) return;

        const result = await apiRequest(`/api/client/backup/delete/${hostName}/${vmUuid}`, 'DELETE', {vm_back: backupName});
        if (result && result.code === 200) {
            showToast('备份已删除', 'success');
            loadBackupList();
        } else {
            showToast(result?.msg || '删除失败', 'error');
        }
    }

    // ==================== 用户管理 ====================
    async function loadOwnersList() {
        const result = await apiRequest(`/api/client/owners/${hostName}/${vmUuid}`);
        if (result && result.code === 200 && result.data && result.data.owners) {
            renderOwnersList(result.data.owners);
        } else {
            $('#ownersList').html('<p class="text-center text-gray-500 py-8 text-sm">暂无使用者</p>');
        }
    }

    function renderOwnersList(owners) {
        if (!owners || owners.length === 0) {
            $('#ownersList').html('<p class="text-center text-gray-500 py-8 text-sm">暂无使用者</p>');
            return;
        }

// 获取当前用户名 - 多种方法尝试
        let currentUsername = '';

        // 方法1：从隐藏容器获取
        const currentUserContainer = document.getElementById('currentUserContainer');
        if (currentUserContainer) {
            currentUsername = currentUserContainer.dataset.currentUser || '';
        }

        // 方法2：如果方法1失败，尝试从页面其他地方获取
        if (!currentUsername) {
            // 检查页面中是否有其他存储用户名的地方
            const usernameElements = document.querySelectorAll('[data-username], .current-user, .username');
            if (usernameElements.length > 0) {
                currentUsername = usernameElements[0].textContent || usernameElements[0].dataset.username || '';
            }
        }

        // 方法3：如果都失败，使用默认值（这在开发环境中可能有用）
        if (!currentUsername) {
            currentUsername = 'admin'; // 临时测试用
        }

        const isCurrentUserPrimaryOwner = owners.length > 0 && owners[0].username === currentUsername;

// 调试信息
        console.log('=== 所有者管理调试信息 ===');
        console.log('当前用户容器:', currentUserContainer);
        console.log('当前用户名:', currentUsername);
        console.log('所有者列表:', owners);
        console.log('第一个所有者:', owners.length > 0 ? owners[0].username : 'none');
        console.log('当前用户是否为主所有者:', isCurrentUserPrimaryOwner);
        console.log('==========================');

        // 控制添加使用者按钮的显示
        const addOwnerBtn = document.getElementById('addOwnerBtn');
        if (addOwnerBtn) {
            if (isCurrentUserPrimaryOwner) {
                addOwnerBtn.style.display = 'flex';
            } else {
                addOwnerBtn.style.display = 'none';
            }
        }

        let html = '<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">';

        owners.forEach((owner, index) => {
            const isAdmin = owner.is_admin;
            const roleClass = isAdmin ? 'bg-purple-100 text-purple-700' : 'bg-gray-100 text-gray-700';
            const roleText = isAdmin ? '管理员' : '普通用户';
            const isFirstOwner = index === 0;

            html += `
                <div class="bg-white border border-gray-200 rounded-lg p-4 hover:border-blue-300 hover:shadow-md transition-all">
                    <div class="flex items-center justify-between mb-3">
                        <div class="flex items-center gap-2">
                            <span class="iconify text-blue-600" data-icon="mdi:account" data-width="24"></span>
                            <span class="font-medium text-gray-800">${owner.username}</span>
                            ${isFirstOwner ? '<span class="text-xs text-gray-500 ml-1">(主所有者)</span>' : ''}
                        </div>
<div class="flex items-center gap-1">
                            ${isFirstOwner && isCurrentUserPrimaryOwner ? `
                            <button onclick="showTransferOwnershipModal()" class="p-1 text-orange-500 hover:bg-orange-50 rounded" title="移交所有权">
                                <span class="iconify" data-icon="mdi:swap-horizontal" data-width="18"></span>
                            </button>
                            ` : ''}
                            ${!isFirstOwner && isCurrentUserPrimaryOwner ? `
                            <button onclick="removeOwner('${owner.username}')" class="p-1 text-red-500 hover:bg-red-50 rounded" title="移除">
                                <span class="iconify" data-icon="mdi:account-remove" data-width="18"></span>
                            </button>
                            ` : ''}
                        </div>
                    </div>
                    <div class="space-y-2">
                        ${owner.email ? `
                        <div class="flex items-center gap-2 text-sm text-gray-600">
                            <span class="iconify" data-icon="mdi:email" data-width="16"></span>
                            <span>${owner.email}</span>
                        </div>
                        ` : ''}
                        <div>
                            <span class="px-2 py-0.5 text-xs font-medium ${roleClass} rounded">
                                ${roleText}
                            </span>
                        </div>
                    </div>
                </div>
            `;
        });

        html += '</div>';
        $('#ownersList').html(html);
    }

    function showAddOwnerModal() {
        $('#addOwnerForm')[0].reset();
        document.getElementById('addOwnerModal').showModal();
    }

    function closeAddOwnerModal() {
        document.getElementById('addOwnerModal').close();
        $('#addOwnerForm')[0].reset();
    }

    async function submitAddOwner() {
        const username = $('#ownerUsername').val().trim();

        if (!username) {
            showToast('请输入用户名', 'error');
            return;
        }

        const result = await apiRequest(`/api/client/owners/${hostName}/${vmUuid}`, 'POST', {username: username});
        if (result && result.code === 200) {
            showToast('所有者添加成功', 'success');
            closeAddOwnerModal();
            loadOwnersList();
        } else {
            showToast(result?.msg || '添加失败', 'error');
        }
    }

    async function removeOwner(username) {
        // 显示自定义确认对话框
        showConfirmDialog(`确定要移除所有者 "${username}" 吗？`, async () => {
            const result = await apiRequest(`/api/client/owners/${hostName}/${vmUuid}`, 'DELETE', {username: username});
            if (result && result.code === 200) {
                showToast('所有者已移除', 'success');
                loadOwnersList();
            } else {
                showToast(result?.msg || '移除失败', 'error');
            }
        });
    }

    function showTransferOwnershipModal() {
        $('#transferOwnershipForm')[0].reset();
        // 初始化按钮状态
        document.getElementById('transferOwnershipBtn').disabled = true;
        document.getElementById('addOwnerModal').close();
        document.getElementById('transferOwnershipModal').showModal();
    }

    function closeTransferOwnershipModal() {
        document.getElementById('transferOwnershipModal').close();
        $('#transferOwnershipForm')[0].reset();
        // 重置按钮状态
        document.getElementById('transferOwnershipBtn').disabled = true;
    }

    function toggleTransferOwnershipButton() {
        const newOwner = document.getElementById('newOwnerUsername').value.trim();
        const confirmCheckbox = document.getElementById('confirmTransferCheckbox').checked;
        const transferBtn = document.getElementById('transferOwnershipBtn');

        // 只有输入了新所有者用户名且勾选了确认框才能提交
        transferBtn.disabled = !newOwner || !confirmCheckbox;
    }

    async function submitTransferOwnership() {
        const newOwner = document.getElementById('newOwnerUsername').value.trim();
        const keepAccess = document.getElementById('keepAccessCheckbox').checked;
        const confirmTransfer = document.getElementById('confirmTransferCheckbox').checked;

        if (!newOwner) {
            showToast('请输入新所有者用户名', 'error');
            return;
        }

        if (!confirmTransfer) {
            showToast('请确认移交所有权', 'error');
            return;
        }


        try {
            const result = await apiRequest(`/api/client/owners/${hostName}/${vmUuid}/transfer`, 'POST', {
                new_owner: newOwner,
                keep_access: keepAccess,
                confirm_transfer: confirmTransfer
            });

            if (result && result.code === 200) {
                showToast('所有权移交成功', 'success');
                closeTransferOwnershipModal();
                loadOwnersList();
                // 刷新页面以更新权限
                setTimeout(() => {
                    location.reload();
                }, 1500);
            } else {
                showToast(result?.msg || '移交失败', 'error');
            }
        } catch (error) {
            showToast('移交失败，请稍后重试', 'error');
            console.error('移交所有权错误:', error);
        }
    }

    // ==================== 工具函数 ====================
    function formatMemory(mb) {
        if (!mb) return '0 MB';
        if (mb >= 1024) return `${(mb / 1024).toFixed(1)} GB`;
        return `${mb} MB`;
    }

    function formatDisk(mb) {
        if (!mb) return '0 MB';
        if (mb >= 1024) return `${(mb / 1024).toFixed(1)} GB`;
        return `${mb} MB`;
    }

    function formatTraffic(mb) {
        if (!mb) return '0 MB';
        if (mb >= 1024) return `${(mb / 1024).toFixed(0)} GB`;
        return `${mb} MB`;
    }

    function formatBytes(bytes) {
        if (!bytes) return '0 B';
        const k = 1024;
        const sizes = ['B', 'KB', 'MB', 'GB', 'TB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }

    // 根据百分比获取进度条颜色类名
    function getProgressBarColor(percent) {
        if (percent < 20) return 'bg-green-500';
        if (percent < 40) return 'bg-blue-500';
        if (percent < 60) return 'bg-yellow-500';
        if (percent < 80) return 'bg-orange-500';
        return 'bg-red-500';
    }

    // 更新重装系统下拉选项
    function updateReinstallOsOptions(selectedOsName = '') {
        const osSelect = document.getElementById('reinstallOsSelect');
        // 保留"请选择操作系统"选项
        osSelect.innerHTML = '<option value="">请选择操作系统</option>';

        // 从system_maps添加选项
        for (const [osName, osConfig] of Object.entries(hostSystemMaps)) {
            const option = document.createElement('option');
            // osConfig是数组 [镜像文件, 最小大小]
            const imageFile = Array.isArray(osConfig) ? osConfig[0] : osConfig;
            option.value = imageFile; // 值设置为镜像文件名
            option.textContent = osName; // 显示文本为系统名称
            // 如果是编辑模式且匹配当前系统名称，则选中
            if (selectedOsName && osName === selectedOsName) {
                option.selected = true;
            }
            osSelect.appendChild(option);
        }
    }

    // ==================== 重装系统相关函数 ====================
    function showReinstallModal() {
        // 获取当前系统信息并设置为默认值
        const currentOs = vmData?.config?.os_name || '';

        // 先更新操作系统选项，并传递当前系统名称以正确选中
        updateReinstallOsOptions(currentOs);

        // 设置虚拟机名称显示
        const vmName = vmData?.name || vmUuid;
        document.getElementById('reinstallVmName').textContent = vmName;

        // 重置确认勾选框
        document.getElementById('reinstallConfirmCheck').checked = false;
        document.getElementById('executeReinstallBtn').disabled = true;

        // 显示模态框
        document.getElementById('reinstallModal').showModal();
    }

    function closeReinstallModal() {
        document.getElementById('reinstallModal').close();
    }

    // 监听确认勾选框状态变化
    document.addEventListener('DOMContentLoaded', function () {
        const confirmCheck = document.getElementById('reinstallConfirmCheck');
        const executeBtn = document.getElementById('executeReinstallBtn');

        if (confirmCheck && executeBtn) {
            confirmCheck.addEventListener('change', function () {
                executeBtn.disabled = !this.checked;
            });
        }
    });

    async function executeReinstall() {
        const selectedOs = document.getElementById('reinstallOsSelect').value;

        if (!selectedOs) {
            Swal.fire({
                title: '请选择操作系统',
                text: '请先选择要安装的操作系统',
                icon: 'warning',
                confirmButtonText: '确定'
            });
            return;
        }

        // 先保存到数据库
        const saveResult = await saveOsToDatabase(selectedOs);
        if (!saveResult) {
            return; // 保存失败，不再继续
        }

        // 保存成功后调用重装系统函数
        reinstallSystem();
    }

    async function saveOsToDatabase(osName) {
        try {
            // 构建更新数据
            const updateData = {
                os_name: osName
            };

            const result = await apiRequest(`/api/hosts/${hostName}/vms/${vmUuid}`, 'PUT', updateData);

            if (result && result.code === 200) {
                Swal.fire({
                    title: '系统设置已保存',
                    text: `已将系统设置为 ${osName}，准备开始重装...`,
                    icon: 'success',
                    timer: 2000,
                    showConfirmButton: false
                });
                return true;
            } else {
                Swal.fire({
                    title: '保存失败',
                    text: result?.msg || '保存系统设置失败，请稍后重试',
                    icon: 'error',
                    confirmButtonText: '确定'
                });
                return false;
            }
        } catch (error) {
            console.error('保存系统设置失败:', error);
            Swal.fire({
                title: '保存失败',
                text: '保存系统设置时发生错误，请稍后重试',
                icon: 'error',
                confirmButtonText: '确定'
            });
            return false;
        }
    }

    async function reinstallSystem() {
        // 关闭重装模态框
        closeReinstallModal();

        // 显示正在重装的提示
        Swal.fire({
            title: '正在重装系统',
            text: '系统正在重装中，请稍候...',
            icon: 'info',
            allowOutsideClick: false,
            allowEscapeKey: false,
            showConfirmButton: false
        });

        const result = await apiRequest(`/api/hosts/${hostName}/vms/${vmUuid}/reinstall`, 'POST');
        if (result && result.code === 200) {
            Swal.fire({
                title: '重装成功',
                text: '虚拟机系统重装成功！页面将在3秒后自动刷新。',
                icon: 'success',
                timer: 3000,
                showConfirmButton: false
            });
            setTimeout(() => {
                location.reload();
            }, 3000);
        } else {
            Swal.fire({
                title: '重装失败',
                text: result?.msg || '重装系统失败，请稍后重试',
                icon: 'error',
                confirmButtonText: '确定'
            });
        }
    }

    // ECharts 实例存储
    const chartInstances = {};

    // 绘制历史数据图表
    function drawHistoryCharts(statusList) {
        if (!statusList || statusList.length === 0) return;

        // 准备数据 - 提取最近的历史数据
        const chartData = prepareChartData(statusList);

        // 绘制各个图表
        drawEChart('cpuChart', chartData.cpu, chartData.labels, 'CPU使用率', '%', '#3B82F6');
        drawEChart('memChart', chartData.mem, chartData.labels, '内存使用率', '%', '#10B981');
        drawEChart('hddChart', chartData.hdd, chartData.labels, '硬盘使用率', '%', '#F59E0B');
        drawEChart('gpuChart', chartData.gpu, chartData.labels, 'GPU显存', 'MB', '#8B5CF6');
        drawEChart('netUChart', chartData.netU, chartData.labels, '上行带宽', 'Mbps', '#06B6D4');
        drawEChart('netDChart', chartData.netD, chartData.labels, '下行带宽', 'Mbps', '#14B8A6');
    }

    // 准备图表数据
    function prepareChartData(statusList) {
        const maxPoints = 4320; // 最多显示4320个数据点 (144*30)
        const data = {
            cpu: [],
            mem: [],
            hdd: [],
            gpu: [],
            netU: [],
            netD: [],
            labels: [],
            timestamps: [] // 保存完整的时间戳用于智能显示
        };

        // 取最近的数据点
        const recentData = statusList.slice(-maxPoints);

        // 获取当前时间
        const now = new Date();

        recentData.forEach((status, index) => {
            // CPU使用率
            data.cpu.push(status.cpu_usage || 0);

            // 内存使用率 (百分比)
            const memUsagePercent = status.mem_total > 0 ? (status.mem_usage / status.mem_total * 100) : 0;
            data.mem.push(memUsagePercent);

            // 硬盘使用率 (百分比)
            const hddUsagePercent = status.hdd_total > 0 ? (status.hdd_usage / status.hdd_total * 100) : 0;
            data.hdd.push(hddUsagePercent);

            // GPU使用率 (MB)
            data.gpu.push(status.gpu_total || 0);

            // 上行带宽
            data.netU.push(status.network_u || 0);

            // 下行带宽
            data.netD.push(status.network_d || 0);

            // 时间标签 - 每1分钟一个数据点，从当前时间往前推
            const timeOffset = (recentData.length - 1 - index) * 1; // 分钟偏移
            const time = new Date(now.getTime() - timeOffset * 60000);
            const hours = String(time.getHours()).padStart(2, '0');
            const minutes = String(time.getMinutes()).padStart(2, '0');
            data.labels.push(`${hours}:${minutes}`);
            data.timestamps.push(time);
        });

        return data;
    }

    // 使用 ECharts 绘制折线图
    function drawEChart(chartId, data, labels, title, unit, color) {
        const chartDom = document.getElementById(chartId);
        if (!chartDom) return;

        // 如果已存在实例，先销毁
        if (chartInstances[chartId]) {
            chartInstances[chartId].dispose();
        }

        // 创建新实例
        const chart = echarts.init(chartDom);
        chartInstances[chartId] = chart;

        if (!data || data.length === 0) {
            chart.showLoading({
                text: '暂无数据',
                color: color,
                textColor: '#6B7280',
                maskColor: 'rgba(255, 255, 255, 0.8)'
            });
            return;
        }

        const option = {
            title: {
                text: title,
                left: 'center',
                top: 10,
                textStyle: {
                    fontSize: 14,
                    fontWeight: 'bold',
                    color: '#374151'
                }
            },
            tooltip: {
                trigger: 'axis',
                formatter: function (params) {
                    const param = params[0];
                    return `${param.axisValue}<br/>${param.marker}${param.seriesName}: ${param.value.toFixed(2)} ${unit}`;
                },
                axisPointer: {
                    type: 'cross',
                    label: {
                        backgroundColor: '#6a7985'
                    }
                }
            },
            grid: {
                left: '50',
                right: '30',
                top: '50',
                bottom: '80',
                containLabel: true
            },
            xAxis: {
                type: 'category',
                boundaryGap: false,
                data: labels,
                axisLabel: {
                    fontSize: 11,
                    color: '#6B7280',
                    rotate: 0,
                    interval: 'auto',
                    formatter: function (value, index) {
                        // 智能显示标签
                        const dataCount = labels.length;
                        let showInterval = 1;

                        if (dataCount > 144) {
                            showInterval = 60; // 每60分钟
                        } else if (dataCount > 72) {
                            showInterval = 30; // 每30分钟
                        } else if (dataCount > 36) {
                            showInterval = 20; // 每20分钟
                        } else if (dataCount > 12) {
                            showInterval = 10; // 每10分钟
                        }

                        if (index % showInterval === 0 || index === dataCount - 1) {
                            return value;
                        }
                        return '';
                    }
                },
                axisLine: {
                    lineStyle: {
                        color: '#E5E7EB'
                    }
                }
            },
            yAxis: {
                type: 'value',
                name: unit,
                nameTextStyle: {
                    color: '#6B7280',
                    fontSize: 12
                },
                axisLabel: {
                    fontSize: 11,
                    color: '#6B7280',
                    formatter: '{value}'
                },
                splitLine: {
                    lineStyle: {
                        color: '#E5E7EB'
                    }
                }
            },
            dataZoom: [
                {
                    type: 'slider',
                    show: true,
                    start: 0,
                    end: 100,
                    height: 20,
                    bottom: 10,
                    handleSize: '80%',
                    handleStyle: {
                        color: color
                    },
                    textStyle: {
                        color: '#6B7280',
                        fontSize: 10
                    },
                    borderColor: '#E5E7EB',
                    fillerColor: 'rgba(59, 130, 246, 0.1)',
                    dataBackground: {
                        lineStyle: {
                            color: color,
                            opacity: 0.5
                        },
                        areaStyle: {
                            color: color,
                            opacity: 0.2
                        }
                    }
                },
                {
                    type: 'inside',
                    start: 0,
                    end: 100
                }
            ],
            series: [
                {
                    name: title,
                    type: 'line',
                    smooth: true,
                    symbol: 'circle',
                    symbolSize: 4,
                    sampling: 'lttb',
                    itemStyle: {
                        color: color
                    },
                    lineStyle: {
                        width: 2,
                        color: color
                    },
                    areaStyle: {
                        color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                            {
                                offset: 0,
                                color: color.replace(')', ', 0.3)').replace('rgb', 'rgba')
                            },
                            {
                                offset: 1,
                                color: color.replace(')', ', 0.05)').replace('rgb', 'rgba')
                            }
                        ])
                    },
                    data: data
                }
            ]
        };

        chart.setOption(option);

        // 响应式调整
        window.addEventListener('resize', function () {
            chart.resize();
        });
    }

    // 自定义确认对话框功能
    let confirmCallback = null;

    function initConfirmDialog() {
        const cancelBtn = document.getElementById('confirmCancel');
        const okBtn = document.getElementById('confirmOk');
        const dialog = document.getElementById('confirmDialog');
        
        // 取消按钮事件
        cancelBtn.addEventListener('click', () => {
            hideConfirmDialog();
        });
        
        // 确认按钮事件
        okBtn.addEventListener('click', () => {
            if (confirmCallback) {
                confirmCallback();
            }
            hideConfirmDialog();
        });
        
        // 点击背景关闭（可选）
        dialog.addEventListener('click', (e) => {
            if (e.target === dialog) {
                hideConfirmDialog();
            }
        });
        
        // ESC键关闭
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && !dialog.classList.contains('hidden')) {
                hideConfirmDialog();
            }
        });
    }
    
    function showConfirmDialog(message, callback) {
        const dialog = document.getElementById('confirmDialog');
        const messageElement = document.getElementById('confirmMessage');
        
        messageElement.textContent = message;
        confirmCallback = callback;
        dialog.classList.remove('hidden');
        
        // 添加动画效果
        setTimeout(() => {
            dialog.querySelector('.bg-white').classList.add('scale-100');
            dialog.querySelector('.bg-white').classList.remove('scale-95');
        }, 10);
    }
    
    function hideConfirmDialog() {
        const dialog = document.getElementById('confirmDialog');
        
        // 添加动画效果
        dialog.querySelector('.bg-white').classList.add('scale-95');
        dialog.querySelector('.bg-white').classList.remove('scale-100');
        
        setTimeout(() => {
            dialog.classList.add('hidden');
            confirmCallback = null;
        }, 150);
    }
</script>

<!-- 自定义确认对话框 -->
<div id="confirmDialog" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white rounded-lg p-6 w-full max-w-md mx-4 transform transition-all">
        <div class="flex items-center mb-4">
            <div class="flex-shrink-0 w-12 h-12 bg-red-100 rounded-full flex items-center justify-center">
                <span class="iconify text-red-600" data-icon="mdi:alert-circle" data-width="24"></span>
            </div>
            <div class="ml-4">
                <h3 class="text-lg font-semibold text-gray-900">确认移除</h3>
                <p class="text-sm text-gray-500">此操作不可恢复</p>
            </div>
        </div>
        
        <div class="mb-6">
            <p id="confirmMessage" class="text-gray-700">确定要移除此使用者吗？</p>
        </div>
        
        <div class="flex gap-3 justify-end">
            <button id="confirmCancel" 
                    class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 transition-colors">
                取消
            </button>
            <button id="confirmOk" 
                    class="px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg transition-colors">
                确认移除
            </button>
        </div>
    </div>
</div>
{% endblock %}