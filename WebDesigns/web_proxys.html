{% extends "base.html" %}

{% block extra_head %}
<style>
    .proxy-card {
        transition: all 0.3s ease;
    }
    .proxy-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
    }
    .badge-custom {
        display: inline-flex;
        align-items: center;
        gap: 0.25rem;
        padding: 0.25rem 0.75rem;
        border-radius: 0.375rem;
        font-size: 0.875rem;
        font-weight: 500;
    }
    .badge-http {
        background-color: #e5e7eb;
        color: #374151;
    }
    .badge-https {
        background-color: #d1fae5;
        color: #065f46;
    }
    .domain-link {
        color: #2563eb;
        text-decoration: none;
        font-weight: 500;
        transition: color 0.2s;
    }
    .domain-link:hover {
        color: #1d4ed8;
        text-decoration: underline;
    }
</style>
{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- 页面标题 -->
    <div class="flex justify-between items-center">
        <div>
            <h1 class="text-3xl font-bold text-gray-800 flex items-center gap-3">
                <span class="iconify text-blue-600" data-icon="mdi:web" data-width="36"></span>
                Web反向代理管理
            </h1>
            <p class="text-gray-500 mt-2">管理所有虚拟机的Web反向代理配置</p>
        </div>
        <button onclick="showAddModal()" class="btn btn-primary btn-hover flex items-center gap-2">
            <span class="iconify" data-icon="mdi:plus" data-width="20"></span>
            添加反向代理
        </button>
    </div>

    <!-- 统计卡片 -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
        <div class="card bg-white shadow-sm card-hover">
            <div class="card-body">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-500 text-sm">总代理数</p>
                        <p class="text-2xl font-bold text-gray-800" id="total-proxys">0</p>
                    </div>
                    <span class="iconify text-blue-500" data-icon="mdi:web" data-width="40"></span>
                </div>
            </div>
        </div>
        <div class="card bg-white shadow-sm card-hover">
            <div class="card-body">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-500 text-sm">HTTP代理</p>
                        <p class="text-2xl font-bold text-gray-800" id="http-proxys">0</p>
                    </div>
                    <span class="iconify text-gray-500" data-icon="mdi:web-off" data-width="40"></span>
                </div>
            </div>
        </div>
        <div class="card bg-white shadow-sm card-hover">
            <div class="card-body">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-500 text-sm">HTTPS代理</p>
                        <p class="text-2xl font-bold text-gray-800" id="https-proxys">0</p>
                    </div>
                    <span class="iconify text-green-500" data-icon="mdi:lock" data-width="40"></span>
                </div>
            </div>
        </div>
        <div class="card bg-white shadow-sm card-hover">
            <div class="card-body">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-500 text-sm">主机数</p>
                        <p class="text-2xl font-bold text-gray-800" id="total-hosts">0</p>
                    </div>
                    <span class="iconify text-purple-500" data-icon="mdi:server" data-width="40"></span>
                </div>
            </div>
        </div>
    </div>

    <!-- 筛选和搜索 -->
    <div class="card bg-white shadow-sm">
        <div class="card-body">
            <div class="flex flex-col md:flex-row gap-4">
                <div class="flex-1">
                    <input type="text" id="search-input" placeholder="搜索域名、虚拟机名称..." 
                           class="input input-bordered w-full input-transition"
                           oninput="filterProxys()">
                </div>
                <select id="host-filter" class="select select-bordered" onchange="filterProxys()">
                    <option value="">所有主机</option>
                </select>
                <select id="protocol-filter" class="select select-bordered" onchange="filterProxys()">
                    <option value="">所有协议</option>
                    <option value="http">HTTP</option>
                    <option value="https">HTTPS</option>
                </select>
                <button onclick="loadProxys()" class="btn btn-outline btn-hover flex items-center gap-2">
                    <span class="iconify" data-icon="mdi:refresh" data-width="20"></span>
                    刷新
                </button>
            </div>
        </div>
    </div>

    <!-- 代理列表 -->
    <div class="card bg-white shadow-sm">
        <div class="card-body">
            <div id="loading-state" class="text-center py-12">
                <span class="loading loading-spinner loading-lg text-primary"></span>
                <p class="text-gray-500 mt-4" data-i18n="加载中...">加载中...</p>
            </div>
            <div id="empty-state" class="text-center py-12 hidden">
                <span class="iconify text-gray-300" data-icon="mdi:web-off" data-width="80"></span>
                <p class="text-gray-500 mt-4 text-lg">暂无反向代理配置</p>
                <button onclick="showAddModal()" class="btn btn-primary mt-4">添加第一个代理</button>
            </div>
            <div id="proxy-list" class="hidden">
                <div class="overflow-x-auto">
                    <table class="table table-zebra w-full">
                        <thead>
                            <tr>
                                <th>域名</th>
                                <th>主机</th>
                                <th>虚拟机</th>
                                <th>后端地址</th>
                                <th>协议</th>
                                <th>描述</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody id="proxy-tbody">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 添加/编辑代理模态框 -->
<dialog id="proxy-modal" class="modal">
    <div class="modal-box max-w-2xl">
        <h3 class="font-bold text-lg mb-4" id="modal-title">添加反向代理</h3>
        <form id="proxy-form" class="space-y-4">
            <input type="hidden" id="edit-host-name">
            <input type="hidden" id="edit-vm-uuid">
            <input type="hidden" id="edit-proxy-index">
            
            <div class="form-control">
                <label class="label">
                    <span class="label-text">主机</span>
                </label>
                <select id="proxy-host" class="select select-bordered" required onchange="loadVMsForHost()">
                    <option value="">请选择主机</option>
                </select>
            </div>

            <div class="form-control">
                <label class="label">
                    <span class="label-text">虚拟机</span>
                </label>
                <select id="proxy-vm" class="select select-bordered" required>
                    <option value="">请先选择主机</option>
                </select>
            </div>

            <div class="form-control">
                <label class="label">
                    <span class="label-text">域名 *</span>
                </label>
                <input type="text" id="proxy-domain" class="input input-bordered" 
                       placeholder="example.com" required>
            </div>

            <div class="grid grid-cols-2 gap-4">
                <div class="form-control">
                    <label class="label">
                        <span class="label-text">后端IP</span>
                    </label>
                    <input type="text" id="proxy-backend-ip" class="input input-bordered" 
                           placeholder="自动获取">
                </div>
                <div class="form-control">
                    <label class="label">
                        <span class="label-text">后端端口</span>
                    </label>
                    <input type="number" id="proxy-backend-port" class="input input-bordered" 
                           value="80" min="1" max="65535" required>
                </div>
            </div>

            <div class="form-control">
                <label class="label">
                    <span class="label-text">描述</span>
                </label>
                <textarea id="proxy-description" class="textarea textarea-bordered" 
                          placeholder="可选的描述信息"></textarea>
            </div>

            <div class="form-control">
                <label class="label cursor-pointer justify-start gap-2">
                    <input type="checkbox" id="proxy-ssl" class="checkbox checkbox-primary">
                    <span class="label-text">启用HTTPS (SSL/TLS)</span>
                </label>
            </div>

            <div class="modal-action">
                <button type="button" class="btn" onclick="closeProxyModal()">取消</button>
                <button type="submit" class="btn btn-primary">
                    <span id="submit-btn-text">添加</span>
                </button>
            </div>
        </form>
    </div>
    <form method="dialog" class="modal-backdrop">
        <button>close</button>
    </form>
</dialog>

{% endblock %}

{% block extra_scripts %}
<script>
let allProxys = [];
let allHosts = [];
let allVMs = {};

// 页面加载时初始化
document.addEventListener('DOMContentLoaded', function() {
    loadHosts();
    loadProxys();
});

// 加载主机列表
async function loadHosts() {
    const result = await apiRequest('/api/hosts/list');
    if (result && result.code === 200) {
        allHosts = result.data || [];
        
        // 更新主机筛选下拉框
        const hostFilter = document.getElementById('host-filter');
        hostFilter.innerHTML = '<option value="">所有主机</option>';
        allHosts.forEach(host => {
            const option = document.createElement('option');
            option.value = host.server_name;
            option.textContent = host.server_name;
            hostFilter.appendChild(option);
        });
        
        // 更新模态框中的主机选择
        const proxyHost = document.getElementById('proxy-host');
        proxyHost.innerHTML = '<option value="">请选择主机</option>';
        allHosts.forEach(host => {
            const option = document.createElement('option');
            option.value = host.server_name;
            option.textContent = host.server_name;
            proxyHost.appendChild(option);
        });
    }
}

// 加载指定主机的虚拟机列表
async function loadVMsForHost() {
    const hostName = document.getElementById('proxy-host').value;
    const vmSelect = document.getElementById('proxy-vm');
    
    if (!hostName) {
        vmSelect.innerHTML = '<option value="">请先选择主机</option>';
        return;
    }
    
    vmSelect.innerHTML = '<option value="">' + (window.i18n?.t('加载中...') || '加载中...') + '</option>';
    
    const result = await apiRequest(`/api/vms/list/${hostName}`);
    if (result && result.code === 200) {
        const vms = result.data || [];
        allVMs[hostName] = vms;
        
        vmSelect.innerHTML = '<option value="">请选择虚拟机</option>';
        vms.forEach(vm => {
            const option = document.createElement('option');
            option.value = vm.vm_uuid;
            option.textContent = vm.vm_name || vm.vm_uuid;
            vmSelect.appendChild(option);
        });
    } else {
        vmSelect.innerHTML = '<option value="">加载失败</option>';
    }
}

// 加载所有代理配置
async function loadProxys() {
    document.getElementById('loading-state').classList.remove('hidden');
    document.getElementById('empty-state').classList.add('hidden');
    document.getElementById('proxy-list').classList.add('hidden');
    
    const result = await apiRequest('/api/admin/proxys/list');
    
    if (result && result.code === 200) {
        allProxys = result.data.list || [];
        updateStatistics();
        renderProxys();
    } else {
        document.getElementById('loading-state').classList.add('hidden');
        document.getElementById('empty-state').classList.remove('hidden');
    }
}

// 更新统计信息
function updateStatistics() {
    const total = allProxys.length;
    const httpCount = allProxys.filter(p => !p.ssl_enabled).length;
    const httpsCount = allProxys.filter(p => p.ssl_enabled).length;
    const hosts = new Set(allProxys.map(p => p.host_name)).size;
    
    document.getElementById('total-proxys').textContent = total;
    document.getElementById('http-proxys').textContent = httpCount;
    document.getElementById('https-proxys').textContent = httpsCount;
    document.getElementById('total-hosts').textContent = hosts;
}

// 渲染代理列表
function renderProxys() {
    const tbody = document.getElementById('proxy-tbody');
    const searchTerm = document.getElementById('search-input').value.toLowerCase();
    const hostFilter = document.getElementById('host-filter').value;
    const protocolFilter = document.getElementById('protocol-filter').value;
    
    let filteredProxys = allProxys.filter(proxy => {
        const matchSearch = !searchTerm || 
            proxy.domain.toLowerCase().includes(searchTerm) ||
            proxy.vm_name.toLowerCase().includes(searchTerm);
        const matchHost = !hostFilter || proxy.host_name === hostFilter;
        const matchProtocol = !protocolFilter || 
            (protocolFilter === 'https' && proxy.ssl_enabled) ||
            (protocolFilter === 'http' && !proxy.ssl_enabled);
        
        return matchSearch && matchHost && matchProtocol;
    });
    
    if (filteredProxys.length === 0) {
        document.getElementById('loading-state').classList.add('hidden');
        document.getElementById('empty-state').classList.remove('hidden');
        document.getElementById('proxy-list').classList.add('hidden');
        return;
    }
    
    document.getElementById('loading-state').classList.add('hidden');
    document.getElementById('empty-state').classList.add('hidden');
    document.getElementById('proxy-list').classList.remove('hidden');
    
    tbody.innerHTML = filteredProxys.map(proxy => `
        <tr>
            <td>
                <a href="http${proxy.ssl_enabled ? 's' : ''}://${proxy.domain}" 
                   target="_blank" class="domain-link">
                    ${proxy.domain}
                </a>
            </td>
            <td>
                <span class="badge badge-outline">${proxy.host_name}</span>
            </td>
            <td>
                <span class="badge badge-ghost">${proxy.vm_name}</span>
            </td>
            <td>
                <code class="text-sm">${proxy.backend_ip || 'auto'}:${proxy.backend_port}</code>
            </td>
            <td>
                <span class="badge-custom ${proxy.ssl_enabled ? 'badge-https' : 'badge-http'}">
                    <span class="iconify" data-icon="${proxy.ssl_enabled ? 'mdi:lock' : 'mdi:web'}" data-width="16"></span>
                    ${proxy.ssl_enabled ? 'HTTPS' : 'HTTP'}
                </span>
            </td>
            <td>
                <span class="text-sm text-gray-600">${proxy.description || '-'}</span>
            </td>
            <td>
                <div class="flex gap-2">
                    <button onclick='editProxy(${JSON.stringify(proxy)})' 
                            class="btn btn-sm btn-ghost btn-hover">
                        <span class="iconify" data-icon="mdi:pencil" data-width="16"></span>
                    </button>
                    <button onclick="deleteProxy('${proxy.host_name}', '${proxy.vm_uuid}', ${proxy.proxy_index})" 
                            class="btn btn-sm btn-ghost text-error btn-hover">
                        <span class="iconify" data-icon="mdi:delete" data-width="16"></span>
                    </button>
                </div>
            </td>
        </tr>
    `).join('');
}

// 筛选代理
function filterProxys() {
    renderProxys();
}

// 显示添加模态框
function showAddModal() {
    document.getElementById('modal-title').textContent = '添加反向代理';
    document.getElementById('submit-btn-text').textContent = '添加';
    document.getElementById('proxy-form').reset();
    document.getElementById('edit-host-name').value = '';
    document.getElementById('edit-vm-uuid').value = '';
    document.getElementById('edit-proxy-index').value = '';
    document.getElementById('proxy-host').disabled = false;
    document.getElementById('proxy-vm').disabled = false;
    document.getElementById('proxy-modal').showModal();
}

// 编辑代理
function editProxy(proxy) {
    document.getElementById('modal-title').textContent = '编辑反向代理';
    document.getElementById('submit-btn-text').textContent = '保存';
    document.getElementById('edit-host-name').value = proxy.host_name;
    document.getElementById('edit-vm-uuid').value = proxy.vm_uuid;
    document.getElementById('edit-proxy-index').value = proxy.proxy_index;
    document.getElementById('proxy-host').value = proxy.host_name;
    document.getElementById('proxy-host').disabled = true;
    
    // 加载虚拟机列表
    loadVMsForHost().then(() => {
        document.getElementById('proxy-vm').value = proxy.vm_uuid;
        document.getElementById('proxy-vm').disabled = true;
    });
    
    document.getElementById('proxy-domain').value = proxy.domain;
    document.getElementById('proxy-backend-ip').value = proxy.backend_ip || '';
    document.getElementById('proxy-backend-port').value = proxy.backend_port;
    document.getElementById('proxy-description').value = proxy.description || '';
    document.getElementById('proxy-ssl').checked = proxy.ssl_enabled;
    
    document.getElementById('proxy-modal').showModal();
}

// 关闭模态框
function closeProxyModal() {
    document.getElementById('proxy-modal').close();
}

// 提交表单
document.getElementById('proxy-form').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const editHostName = document.getElementById('edit-host-name').value;
    const editVmUuid = document.getElementById('edit-vm-uuid').value;
    const editProxyIndex = document.getElementById('edit-proxy-index').value;
    
    const hostName = document.getElementById('proxy-host').value;
    const vmUuid = document.getElementById('proxy-vm').value;
    const domain = document.getElementById('proxy-domain').value;
    const backendIp = document.getElementById('proxy-backend-ip').value;
    const backendPort = document.getElementById('proxy-backend-port').value;
    const description = document.getElementById('proxy-description').value;
    const sslEnabled = document.getElementById('proxy-ssl').checked;
    
    if (!hostName || !vmUuid) {
        showToast('请选择主机和虚拟机', 'error');
        return;
    }
    
    const data = {
        domain: domain,
        backend_ip: backendIp,
        backend_port: parseInt(backendPort),
        ssl_enabled: sslEnabled,
        description: description
    };
    
    let result;
    if (editProxyIndex !== '') {
        // 编辑模式
        result = await apiRequest(
            `/api/admin/proxys/update/${editHostName}/${editVmUuid}/${editProxyIndex}`,
            'PUT',
            data
        );
    } else {
        // 添加模式
        result = await apiRequest(
            `/api/admin/proxys/create/${hostName}/${vmUuid}`,
            'POST',
            data
        );
    }
    
    if (result && result.code === 200) {
        showToast(result.msg || '操作成功', 'success');
        closeProxyModal();
        loadProxys();
    } else {
        showToast(result?.msg || '操作失败', 'error');
    }
});

// 删除代理
async function deleteProxy(hostName, vmUuid, proxyIndex) {
    const result = await Swal.fire({
        title: '确认删除',
        text: '确定要删除这个反向代理配置吗？',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#ef4444',
        cancelButtonColor: '#6b7280',
        confirmButtonText: '删除',
        cancelButtonText: '取消'
    });
    
    if (result.isConfirmed) {
        const apiResult = await apiRequest(
            `/api/admin/proxys/delete/${hostName}/${vmUuid}/${proxyIndex}`,
            'DELETE'
        );
        
        if (apiResult && apiResult.code === 200) {
            showToast('删除成功', 'success');
            loadProxys();
        } else {
            showToast(apiResult?.msg || '删除失败', 'error');
        }
    }
}
</script>
{% endblock %}