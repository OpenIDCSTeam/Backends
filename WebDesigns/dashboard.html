{% extends "base.html" %}

{% block content %}
<!-- 页面标题 -->
<div class="mb-6">
    <h1 class="text-3xl font-bold text-gray-800 flex items-center gap-3">
        <span class="iconify text-blue-600" data-icon="mdi:view-dashboard" data-width="36"></span>
        仪表盘
    </h1>
    <p class="text-gray-600 mt-1">系统概览与快速操作</p>
</div>

{% if session.get('is_admin') or session.get('is_token_login') %}
<!-- 管理员视图：统计卡片 -->
<div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
    <!-- 主机统计 -->
    <div class="bg-white rounded-lg border border-gray-200 p-6 card-hover">
        <div class="flex items-center justify-between mb-4">
            <div class="w-12 h-12 bg-gradient-to-br from-blue-500 to-blue-600 rounded-lg flex items-center justify-center shadow-md">
                <span class="iconify text-white" data-icon="mdi:server" data-width="28"></span>
            </div>
            <div class="text-right">
                <p class="text-sm text-gray-600 font-medium mb-1">主机总数</p>
                <p class="text-3xl font-bold text-gray-800" id="hostCount">-</p>
            </div>
        </div>
        <div class="pt-3 border-t border-gray-200">
            <a href="/hosts" class="text-sm text-blue-600 hover:text-blue-800 flex items-center gap-1">
                管理主机
                <span class="iconify" data-icon="mdi:arrow-right" data-width="16"></span>
            </a>
        </div>
    </div>

    <!-- 虚拟机统计 -->
    <div class="bg-white rounded-lg border border-gray-200 p-6 card-hover">
        <div class="flex items-center justify-between mb-4">
            <div class="w-12 h-12 bg-gradient-to-br from-purple-500 to-purple-600 rounded-lg flex items-center justify-center shadow-md">
                <span class="iconify text-white" data-icon="mdi:cube-outline" data-width="28"></span>
            </div>
            <div class="text-right">
                <p class="text-sm text-gray-600 font-medium mb-1">虚拟机总数</p>
                <p class="text-3xl font-bold text-gray-800" id="vmCount">-</p>
            </div>
        </div>
        <div class="pt-3 border-t border-gray-200 space-y-1">
            <div class="flex items-center justify-between text-sm">
                <span class="text-gray-600 flex items-center gap-1">
                    <span class="w-2 h-2 bg-green-500 rounded-full"></span>
                    运行中
                </span>
                <span class="font-medium text-gray-800" id="runningVm">-</span>
            </div>
        </div>
    </div>

    <!-- 系统状态 -->
    <div class="bg-white rounded-lg border border-gray-200 p-6 card-hover">
        <div class="flex items-center justify-between mb-4">
            <div class="w-12 h-12 bg-gradient-to-br from-green-500 to-green-600 rounded-lg flex items-center justify-center shadow-md">
                <span class="iconify text-white" data-icon="mdi:check-circle" data-width="28"></span>
            </div>
            <div class="text-right">
                <p class="text-sm text-gray-600 font-medium mb-1">系统状态</p>
                <p class="text-xl font-bold text-green-600">正常运行</p>
            </div>
        </div>
        <div class="pt-3 border-t border-gray-200">
            <div class="flex items-center justify-between text-sm">
                <span class="text-gray-600">最后更新</span>
                <span class="font-medium text-gray-800" id="lastUpdate">-</span>
            </div>
        </div>
    </div>
</div>

<!-- 主要内容区域 -->
<div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
    <!-- 主机列表 -->
    <div class="lg:col-span-2 bg-white rounded-lg border border-gray-200 card-hover">
        <div class="p-4 border-b border-gray-200 flex items-center justify-between">
            <h2 class="text-base font-semibold text-gray-800 flex items-center gap-2">
                <span class="iconify text-blue-600" data-icon="mdi:format-list-bulleted" data-width="20"></span>
                主机概览
            </h2>
            <a href="/hosts"
               class="text-xs text-blue-600 hover:text-blue-800 font-medium smooth-transition flex items-center gap-1">
                查看全部
                <span class="iconify" data-icon="mdi:arrow-right" data-width="14"></span>
            </a>
        </div>
        <div id="hostsList" class="p-4">
            <p class="text-center py-8 text-gray-500 text-xs flex items-center justify-center gap-2">
                <span class="iconify animate-pulse-slow" data-icon="mdi:loading" data-width="16"></span>
                <span data-i18n="加载中...">加载中...</span>
            </p>
        </div>
    </div>

    <!-- 快速操作 -->
    <div class="bg-white rounded-lg border border-gray-200 card-hover">
        <div class="p-4 border-b border-gray-200">
            <h2 class="text-base font-semibold text-gray-800 flex items-center gap-2">
                <span class="iconify text-blue-600" data-icon="mdi:lightning-bolt" data-width="20"></span>
                快速操作
            </h2>
        </div>
        <div class="p-4 space-y-3">
            <a href="/hosts"
               class="flex items-center gap-3 p-3 border border-gray-200 rounded-lg hover:border-blue-300 hover:bg-blue-50 smooth-transition group">
                <div class="w-10 h-10 bg-blue-100 rounded-lg flex items-center justify-center group-hover:bg-blue-200 smooth-transition">
                    <span class="iconify text-blue-600" data-icon="mdi:server-plus" data-width="20"></span>
                </div>
                <div class="flex-1">
                    <p class="text-sm font-semibold text-gray-800">添加主机</p>
                    <p class="text-xs text-gray-600">添加新的虚拟化主机</p>
                </div>
                <span class="iconify text-gray-400 group-hover:text-blue-600 smooth-transition"
                      data-icon="mdi:chevron-right" data-width="20"></span>
            </a>

            <a href="/settings"
               class="flex items-center gap-3 p-3 border border-gray-200 rounded-lg hover:border-blue-300 hover:bg-blue-50 smooth-transition group">
                <div class="w-10 h-10 bg-gray-100 rounded-lg flex items-center justify-center group-hover:bg-gray-200 smooth-transition">
                    <span class="iconify text-gray-600" data-icon="mdi:cog" data-width="20"></span>
                </div>
                <div class="flex-1">
                    <p class="text-sm font-semibold text-gray-800">系统设置</p>
                    <p class="text-xs text-gray-600">管理Token和系统配置</p>
                </div>
                <span class="iconify text-gray-400 group-hover:text-blue-600 smooth-transition"
                      data-icon="mdi:chevron-right" data-width="20"></span>
            </a>

            <button onclick="saveAll()"
                    class="w-full flex items-center gap-3 p-3 border border-gray-200 rounded-lg hover:border-green-300 hover:bg-green-50 smooth-transition group">
                <div class="w-10 h-10 bg-green-100 rounded-lg flex items-center justify-center group-hover:bg-green-200 smooth-transition">
                    <span class="iconify text-green-600" data-icon="mdi:content-save" data-width="20"></span>
                </div>
                <div class="flex-1 text-left">
                    <p class="text-sm font-semibold text-gray-800">保存配置</p>
                    <p class="text-xs text-gray-600">保存所有主机和虚拟机配置</p>
                </div>
                <span class="iconify text-gray-400 group-hover:text-green-600 smooth-transition"
                      data-icon="mdi:chevron-right" data-width="20"></span>
            </button>

            <div class="border border-gray-200 rounded-lg p-3 bg-gradient-to-br from-blue-50 to-indigo-50">
                <div class="flex items-center gap-2 mb-2">
                    <span class="iconify text-blue-600" data-icon="mdi:information" data-width="16"></span>
                    <span class="text-xs font-semibold text-gray-700">提示</span>
                </div>
                <p class="text-xs text-gray-600 leading-relaxed">
                    通过<span class="font-medium text-blue-600">主机管理</span>页面可以管理主机和虚拟机。支持使用API+Token进行自动化管理。
                </p>
            </div>
        </div>
    </div>
</div>

{% else %}
<!-- 普通用户视图：资源使用情况 -->
<div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-4 mb-6">
    <!-- CPU使用情况 -->
    <div class="bg-white rounded-lg border border-gray-200 p-4 card-hover">
        <div class="flex items-center justify-between mb-3">
            <div class="w-10 h-10 bg-gradient-to-br from-blue-500 to-blue-600 rounded-lg flex items-center justify-center shadow-md">
                <span class="iconify text-white" data-icon="mdi:cpu-64-bit" data-width="20"></span>
            </div>
            <div class="text-right">
                <p class="text-xs text-gray-600 font-medium mb-1">CPU核心</p>
                <p class="text-lg font-bold text-gray-800">
                    <span id="usedCpu">-</span>/<span id="quotaCpu">-</span>
                </p>
            </div>
        </div>
        <div class="w-full bg-gray-200 rounded-full h-1.5">
            <div id="cpuProgress" class="bg-blue-600 h-1.5 rounded-full transition-all duration-300"
                 style="width: 0%"></div>
        </div>
    </div>

    <!-- GPU使用情况 -->
    <div class="bg-white rounded-lg border border-gray-200 p-4 card-hover">
        <div class="flex items-center justify-between mb-3">
            <div class="w-10 h-10 bg-gradient-to-br from-pink-500 to-pink-600 rounded-lg flex items-center justify-center shadow-md">
                <span class="iconify text-white" data-icon="mdi:video" data-width="20"></span>
            </div>
            <div class="text-right">
                <p class="text-xs text-gray-600 font-medium mb-1">GPU显存</p>
                <p class="text-lg font-bold text-gray-800">
                    <span id="usedGpu">-</span>/<span id="quotaGpu">-</span>GB
                </p>
            </div>
        </div>
        <div class="w-full bg-gray-200 rounded-full h-1.5">
            <div id="gpuProgress" class="bg-pink-600 h-1.5 rounded-full transition-all duration-300"
                 style="width: 0%"></div>
        </div>
    </div>

    <!-- 内存使用情况 -->
    <div class="bg-white rounded-lg border border-gray-200 p-4 card-hover">
        <div class="flex items-center justify-between mb-3">
            <div class="w-10 h-10 bg-gradient-to-br from-green-500 to-green-600 rounded-lg flex items-center justify-center shadow-md">
                <span class="iconify text-white" data-icon="mdi:memory" data-width="20"></span>
            </div>
            <div class="text-right">
                <p class="text-xs text-gray-600 font-medium mb-1">内存</p>
                <p class="text-lg font-bold text-gray-800">
                    <span id="usedRam">-</span>/<span id="quotaRam">-</span>GB
                </p>
            </div>
        </div>
        <div class="w-full bg-gray-200 rounded-full h-1.5">
            <div id="ramProgress" class="bg-green-600 h-1.5 rounded-full transition-all duration-300"
                 style="width: 0%"></div>
        </div>
    </div>

    <!-- 磁盘使用情况 -->
    <div class="bg-white rounded-lg border border-gray-200 p-4 card-hover">
        <div class="flex items-center justify-between mb-3">
            <div class="w-10 h-10 bg-gradient-to-br from-purple-500 to-purple-600 rounded-lg flex items-center justify-center shadow-md">
                <span class="iconify text-white" data-icon="mdi:harddisk" data-width="20"></span>
            </div>
            <div class="text-right">
                <p class="text-xs text-gray-600 font-medium mb-1">磁盘</p>
                <p class="text-lg font-bold text-gray-800">
                    <span id="usedSsd">-</span>/<span id="quotaSsd">-</span>GB
                </p>
            </div>
        </div>
        <div class="w-full bg-gray-200 rounded-full h-1.5">
            <div id="ssdProgress" class="bg-purple-600 h-1.5 rounded-full transition-all duration-300"
                 style="width: 0%"></div>
        </div>
    </div>

    <!-- 流量使用情况 -->
    <div class="bg-white rounded-lg border border-gray-200 p-4 card-hover">
        <div class="flex items-center justify-between mb-3">
            <div class="w-10 h-10 bg-gradient-to-br from-yellow-500 to-yellow-600 rounded-lg flex items-center justify-center shadow-md">
                <span class="iconify text-white" data-icon="mdi:web" data-width="20"></span>
            </div>
            <div class="text-right">
                <p class="text-xs text-gray-600 font-medium mb-1">流量</p>
                <p class="text-lg font-bold text-gray-800">
                    <span id="usedTraffic">-</span>/<span id="quotaTraffic">-</span>GB
                </p>
            </div>
        </div>
        <div class="w-full bg-gray-200 rounded-full h-1.5">
            <div id="trafficProgress" class="bg-yellow-600 h-1.5 rounded-full transition-all duration-300"
                 style="width: 0%"></div>
        </div>
    </div>
</div>

<!-- 第二行资源使用情况 -->
<div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-4 mb-6">
    <!-- NAT端口使用情况 -->
    <div class="bg-white rounded-lg border border-gray-200 p-4 card-hover">
        <div class="flex items-center justify-between mb-3">
            <div class="w-10 h-10 bg-gradient-to-br from-indigo-500 to-indigo-600 rounded-lg flex items-center justify-center shadow-md">
                <span class="iconify text-white" data-icon="mdi:lan" data-width="20"></span>
            </div>
            <div class="text-right">
                <p class="text-xs text-gray-600 font-medium mb-1">NAT端口</p>
                <p class="text-lg font-bold text-gray-800">
                    <span id="usedNatPorts">-</span>/<span id="quotaNatPorts">-</span>
                </p>
            </div>
        </div>
        <div class="w-full bg-gray-200 rounded-full h-1.5">
            <div id="natPortsProgress" class="bg-indigo-600 h-1.5 rounded-full transition-all duration-300"
                 style="width: 0%"></div>
        </div>
    </div>

    <!-- WEB代理使用情况 -->
    <div class="bg-white rounded-lg border border-gray-200 p-4 card-hover">
        <div class="flex items-center justify-between mb-3">
            <div class="w-10 h-10 bg-gradient-to-br from-teal-500 to-teal-600 rounded-lg flex items-center justify-center shadow-md">
                <span class="iconify text-white" data-icon="mdi:web" data-width="20"></span>
            </div>
            <div class="text-right">
                <p class="text-xs text-gray-600 font-medium mb-1">WEB代理</p>
                <p class="text-lg font-bold text-gray-800">
                    <span id="usedWebProxy">-</span>/<span id="quotaWebProxy">-</span>
                </p>
            </div>
        </div>
        <div class="w-full bg-gray-200 rounded-full h-1.5">
            <div id="webProxyProgress" class="bg-teal-600 h-1.5 rounded-full transition-all duration-300"
                 style="width: 0%"></div>
        </div>
    </div>

    <!-- 上行带宽 -->
    <div class="bg-white rounded-lg border border-gray-200 p-4 card-hover">
        <div class="flex items-center justify-between mb-3">
            <div class="w-10 h-10 bg-gradient-to-br from-red-500 to-red-600 rounded-lg flex items-center justify-center shadow-md">
                <span class="iconify text-white" data-icon="mdi:upload" data-width="20"></span>
            </div>
            <div class="text-right">
                <p class="text-xs text-gray-600 font-medium mb-1">上行带宽</p>
                <p class="text-lg font-bold text-gray-800">
                    <span id="usedBandwidthUp">-</span>/<span id="quotaBandwidthUp">-</span>Mbps
                </p>
            </div>
        </div>
        <div class="w-full bg-gray-200 rounded-full h-1.5">
            <div id="bandwidthUpProgress" class="bg-red-600 h-1.5 rounded-full transition-all duration-300"
                 style="width: 0%"></div>
        </div>
    </div>

    <!-- 下行带宽 -->
    <div class="bg-white rounded-lg border border-gray-200 p-4 card-hover">
        <div class="flex items-center justify-between mb-3">
            <div class="w-10 h-10 bg-gradient-to-br from-cyan-500 to-cyan-600 rounded-lg flex items-center justify-center shadow-md">
                <span class="iconify text-white" data-icon="mdi:download" data-width="20"></span>
            </div>
            <div class="text-right">
                <p class="text-xs text-gray-600 font-medium mb-1">下行带宽</p>
                <p class="text-lg font-bold text-gray-800">
                    <span id="usedBandwidthDown">-</span>/<span id="quotaBandwidthDown">-</span>Mbps
                </p>
            </div>
        </div>
        <div class="w-full bg-gray-200 rounded-full h-1.5">
            <div id="bandwidthDownProgress" class="bg-cyan-600 h-1.5 rounded-full transition-all duration-300"
                 style="width: 0%"></div>
        </div>
    </div>

    <!-- 虚拟机数量 -->
    <div class="bg-white rounded-lg border border-gray-200 p-4 card-hover">
        <div class="flex items-center justify-between mb-3">
            <div class="w-10 h-10 bg-gradient-to-br from-orange-500 to-orange-600 rounded-lg flex items-center justify-center shadow-md">
                <span class="iconify text-white" data-icon="mdi:cube-outline" data-width="20"></span>
            </div>
            <div class="text-right">
                <p class="text-xs text-gray-600 font-medium mb-1">我的虚拟机</p>
                <p class="text-lg font-bold text-gray-800" id="myVmCount">-</p>
            </div>
        </div>
        <div class="pt-2 border-t border-gray-200">
            <div class="flex items-center justify-between text-xs">
                <span class="text-gray-600 flex items-center gap-1">
                    <span class="w-1.5 h-1.5 bg-green-500 rounded-full"></span>
                    运行中
                </span>
                <span class="font-medium text-gray-800" id="myRunningVm">-</span>
            </div>
        </div>
    </div>
</div>

<!-- 我的虚拟机 -->
<div class="bg-white rounded-lg border border-gray-200 card-hover">
    <div class="p-4 border-b border-gray-200 flex items-center justify-between">
        <h2 class="text-base font-semibold text-gray-800 flex items-center gap-2">
            <span class="iconify text-blue-600" data-icon="mdi:cube-outline" data-width="20"></span>
            我的虚拟机
        </h2>
        <button onclick="openCreateVmModal()"
                class="px-3 py-1.5 bg-blue-600 text-white text-sm font-medium rounded-lg hover:bg-blue-700 transition flex items-center gap-2"
                id="createVmBtn">
            <span class="iconify" data-icon="mdi:plus" data-width="16"></span>
            创建虚拟机
        </button>
    </div>
    <div id="myVmsList" class="p-4">
        <p class="text-center py-8 text-gray-500 text-xs flex items-center justify-center gap-2">
            <span class="iconify animate-pulse-slow" data-icon="mdi:loading" data-width="16"></span>
            <span data-i18n="加载中...">加载中...</span>
        </p>
    </div>
</div>

{% endif %}

{% if not (session.get('is_admin') or session.get('is_token_login')) %}
<!-- 创建虚拟机模态框 -->
<div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden" id="createVmModal">
    <div class="bg-white rounded-xl shadow-xl w-full max-w-4xl max-h-[90vh] overflow-hidden m-4">
        <!-- 模态框头部 -->
        <div class="px-6 py-4 border-b border-gray-200 flex items-center justify-between bg-gradient-to-r from-blue-50 to-indigo-50">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 bg-blue-600 rounded-lg flex items-center justify-center">
                    <span class="iconify text-white" data-icon="mdi:cube-plus" data-width="20"></span>
                </div>
                <div>
                    <h3 class="text-lg font-semibold text-gray-800">创建虚拟机</h3>
                    <p class="text-sm text-gray-600">根据您的资源配额创建新的虚拟机</p>
                </div>
            </div>
            <button onclick="closeCreateVmModal()" class="text-gray-400 hover:text-gray-600 transition">
                <span class="iconify" data-icon="mdi:close" data-width="24"></span>
            </button>
        </div>

        <!-- 模态框内容 -->
        <div class="p-6 max-h-[calc(90vh-200px)] overflow-y-auto">
            <form id="createVmForm" class="space-y-6">
                <!-- 基本信息 -->
                <div>
                    <h4 class="text-sm font-semibold text-gray-700 mb-3 flex items-center gap-2">
                        <span class="iconify text-blue-600" data-icon="mdi:information" data-width="16"></span>
                        基本信息
                    </h4>
                    <div class="flex gap-4">
                        <!-- 主机选择框（占剩余空间的50%） -->
                        <div style="flex: 1;">
                            <label class="block text-sm font-medium text-gray-700 mb-1">主机 <span
                                    class="text-red-500">*</span></label>
                            <select name="host_name" id="vmHost" required onchange="loadHostImages()"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                <option value="">请选择主机</option>
                            </select>
                        </div>
                        <!-- UUID输入框和随机按钮（固定宽度） -->
                        <div class="flex gap-2">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">虚拟机UUID</label>
                                <div class="flex gap-0">
                                    <span id="vmUuidPrefix" class="px-2 py-2 bg-gray-100 border border-r-0 border-gray-300 rounded-l-lg text-gray-600 whitespace-nowrap text-sm"></span>
                                    <input type="text" id="vmUuidInput" style="width: 100px;"
                                           class="px-2 py-2 border border-gray-300 rounded-r-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm"
                                           placeholder="随机生成" oninput="collectVmUuid()">
                                    <input type="hidden" name="vm_uuid" id="vmUuid">
                                </div>
                            </div>
                            <div style="align-self: flex-end;">
                                <button type="button" onclick="generateVmUuid()" 
                                        class="px-2 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors flex items-center gap-1 whitespace-nowrap text-sm">
                                    <span class="iconify" data-icon="mdi:refresh" data-width="16"></span>
                                    <span class="hidden lg:inline">随机</span>
                                </button>
                            </div>
                        </div>
                        <!-- 操作系统选择框（占剩余空间的50%） -->
                        <div style="flex: 1;">
                            <label class="block text-sm font-medium text-gray-700 mb-1">操作系统</label>
                            <select name="os_name" id="vmOsName" required onchange="updateVmMinDiskRequirement()"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                <option value="">请先选择主机</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- 密码和端口配置 -->
                <div>
                    <h4 class="text-sm font-semibold text-gray-700 mb-3 flex items-center gap-2">
                        <span class="iconify text-blue-600" data-icon="mdi:key" data-width="16"></span>
                        密码和端口配置
                    </h4>
                    <!-- 系统密码、VNC密码、VNC端口和随机按钮放一行 -->
                    <div class="flex gap-2 items-end">
                        <!-- 系统密码 -->
                        <div style="flex: 1;">
                            <label class="block text-sm font-medium text-gray-700 mb-1">系统密码</label>
                            <input type="text" name="os_pass" id="osPass" readonly
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-50 focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                   placeholder="自动生成密码">
                        </div>
                        <!-- VNC密码 -->
                        <div style="flex: 1;">
                            <label class="block text-sm font-medium text-gray-700 mb-1">VNC密码</label>
                            <input type="text" name="vc_pass" id="vcPass" readonly
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-50 focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                   placeholder="与系统密码一致">
                        </div>
                        <!-- VNC端口 -->
                        <div style="flex: 0 0 150px;">
                            <label class="block text-sm font-medium text-gray-700 mb-1">VNC端口</label>
                            <input type="number" name="vc_port" id="vcPort" min="5900" max="6999"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                   placeholder="VNC端口">
                        </div>
                        <!-- 随机按钮 -->
                        <button type="button" onclick="generateAllPasswordsAndPort()" 
                                class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors flex items-center gap-1 whitespace-nowrap">
                            <span class="iconify" data-icon="mdi:refresh" data-width="18"></span>
                            随机
                        </button>
                    </div>
                </div>
                <div>
                    <!-- 硬件配置 -->
                    <div>
                        <h4 class="text-sm font-semibold text-gray-700 mb-3 flex items-center gap-2">
                            <span class="iconify text-blue-600" data-icon="mdi:memory" data-width="16"></span>
                            硬件配置
                        </h4>
                        <div class="grid grid-cols-2 gap-4">
                            <!-- CPU核心数 -->
                            <div>
                                <div class="flex justify-between items-center mb-2">
                                    <label class="text-sm font-medium text-gray-700">
                                        CPU核心数 <span class="text-red-500">*</span>
                                    </label>
                                    <span class="text-sm text-gray-600">
                                        <span id="vmCpuNumDisplay">2</span>核 / <span id="availableCpu">-</span>核
                                    </span>
                                </div>
                                <input type="range" id="vmCpuNumSlider" min="1" max="1" value="2" step="1"
                                       class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer"
                                       oninput="updateCpuValue(this.value)">
                                <input type="hidden" name="cpu_num" id="vmCpuNum" value="2">
                            </div>
                            <!-- 内存 -->
                            <div>
                                <div class="flex justify-between items-center mb-2">
                                    <label class="text-sm font-medium text-gray-700">
                                        内存 (GB) <span class="text-red-500">*</span>
                                    </label>
                                    <span class="text-sm text-gray-600">
                                        <span id="vmRamNumDisplay">2</span>GB / <span id="availableRam">-</span>GB
                                    </span>
                                </div>
                                <input type="range" id="vmRamNumSlider" min="1" max="1" value="2" step="1"
                                       class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer"
                                       oninput="updateRamValue(this.value)">
                                <input type="hidden" name="mem_num" id="vmMemNum" value="2">
                            </div>
                            <!-- GPU ID -->
                            <div>
                                <div class="flex justify-between items-center mb-2">
                                    <label class="text-sm font-medium text-gray-700">GPU ID</label>
                                    <span class="text-sm text-gray-600">0 (固定)</span>
                                </div>
                                <input type="range" disabled value="0"
                                       class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-not-allowed opacity-50">
                                <input type="hidden" name="gpu_num" id="vmGpuNum" value="0">
                            </div>
                            <!-- GPU显存 -->
                            <div>
                                <div class="flex justify-between items-center mb-2">
                                    <label class="text-sm font-medium text-gray-700">GPU显存 (MB)</label>
                                    <span class="text-sm text-gray-600">
                                        <span id="vmGpuMemDisplay">128</span>MB / <span id="availableGpu">-</span>MB
                                    </span>
                                </div>
                                <input type="range" id="vmGpuMemSlider" min="4" max="32768" value="128" step="4"
                                       class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer"
                                       oninput="updateGpuMemValue(this.value)">
                                <input type="hidden" name="gpu_mem" id="vmGpuMem" value="128">
                            </div>
                            <!-- 硬盘 -->
                            <div>
                                <div class="flex justify-between items-center mb-2">
                                    <label class="text-sm font-medium text-gray-700">
                                        硬盘 (GB) <span class="text-red-500">*</span>
                                    </label>
                                    <span class="text-sm text-gray-600">
                                        <span id="vmHddNumDisplay">20</span>GB / <span id="availableSsd">-</span>GB
                                    </span>
                                </div>
                                <input type="range" id="vmHddNumSlider" min="10" max="100" value="20" step="1"
                                       class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer"
                                       oninput="updateHddValue(this.value)">
                                <input type="hidden" name="hdd_num" id="vmHddNum" value="20">
                            </div>
                            <!-- 流量限制 -->
                            <div>
                                <div class="flex justify-between items-center mb-2">
                                    <label class="text-sm font-medium text-gray-700">流量限制 (GB)</label>
                                    <span class="text-sm text-gray-600">
                                        <span id="vmFluNumDisplay">100</span>GB / <span id="availableTraffic">-</span>GB
                                    </span>
                                </div>
                                <input type="range" id="vmFluNumSlider" min="0" max="1000" value="100" step="1"
                                       class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer"
                                       oninput="updateFluValue(this.value)">
                                <input type="hidden" name="flu_num" id="vmFluNum" value="100">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 网络配置 -->
                <div>
                    <h4 class="text-sm font-semibold text-gray-700 mb-3 flex items-center gap-2">
                        <span class="iconify text-blue-600" data-icon="mdi:network" data-width="16"></span>
                        网络配置
                    </h4>
                        <div class="grid grid-cols-2 gap-4">
                            <!-- 上行带宽 -->
                            <div>
                                <div class="flex justify-between items-center mb-2">
                                    <label class="text-sm font-medium text-gray-700">上行带宽 (Mbps)</label>
                                    <span class="text-sm text-gray-600">
                                        <span id="vmSpeedUDisplay">100</span>Mbps / <span id="availableBandwidthUp">-</span>Mbps
                                    </span>
                                </div>
                                <input type="range" id="vmSpeedUSlider" min="1" max="1000" value="100" step="1"
                                       class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer"
                                       oninput="updateSpeedUValue(this.value)">
                                <input type="hidden" name="speed_u" id="vmSpeedU" value="100">
                            </div>
                            <!-- 下行带宽 -->
                            <div>
                                <div class="flex justify-between items-center mb-2">
                                    <label class="text-sm font-medium text-gray-700">下行带宽 (Mbps)</label>
                                    <span class="text-sm text-gray-600">
                                        <span id="vmSpeedDDisplay">100</span>Mbps / <span id="availableBandwidthDown">-</span>Mbps
                                    </span>
                                </div>
                                <input type="range" id="vmSpeedDSlider" min="1" max="1000" value="100" step="1"
                                       class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer"
                                       oninput="updateSpeedDValue(this.value)">
                                <input type="hidden" name="speed_d" id="vmSpeedD" value="100">
                            </div>
                            <!-- Web代理数量 -->
                            <div>
                                <div class="flex justify-between items-center mb-2">
                                    <label class="text-sm font-medium text-gray-700">Web代理数量</label>
                                    <span class="text-sm text-gray-600">
                                        <span id="vmWebNumDisplay">10</span>个 / <span id="availableWebProxy">-</span>个
                                    </span>
                                </div>
                                <input type="range" id="vmWebNumSlider" min="0" max="10" value="10" step="1"
                                       class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer"
                                       oninput="updateWebNumValue(this.value)">
                                <input type="hidden" name="web_num" id="vmWebNum" value="10">
                            </div>
                            <!-- NAT端口数量 -->
                            <div>
                                <div class="flex justify-between items-center mb-2">
                                    <label class="text-sm font-medium text-gray-700">NAT端口数量</label>
                                    <span class="text-sm text-gray-600">
                                        <span id="vmNatNumDisplay">10</span>个 / <span id="availableNatPorts">-</span>个
                                    </span>
                                </div>
                                <input type="range" id="vmNatNumSlider" min="1" max="20" value="10" step="1"
                                       class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer"
                                       oninput="updateNatNumValue(this.value)">
                                <input type="hidden" name="nat_num" id="vmNatNum" value="10">
                            </div>
                        </div>
                </div>

                <!-- 网卡配置 -->
                <div>
                    <h4 class="text-sm font-semibold text-gray-700 mb-3 flex items-center gap-2">
                        <span class="iconify text-blue-600" data-icon="mdi:ethernet" data-width="16"></span>
                        网卡配置
                    </h4>
                    <div id="nicConfigs" class="space-y-3">
                        <!-- 网卡配置将通过JavaScript动态添加 -->
                    </div>
                    <!-- IP配额信息 -->
                    <div id="dashboardIpQuotaInfo" class="mt-3 bg-gray-50 p-3 rounded-lg border border-gray-200">
                        <h5 class="text-sm font-semibold text-gray-700 mb-2">IP配额信息</h5>
                        <div id="dashboardQuotaDetails" class="text-xs text-gray-600 space-y-1">
                            <!-- 配额信息将通过JavaScript动态加载 -->
                        </div>
                    </div>
                    <button type="button" onclick="addNicConfig()"
                            class="mt-3 px-4 py-2 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-lg text-sm flex items-center gap-2">
                        <span class="iconify" data-icon="mdi:plus" data-width="16"></span>
                        添加网卡
                    </button>
                </div>
            </form>
        </div>

        <!-- 模态框底部 -->
        <div class="px-6 py-4 border-t border-gray-200 bg-gray-50 flex items-center justify-between">
            <div class="text-sm text-gray-600">
                创建虚拟机将消耗相应的资源配额
            </div>
            <div class="flex items-center gap-3">
                <button onclick="closeCreateVmModal()"
                        class="px-4 py-2 text-gray-700 bg-gray-200 hover:bg-gray-300 rounded-lg transition font-medium">
                    取消
                </button>
                <button onclick="createVm()"
                        class="px-4 py-2 bg-blue-600 text-white hover:bg-blue-700 rounded-lg transition font-medium flex items-center gap-2"
                        id="submitCreateVmBtn">
                    <span class="iconify" data-icon="mdi:plus" data-width="16"></span>
                    创建虚拟机
                </button>
            </div>
        </div>
    </div>
</div>

<style>
    /* 自定义滚动条样式 */
    #createVmModal .overflow-y-auto::-webkit-scrollbar {
        width: 6px;
    }

    #createVmModal .overflow-y-auto::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 3px;
    }

    #createVmModal .overflow-y-auto::-webkit-scrollbar-thumb {
        background: #c1c1c1;
        border-radius: 3px;
    }

    #createVmModal .overflow-y-auto::-webkit-scrollbar-thumb:hover {
        background: #a8a8a8;
    }
</style>

{% endif %}

<!-- 电源操作模态框 -->
<div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden" id="powerModal">
    <div class="bg-white rounded-xl shadow-xl w-full max-w-md m-4">
        <div class="px-6 py-4 border-b border-gray-200 flex items-center justify-between bg-gradient-to-r from-purple-50 to-indigo-50">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 bg-purple-600 rounded-lg flex items-center justify-center">
                    <span class="iconify text-white" data-icon="mdi:power" data-width="20"></span>
                </div>
                <div>
                    <h3 class="text-lg font-semibold text-gray-800">电源操作</h3>
                    <p class="text-sm text-gray-600">选择对虚拟机 "<span id="powerVmName" class="font-medium text-gray-800"></span>" 执行的操作</p>
                </div>
            </div>
            <button onclick="closePowerModal()" class="text-gray-400 hover:text-gray-600 transition">
                <span class="iconify" data-icon="mdi:close" data-width="24"></span>
            </button>
        </div>

        <div class="p-6">
            <div class="grid grid-cols-2 gap-3">
                <button type="button" onclick="vmPower('start')"
                        class="px-4 py-3 rounded-lg bg-green-500 hover:bg-green-600 text-white text-sm font-medium flex items-center justify-center gap-2 smooth-transition">
                    <span class="iconify" data-icon="mdi:play" data-width="20"></span>
                    启动
                </button>
                <button type="button" onclick="vmPower('stop')"
                        class="px-4 py-3 rounded-lg bg-yellow-500 hover:bg-yellow-600 text-white text-sm font-medium flex items-center justify-center gap-2 smooth-transition">
                    <span class="iconify" data-icon="mdi:stop" data-width="20"></span>
                    关机
                </button>
                <button type="button" onclick="vmPower('reset')"
                        class="px-4 py-3 rounded-lg bg-blue-500 hover:bg-blue-600 text-white text-sm font-medium flex items-center justify-center gap-2 smooth-transition">
                    <span class="iconify" data-icon="mdi:restart" data-width="20"></span>
                    重启
                </button>
                <button type="button" onclick="vmPower('pause')"
                        class="px-4 py-3 rounded-lg bg-gray-500 hover:bg-gray-600 text-white text-sm font-medium flex items-center justify-center gap-2 smooth-transition">
                    <span class="iconify" data-icon="mdi:pause" data-width="20"></span>
                    暂停
                </button>
                <button type="button" onclick="vmPower('resume')"
                        class="px-4 py-3 rounded-lg bg-indigo-500 hover:bg-indigo-600 text-white text-sm font-medium flex items-center justify-center gap-2 smooth-transition">
                    <span class="iconify" data-icon="mdi:play-pause" data-width="20"></span>
                    恢复
                </button>
                <button type="button" onclick="vmPower('hard_stop')"
                        class="px-4 py-3 rounded-lg bg-red-500 hover:bg-red-600 text-white text-sm font-medium flex items-center justify-center gap-2 smooth-transition">
                    <span class="iconify" data-icon="mdi:power-off" data-width="20"></span>
                    强制关机
                </button>
                <button type="button" onclick="vmPower('hard_reset')"
                        class="px-4 py-3 rounded-lg bg-orange-500 hover:bg-orange-600 text-white text-sm font-medium flex items-center justify-center gap-2 smooth-transition">
                    <span class="iconify" data-icon="mdi:restart-alert" data-width="20"></span>
                    强制重启
                </button>
            </div>
        </div>

        <div class="px-6 py-4 border-t border-gray-200 bg-gray-50 flex items-center justify-end">
            <button onclick="closePowerModal()"
                    class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 transition font-medium">
                取消
            </button>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_scripts %}
<script>
    $(document).ready(function () {
        loadDashboard();
        setInterval(loadDashboard, 30000);
    });

    async function loadDashboard() {
        // 根据页面元素判断用户权限类型并加载相应的仪表盘数据
        // 管理员视图有hostCount元素，普通用户视图有usedCpu元素
        if (document.getElementById('hostCount')) {
            await loadAdminDashboard();
        } else {
            await loadUserDashboard();
        }
    }

    async function loadAdminDashboard() {
        try {
            const result = await apiRequest('/api/system/statis');
            if (result && result.code === 200) {
                const stats = result.data;
                $('#hostCount').text(stats.host_count || 0);
                $('#vmCount').text(stats.vm_count || 0);
                $('#runningVm').text(stats.running_vm_count || 0);
            }

            const hostsResult = await apiRequest('/api/server/detail');
            if (hostsResult && hostsResult.code === 200) {
                renderHostsList(hostsResult.data);
            }

            const now = new Date();
            $('#lastUpdate').text(now.toLocaleTimeString('zh-CN', {
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            }));
        } catch (error) {
            console.error('加载数据失败:', error);
        }
    }

    async function loadUserDashboard() {
        try {
            // 加载用户资源使用情况
            const userResult = await apiRequest('/api/users/current');
            if (userResult && userResult.code === 200) {
                const user = userResult.data;
                updateUserResourceDisplay(user);
            }

            // 加载用户的虚拟机
            await loadUserVms();

            const now = new Date();
            $('#lastUpdate')?.text(now.toLocaleTimeString('zh-CN', {
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            }));
        } catch (error) {
            console.error('加载用户数据失败:', error);
        }
    }

function updateUserResourceDisplay(user) {
        // 更新资源使用显示
        $('#usedCpu').text(user.used_cpu || 0);
        $('#quotaCpu').text(user.quota_cpu || 0);
        
        // 内存和磁盘数据需要从MB转换为GB
        $('#usedRam').text(((user.used_ram || 0) / 1024).toFixed(1));
        $('#quotaRam').text(((user.quota_ram || 0) / 1024).toFixed(1));
        $('#usedSsd').text(((user.used_ssd || 0) / 1024).toFixed(1));
        $('#quotaSsd').text(((user.quota_ssd || 0) / 1024).toFixed(1));
        
// 新增资源字段 - GPU显存和流量数据需要从MB转换为GB
        $('#usedGpu').text(((user.used_gpu || 0) / 1024).toFixed(1));
        $('#quotaGpu').text(((user.quota_gpu || 0) / 1024).toFixed(1));
        $('#usedTraffic').text(((user.used_traffic || 0) / 1024).toFixed(1));
        $('#quotaTraffic').text(((user.quota_traffic || 0) / 1024).toFixed(1));
        $('#usedNatPorts').text(user.used_nat_ports || 0);
        $('#quotaNatPorts').text(user.quota_nat_ports || 0);
        $('#usedWebProxy').text(user.used_web_proxy || 0);
        $('#quotaWebProxy').text(user.quota_web_proxy || 0);
        $('#usedBandwidthUp').text(user.used_bandwidth_up || 0);
        $('#quotaBandwidthUp').text(user.quota_bandwidth_up || 0);
        $('#usedBandwidthDown').text(user.used_bandwidth_down || 0);
        $('#quotaBandwidthDown').text(user.quota_bandwidth_down || 0);

// 更新进度条
        const cpuPercent = user.quota_cpu > 0 ? (user.used_cpu / user.quota_cpu * 100) : 0;
        const ramPercent = user.quota_ram > 0 ? ((user.used_ram / 1024) / (user.quota_ram / 1024) * 100) : 0;
        const ssdPercent = user.quota_ssd > 0 ? ((user.used_ssd / 1024) / (user.quota_ssd / 1024) * 100) : 0;
const gpuPercent = user.quota_gpu > 0 ? ((user.used_gpu / 1024) / (user.quota_gpu / 1024) * 100) : 0;
        const trafficPercent = user.quota_traffic > 0 ? ((user.used_traffic / 1024) / (user.quota_traffic / 1024) * 100) : 0;
        const natPortsPercent = user.quota_nat_ports > 0 ? (user.used_nat_ports / user.quota_nat_ports * 100) : 0;
        const webProxyPercent = user.quota_web_proxy > 0 ? (user.used_web_proxy / user.quota_web_proxy * 100) : 0;
        const bandwidthUpPercent = user.quota_bandwidth_up > 0 ? (user.used_bandwidth_up / user.quota_bandwidth_up * 100) : 0;
        const bandwidthDownPercent = user.quota_bandwidth_down > 0 ? (user.used_bandwidth_down / user.quota_bandwidth_down * 100) : 0;

        $('#cpuProgress').css('width', cpuPercent + '%');
        $('#ramProgress').css('width', ramPercent + '%');
        $('#ssdProgress').css('width', ssdPercent + '%');
        $('#gpuProgress').css('width', gpuPercent + '%');
        $('#trafficProgress').css('width', trafficPercent + '%');
        $('#natPortsProgress').css('width', natPortsPercent + '%');
        $('#webProxyProgress').css('width', webProxyPercent + '%');
        $('#bandwidthUpProgress').css('width', bandwidthUpPercent + '%');
        $('#bandwidthDownProgress').css('width', bandwidthDownPercent + '%');

        // 根据使用率改变颜色
        if (cpuPercent > 90) $('#cpuProgress').removeClass('bg-blue-600').addClass('bg-red-600');
        if (ramPercent > 90) $('#ramProgress').removeClass('bg-green-600').addClass('bg-red-600');
        if (ssdPercent > 90) $('#ssdProgress').removeClass('bg-purple-600').addClass('bg-red-600');
        if (gpuPercent > 90) $('#gpuProgress').removeClass('bg-pink-600').addClass('bg-red-600');
        if (trafficPercent > 90) $('#trafficProgress').removeClass('bg-yellow-600').addClass('bg-red-600');
        if (natPortsPercent > 90) $('#natPortsProgress').removeClass('bg-indigo-600').addClass('bg-red-600');
        if (webProxyPercent > 90) $('#webProxyProgress').removeClass('bg-teal-600').addClass('bg-red-600');
        if (bandwidthUpPercent > 90) $('#bandwidthUpProgress').removeClass('bg-red-600').addClass('bg-red-800');
        if (bandwidthDownPercent > 90) $('#bandwidthDownProgress').removeClass('bg-cyan-600').addClass('bg-red-600');
    }

    async function loadUserVms() {
        try {
            // 获取用户有权限访问的主机
            const userResult = await apiRequest('/api/users/current');
            if (!userResult || userResult.code !== 200) {
                return;
            }

            const user = userResult.data;
            const assignedHosts = user.assigned_hosts || [];

            let allVms = [];
            let runningCount = 0;

            // 从每个主机获取虚拟机
            for (const hostName of assignedHosts) {
                try {
                    const vmsResult = await apiRequest(`/api/client/detail/${hostName}`);
                    if (vmsResult && vmsResult.code === 200) {
                        const vms = Object.entries(vmsResult.data || {});
                        allVms.push(...vms.map(([uuid, vm]) => ({uuid, ...vm, host: hostName})));

                        // 统计运行中的虚拟机
                        vms.forEach(([uuid, vm]) => {
                            if (vm.power === 'powered_on') runningCount++;
                        });
                    }
                } catch (error) {
                    console.error(`加载主机 ${hostName} 的虚拟机失败:`, error);
                }
            }

            // 更新虚拟机计数
            $('#myVmCount').text(allVms.length);
            $('#myRunningVm').text(runningCount);

            // 渲染虚拟机列表
            renderMyVmsList(allVms);
        } catch (error) {
            console.error('加载用户虚拟机失败:', error);
            $('#myVmsList').html('<p class="text-center py-8 text-gray-500 text-sm">加载失败，请刷新页面重试</p>');
        }
    }

    // 状态文字映射
    const statusMap = {
        'STOPPED': {text: '已停止', color: 'text-gray-600 bg-gray-100'},
        'STARTED': {text: '运行中', color: 'text-green-700 bg-green-100', pulse: true},
        'SUSPEND': {text: '已暂停', color: 'text-yellow-700 bg-yellow-100'},
        'ON_STOP': {text: '停止中', color: 'text-orange-600 bg-orange-100'},
        'ON_OPEN': {text: '启动中', color: 'text-blue-600 bg-blue-100'},
        'CRASHED': {text: '已崩溃', color: 'text-red-700 bg-red-100'},
        'UNKNOWN': {text: '未知', color: 'text-gray-500 bg-gray-100'}
    };

    // 格式化内存显示
    function formatMemory(mb) {
        if (!mb) return '0 MB';
        if (mb >= 1024) return `${(mb / 1024).toFixed(1)} GB`;
        return `${mb} MB`;
    }

    // 格式化磁盘显示
    function formatDisk(mb) {
        if (!mb) return '0 MB';
        if (mb >= 1024) return `${(mb / 1024).toFixed(1)} GB`;
        return `${mb} MB`;
    }

    function renderMyVmsList(vms) {
        const container = document.getElementById('myVmsList');

        if (vms.length === 0) {
            container.innerHTML = `
                <div class="text-center py-8">
                    <span class="iconify text-gray-300" data-icon="mdi:cube-off" data-width="48"></span>
                    <p class="mt-4 text-gray-500 text-sm">暂无虚拟机</p>
                    <p class="text-xs text-gray-400 mt-1">请联系管理员为您分配权限</p>
                </div>
            `;
            return;
        }

        let html = '<div class="grid grid-cols-1 lg:grid-cols-2 gap-4">';
        vms.forEach(vm => {
            const config = vm.config || {};
            // status现在是数组 list[HWStatus]，取第一个元素的ac_status作为电源状态
            const statusList = vm.status || [];
            const firstStatus = statusList.length > 0 ? statusList[0] : {};
            const powerStatus = firstStatus.ac_status || 'UNKNOWN';
            const statusInfo = statusMap[powerStatus] || statusMap['UNKNOWN'];

            // 获取网卡信息
            const nicAll = config.nic_all || {};
            const firstNic = Object.values(nicAll)[0] || {};
            const ipv4 = firstNic.ip4_addr || '-';
            const ipv6 = firstNic.ip6_addr || '-';
            const macAddr = firstNic.mac_addr || '-';

            // 计算端口使用情况
            const natTotal = config.nat_num || 0;
            const webTotal = config.web_num || 0;

            html += `
                <div class="bg-white rounded-lg border border-gray-200 card-hover overflow-hidden">
                    <div class="p-4">
                        <div class="flex items-start justify-between mb-4">
                            <div class="flex items-center gap-3">
                                <div class="w-12 h-12 bg-gradient-to-br from-purple-500 to-purple-600 rounded-lg flex items-center justify-center shadow-md">
                                    <span class="iconify text-white" data-icon="mdi:cube-outline" data-width="28"></span>
                                </div>
                                <div>
                                    <h3 class="font-semibold text-gray-800">${vm.display_name || vm.uuid}</h3>
                                    <p class="text-sm text-gray-500">${vm.host} - ${config.os_name || '未知系统'}</p>
                                </div>
                            </div>
                            <span class="px-2 py-1 text-xs font-medium ${statusInfo.color} rounded-full flex items-center gap-1">
                                ${statusInfo.pulse ? '<span class="w-1.5 h-1.5 bg-green-500 rounded-full animate-pulse"></span>' : ''}
                                ${statusInfo.text}
                            </span>
                        </div>
                        
                        <!-- 基础资源信息 -->
                        <div class="grid grid-cols-2 gap-3 text-sm mb-4">
                            <div class="flex items-center gap-2 text-gray-600">
                                <span class="iconify" data-icon="mdi:chip" data-width="16"></span>
                                <span>CPU: <span class="font-medium text-gray-800">${config.cpu_num || 0} 核</span></span>
                            </div>
                            <div class="flex items-center gap-2 text-gray-600">
                                <span class="iconify" data-icon="mdi:memory" data-width="16"></span>
                                <span>内存: <span class="font-medium text-gray-800">${formatMemory(config.mem_num)}</span></span>
                            </div>
                            <div class="flex items-center gap-2 text-gray-600">
                                <span class="iconify" data-icon="mdi:harddisk" data-width="16"></span>
                                <span>硬盘: <span class="font-medium text-gray-800">${formatDisk(config.hdd_num)}</span></span>
                            </div>
                            <div class="flex items-center gap-2 text-gray-600">
                                <span class="iconify" data-icon="mdi:video" data-width="16"></span>
                                <span>显存: <span class="font-medium text-gray-800">${formatMemory(config.gpu_mem)}</span></span>
                            </div>
                        </div>
                        
                        <!-- 端口信息 -->
                        <div class="grid grid-cols-2 gap-3 text-sm mb-4 p-3 bg-gray-50 rounded-lg">
                            <div class="flex items-center gap-2 text-gray-600">
                                <span class="iconify" data-icon="mdi:lan" data-width="16"></span>
                                <span>NAT端口: <span class="font-medium text-gray-800">${natTotal}个</span></span>
                            </div>
                            <div class="flex items-center gap-2 text-gray-600">
                                <span class="iconify" data-icon="mdi:web" data-width="16"></span>
                                <span>Web代理: <span class="font-medium text-gray-800">${webTotal}个</span></span>
                            </div>
                        </div>
                        
                        <!-- 网卡信息 -->
                        <div class="text-sm p-3 bg-blue-50 rounded-lg border border-blue-200">
                            <div class="flex items-center gap-2 text-blue-700 font-medium mb-2">
                                <span class="iconify" data-icon="mdi:ethernet" data-width="16"></span>
                                <span>网卡信息</span>
                            </div>
                            <div class="space-y-1 text-xs">
                                <div class="flex items-center gap-2">
                                    <span class="text-gray-500 w-12">IPv4:</span>
                                    <span class="font-mono text-gray-700 break-all">${ipv4}</span>
                                </div>
                                <div class="flex items-center gap-2">
                                    <span class="text-gray-500 w-12">IPv6:</span>
                                    <span class="font-mono text-gray-700 break-all">${ipv6 !== '-' ? ipv6 : '未配置'}</span>
                                </div>
                                <div class="flex items-center gap-2">
                                    <span class="text-gray-500 w-12">MAC:</span>
                                    <span class="font-mono text-gray-700">${macAddr}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="border-t border-gray-200 px-4 py-3 bg-gray-50 flex items-center justify-between">
                        <a href="/hosts/${vm.host}/vms/${vm.uuid}" class="text-purple-600 hover:text-purple-800 text-sm font-medium flex items-center gap-1">
                            <span class="iconify" data-icon="mdi:information-outline" data-width="16"></span>
                            查看详情
                        </a>
                        <div class="flex items-center gap-2">
                            <button type="button" onclick="openVncConsole('${vm.uuid}', '${vm.host}')" 
                                class="px-3 py-1.5 rounded-lg bg-cyan-100 hover:bg-cyan-200 text-cyan-700 text-sm font-medium flex items-center gap-1" title="VNC控制台">
                                <span class="iconify" data-icon="mdi:monitor" data-width="16"></span>
                                VNC控制台
                            </button>
                            <button type="button" onclick="openPowerModal('${vm.uuid}', '${vm.host}')" 
                                class="p-2 rounded-lg hover:bg-gray-200 text-gray-600" title="电源管理">
                                <span class="iconify" data-icon="mdi:power" data-width="18"></span>
                            </button>
                        </div>
                    </div>
                </div>
            `;
        });

        html += '</div>';
        container.innerHTML = html;
    }

    function renderHostsList(hosts) {
        const container = document.getElementById('hostsList');
        const hostsList = Object.entries(hosts);

        if (hostsList.length === 0) {
            container.innerHTML = `
                <div class="text-center py-8">
                    <span class="iconify text-gray-300" data-icon="mdi:server-off" data-width="48"></span>
                    <p class="mt-4 text-gray-500 text-sm">暂无主机</p>
                    <a href="/hosts" class="mt-2 inline-block text-blue-600 hover:text-blue-800 text-sm">添加主机</a>
                </div>
            `;
            return;
        }

        let html = '<div class="space-y-2">';
        hostsList.slice(0, 5).forEach(([name, host]) => {
            html += `
                <a href="/hosts/${name}/vms" class="flex items-center justify-between p-3 border border-gray-200 rounded-lg hover:border-blue-300 hover:bg-blue-50 smooth-transition group">
                    <div class="flex items-center gap-3 flex-1 min-w-0">
                        <div class="w-8 h-8 bg-gradient-to-br from-blue-500 to-blue-600 rounded-lg flex items-center justify-center flex-shrink-0 shadow-sm">
                            <span class="iconify text-white" data-icon="mdi:server" data-width="16"></span>
                        </div>
                        <div class="flex-1 min-w-0">
                            <p class="text-sm font-semibold text-gray-800 truncate">${name}</p>
                            <p class="text-xs text-gray-600 truncate">${host.addr || '未配置'}</p>
                        </div>
                    </div>
                    <div class="flex items-center gap-2 flex-shrink-0">
                        <span class="text-xs text-gray-600">${host.vm_count || 0} 台VM</span>
                        <span class="iconify text-gray-400 group-hover:text-blue-600 smooth-transition" data-icon="mdi:chevron-right" data-width="16"></span>
                    </div>
                </a>
            `;
        });

        if (hostsList.length > 5) {
            html += `
                <a href="/hosts" class="flex items-center justify-center p-3 border border-gray-200 border-dashed rounded-lg hover:border-blue-300 hover:bg-blue-50 transition text-xs text-gray-600 hover:text-blue-600 font-medium">
                    查看全部 ${hostsList.length} 个主机 →
                </a>
            `;
        }

        html += '</div>';
        container.innerHTML = html;
    }

    async function saveAll() {
        const result = await apiRequest('/api/system/saving', 'POST');
        if (result && result.code === 200) {
            showToast('配置已保存', 'success');
        } else {
            showToast(result?.msg || '保存失败', 'error');
        }
    }

    // 创建虚拟机相关函数
    let currentUser = null;
    let availableImages = [];
    let currentPowerVm = '';
    let currentPowerHost = '';

    async function openCreateVmModal() {
        // 获取用户信息和可用资源
        try {
            const userResult = await apiRequest('/api/users/current');
            if (userResult.code === 200) {
                currentUser = userResult.data;

                // 检查创建权限
                if (!currentUser.can_create_vm) {
                    showToast('您没有创建虚拟机的权限', 'error');
                    return;
                }

                updateAvailableResources();
                await loadAvailableHosts();

                // 初始化网卡配置
                document.getElementById('nicConfigs').innerHTML = '';
                nicCounter = 0;
                addNicConfig();
                
                // 加载IP配额信息
                loadDashboardUserIPQuota();

                // 生成随机密码并同步
                generatePasswordAndSync();

                // 生成随机VNC端口
                generateRandomVncPortForInput();
            } else {
                showToast('获取用户信息失败', 'error');
                return;
            }
        } catch (error) {
            console.error('加载用户信息失败:', error);
            showToast('加载用户信息失败', 'error');
            return;
        }

        // 显示模态框
        document.getElementById('createVmModal').classList.remove('hidden');
    }

    function generateRandomVmName() {
        const prefixes = ['vm', 'srv', 'host', 'node'];
        const suffixes = ['001', '002', '003', '004', '005', '006', '007', '008', '009', '010'];
        const randomPrefix = prefixes[Math.floor(Math.random() * prefixes.length)];
        const randomSuffix = suffixes[Math.floor(Math.random() * suffixes.length)];
        const randomNum = Math.floor(Math.random() * 1000);
        const vmName = `${randomPrefix}-${randomSuffix}-${randomNum}`;

        // 这个函数不再需要，因为删除了虚拟机名称字段
        return vmName;
    }

    function closeCreateVmModal() {
        document.getElementById('createVmModal').classList.add('hidden');
        document.getElementById('createVmForm').reset();
    }

    // 生成密码并同步到VNC密码
    function generatePasswordAndSync() {
        const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789!@#$%^&*';
        let result = '';
        for (let i = 0; i < 12; i++) {
            result += chars.charAt(Math.floor(Math.random() * chars.length));
        }
        document.getElementById('osPass').value = result;
        document.getElementById('vcPass').value = result;
    }

    // 保留旧函数以兼容
    function generateOsPass() {
        generatePasswordAndSync();
    }

    function copyOsPassToVnc() {
        generatePasswordAndSync();
    }

    // 生成随机VNC端口
    function generateRandomVncPortForInput() {
        const randomPort = Math.floor(Math.random() * (6999 - 5900 + 1)) + 5900;
        document.getElementById('vcPort').value = randomPort;
    }

    // 加载仪表板用户IP配额信息
    async function loadDashboardUserIPQuota() {
        try {
            const result = await apiRequest('/api/users/current');
            if (result && result.code === 200) {
                const user = result.data;
                const quotaDetails = document.getElementById('dashboardQuotaDetails');
                
                quotaDetails.innerHTML = `
                    <div class="flex justify-between">
                        <span>内网IP配额:</span>
                        <span class="font-mono">${user.used_nat_ips || 0}/${user.quota_nat_ips || 0}</span>
                    </div>
                    <div class="flex justify-between">
                        <span>公网IP配额:</span>
                        <span class="font-mono">${user.used_pub_ips || 0}/${user.quota_pub_ips || 0}</span>
                    </div>
                `;
            }
        } catch (error) {
            console.error('加载用户配额失败:', error);
            document.getElementById('dashboardQuotaDetails').innerHTML = '<div class="text-red-500">配额信息加载失败</div>';
        }
    }

    // 网卡配置相关变量
    let nicCounter = 0;

    // 添加网卡配置
    function addNicConfig(nicName = '', nicType = 'nat', nicIp = '') {
        nicCounter++;
        if (!nicName) {
            nicName = `ethernet${nicCounter - 1}`;
        }

        const container = document.getElementById('nicConfigs');
        const nicHtml = `
            <div class="flex items-center gap-2 p-3 bg-gray-50 rounded-lg" id="nic_${nicCounter}">
                <input type="text" name="nic_name_${nicCounter}" value="${nicName}" placeholder="网卡名称" readonly
                    class="flex-1 px-3 py-2 text-sm border border-gray-300 rounded bg-gray-100 cursor-not-allowed">
                <select name="nic_type_${nicCounter}" class="px-3 py-2 text-sm border border-gray-300 rounded focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    <option value="nat" ${nicType === 'nat' ? 'selected' : ''}>内网</option>
                    <option value="pub" ${nicType === 'pub' ? 'selected' : ''}>公网</option>
                </select>
                <input type="text" name="nic_ip_${nicCounter}" value="${nicIp}" placeholder="IPv4地址" readonly
                    class="flex-1 px-3 py-2 text-sm border border-gray-300 rounded bg-gray-100 cursor-not-allowed">
                <button type="button" onclick="removeNicConfig(${nicCounter})" class="p-2 text-red-500 hover:bg-red-50 rounded-lg transition">
                    <span class="iconify" data-icon="mdi:close" data-width="16"></span>
                </button>
            </div>
        `;
        container.insertAdjacentHTML('beforeend', nicHtml);
    }

    // 移除网卡配置
    function removeNicConfig(id) {
        const element = document.getElementById(`nic_${id}`);
        if (element) {
            element.remove();
        }
    }

    function updateAvailableResources() {
        if (!currentUser) return;

        const availableCpu = (currentUser.quota_cpu || 0) - (currentUser.used_cpu || 0);
        const availableRamMB = (currentUser.quota_ram || 0) - (currentUser.used_ram || 0);
        const availableSsdMB = (currentUser.quota_ssd || 0) - (currentUser.used_ssd || 0);
        const availableGpu = (currentUser.quota_gpu || 0) - (currentUser.used_gpu || 0);
        const availableTrafficMB = (currentUser.quota_traffic || 0) - (currentUser.used_traffic || 0);
        const availableBandwidthUp = currentUser.quota_bandwidth_up || 0;
        const availableBandwidthDown = currentUser.quota_bandwidth_down || 0;
        const availableNatPorts = (currentUser.quota_nat_ports || 0) - (currentUser.used_nat_ports || 0);
        const availableWebProxy = (currentUser.quota_web_proxy || 0) - (currentUser.used_web_proxy || 0);
        
        // 转换为GB
        const availableRamGB = Math.floor(availableRamMB / 1024);
        const availableSsdGB = Math.floor(availableSsdMB / 1024);
        const availableGpuGB = Math.floor(availableGpu / 1024);
        const availableTrafficGB = Math.floor(availableTrafficMB / 1024);

        // 更新可用资源显示
        document.getElementById('availableCpu').textContent = availableCpu;
        document.getElementById('availableRam').textContent = availableRamGB;
        document.getElementById('availableSsd').textContent = availableSsdGB;
        if (document.getElementById('availableGpu')) {
            document.getElementById('availableGpu').textContent = availableGpuGB;
        }
        if (document.getElementById('availableTraffic')) {
            document.getElementById('availableTraffic').textContent = availableTrafficGB;
        }
        if (document.getElementById('availableBandwidthUp')) {
            document.getElementById('availableBandwidthUp').textContent = availableBandwidthUp;
        }
        if (document.getElementById('availableBandwidthDown')) {
            document.getElementById('availableBandwidthDown').textContent = availableBandwidthDown;
        }
        if (document.getElementById('availableNatPorts')) {
            document.getElementById('availableNatPorts').textContent = availableNatPorts;
        }
        if (document.getElementById('availableWebProxy')) {
            document.getElementById('availableWebProxy').textContent = availableWebProxy;
        }

        // 设置输入框和滑动条的最大值
        const cpuInput = document.getElementById('vmCpuNum');
        const cpuSlider = document.getElementById('vmCpuNumSlider');
        const ramInput = document.getElementById('vmRamNum');
        const ramSlider = document.getElementById('vmRamNumSlider');
        const hddInput = document.getElementById('vmHddNum');
        const hddSlider = document.getElementById('vmHddNumSlider');
        const gpuMemInput = document.getElementById('vmGpuMem');
        const gpuMemSlider = document.getElementById('vmGpuMemSlider');
        const fluInput = document.getElementById('vmFluNum');
        const fluSlider = document.getElementById('vmFluNumSlider');
        const speedUInput = document.getElementById('vmSpeedU');
        const speedUSlider = document.getElementById('vmSpeedUSlider');
        const speedDInput = document.getElementById('vmSpeedD');
        const speedDSlider = document.getElementById('vmSpeedDSlider');
        const webNumInput = document.getElementById('vmWebNum');
        const webNumSlider = document.getElementById('vmWebNumSlider');
        const natNumInput = document.getElementById('vmNatNum');
        const natNumSlider = document.getElementById('vmNatNumSlider');

        if (cpuInput && cpuSlider) {
            cpuInput.max = availableCpu;
            cpuSlider.max = availableCpu;
            const defaultCpu = Math.min(2, availableCpu);
            cpuInput.value = defaultCpu;
            cpuSlider.value = defaultCpu;
            document.getElementById('vmCpuNumDisplay').textContent = defaultCpu;
        }

        if (ramInput && ramSlider) {
            ramInput.max = availableRamGB;
            ramSlider.max = availableRamGB;
            const defaultRam = Math.min(2, availableRamGB);
            ramInput.value = defaultRam;
            ramSlider.value = defaultRam;
            document.getElementById('vmRamNumDisplay').textContent = defaultRam;
        }

        if (hddInput && hddSlider) {
            hddInput.max = availableSsdGB;
            hddSlider.max = availableSsdGB;
            const defaultHdd = Math.min(20, availableSsdGB);
            hddInput.value = defaultHdd;
            hddSlider.value = defaultHdd;
            document.getElementById('vmHddNumDisplay').textContent = defaultHdd;
        }

        // 设置GPU显存限制（MB）
        if (gpuMemInput && gpuMemSlider) {
            const availableGpuMB = Math.round(availableGpuGB * 1024); // 转换为MB
            gpuMemInput.max = availableGpuMB;
            gpuMemSlider.max = availableGpuMB;
            const defaultGpuMem = Math.min(128, availableGpuMB); // 默认128MB
            gpuMemInput.value = defaultGpuMem;
            gpuMemSlider.value = defaultGpuMem;
            document.getElementById('vmGpuMemDisplay').textContent = defaultGpuMem;
        }

        // 设置流量限制（GB）
        if (fluInput && fluSlider) {
            fluInput.max = availableTrafficGB;
            fluSlider.max = availableTrafficGB;
            const defaultFlu = Math.min(100, availableTrafficGB);
            fluInput.value = defaultFlu;
            fluSlider.value = defaultFlu;
            document.getElementById('vmFluNumDisplay').textContent = defaultFlu;
        }

        // 设置上行带宽限制（Mbps）
        if (speedUInput && speedUSlider) {
            speedUInput.max = availableBandwidthUp;
            speedUSlider.max = availableBandwidthUp;
            const defaultSpeedU = Math.min(100, availableBandwidthUp);
            speedUInput.value = defaultSpeedU;
            speedUSlider.value = defaultSpeedU;
            document.getElementById('vmSpeedUDisplay').textContent = defaultSpeedU;
        }

        // 设置下行带宽限制（Mbps）
        if (speedDInput && speedDSlider) {
            speedDInput.max = availableBandwidthDown;
            speedDSlider.max = availableBandwidthDown;
            const defaultSpeedD = Math.min(100, availableBandwidthDown);
            speedDInput.value = defaultSpeedD;
            speedDSlider.value = defaultSpeedD;
            document.getElementById('vmSpeedDDisplay').textContent = defaultSpeedD;
        }

        // 设置Web代理数量限制
        if (webNumInput && webNumSlider) {
            webNumInput.max = availableWebProxy;
            webNumSlider.max = availableWebProxy;
            const defaultWebNum = Math.min(10, availableWebProxy);
            webNumInput.value = defaultWebNum;
            webNumSlider.value = defaultWebNum;
            document.getElementById('vmWebNumDisplay').textContent = defaultWebNum;
        }

        // 设置NAT端口数量限制
        if (natNumInput && natNumSlider) {
            natNumInput.max = availableNatPorts;
            natNumSlider.max = availableNatPorts;
            const defaultNatNum = Math.min(10, availableNatPorts);
            natNumInput.value = defaultNatNum;
            natNumSlider.value = defaultNatNum;
            document.getElementById('vmNatNumDisplay').textContent = defaultNatNum;
        }
    }

    // 滑动条和输入框同步函数
    function updateCpuValue(value) {
        document.getElementById('vmCpuNum').value = value;
        document.getElementById('vmCpuNumDisplay').textContent = value;
    }
    
    function updateCpuSlider(value) {
        document.getElementById('vmCpuNumSlider').value = value;
    }
    
    function updateRamValue(value) {
        document.getElementById('vmRamNum').value = value;
        document.getElementById('vmRamNumDisplay').textContent = value;
    }
    
    function updateRamSlider(value) {
        document.getElementById('vmRamNumSlider').value = value;
    }
    
    function updateHddValue(value) {
        document.getElementById('vmHddNum').value = value;
        document.getElementById('vmHddNumDisplay').textContent = value;
    }
    
    function updateHddSlider(value) {
        document.getElementById('vmHddNumSlider').value = value;
    }
    
    function updateGpuMemValue(value) {
        const valueGB = parseFloat(value);
        const valueMB = Math.round(valueGB * 1024); // 转换为MB
        document.getElementById('vmGpuMem').value = valueMB;
        document.getElementById('vmGpuMemDisplay').textContent = valueGB;
    }
    
    function updateGpuMemSlider(value) {
        document.getElementById('vmGpuMemSlider').value = value;
    }
    
    function updateFluValue(value) {
        document.getElementById('vmFluNum').value = value;
        document.getElementById('vmFluNumDisplay').textContent = value;
    }
    
    function updateFluSlider(value) {
        document.getElementById('vmFluNumSlider').value = value;
    }
    
    function updateSpeedUValue(value) {
        document.getElementById('vmSpeedU').value = value;
        document.getElementById('vmSpeedUDisplay').textContent = value;
    }
    
    function updateSpeedUSlider(value) {
        document.getElementById('vmSpeedUSlider').value = value;
    }
    
    function updateSpeedDValue(value) {
        document.getElementById('vmSpeedD').value = value;
        document.getElementById('vmSpeedDDisplay').textContent = value;
    }
    
    function updateSpeedDSlider(value) {
        document.getElementById('vmSpeedDSlider').value = value;
    }
    
    function updateWebNumValue(value) {
        document.getElementById('vmWebNum').value = value;
        document.getElementById('vmWebNumDisplay').textContent = value;
    }
    
    function updateWebNumSlider(value) {
        document.getElementById('vmWebNumSlider').value = value;
    }
    
    function updateNatNumValue(value) {
        document.getElementById('vmNatNum').value = value;
        document.getElementById('vmNatNumDisplay').textContent = value;
    }
    
    function updateNatNumSlider(value) {
        document.getElementById('vmNatNumSlider').value = value;
    }


    async function loadAvailableHosts() {
        try {
            const userResult = await apiRequest('/api/users/current');
            if (userResult.code === 200) {
                const user = userResult.data;
                const assignedHosts = user.assigned_hosts || [];
                const hostSelect = document.getElementById('vmHost');

                hostSelect.innerHTML = '<option value="">请选择主机</option>';

                // 获取所有主机信息
                const hostResult = await apiRequest('/api/server/detail');
                if (hostResult.code === 200 && hostResult.data) {
                    const allHosts = hostResult.data;
                    
                    // 如果用户是管理员，显示所有主机
                    if (user.is_admin) {
                        for (const hostName in allHosts) {
                            const option = document.createElement('option');
                            option.value = hostName;
                            option.textContent = `${hostName} (${allHosts[hostName].addr || '未知地址'})`;
                            hostSelect.appendChild(option);
                        }
                    } else if (assignedHosts.length > 0) {
                        // 普通用户只显示分配的主机
                        for (const hostName of assignedHosts) {
                            if (allHosts[hostName]) {
                                const option = document.createElement('option');
                                option.value = hostName;
                                option.textContent = `${hostName} (${allHosts[hostName].addr || '未知地址'})`;
                                hostSelect.appendChild(option);
                            }
                        }
                    } else {
                        // 普通用户没有分配主机，显示提示
                        const option = document.createElement('option');
                        option.value = '';
                        option.textContent = '暂无可用主机，请联系管理员';
                        hostSelect.appendChild(option);
                    }
                }
            }
        } catch (error) {
            console.error('加载主机列表失败:', error);
        }
    }

    // 生成随机字符串（只包含字母和数字）
    function generateRandomString(length) {
        const letters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz';
        const numbers = '0123456789';
        
        // 确保至少包含一个字母和一个数字
        let result = '';
        result += letters.charAt(Math.floor(Math.random() * letters.length));
        result += numbers.charAt(Math.floor(Math.random() * numbers.length));
        
        // 填充剩余字符
        const allChars = letters + numbers;
        for (let i = result.length; i < length; i++) {
            result += allChars.charAt(Math.floor(Math.random() * allChars.length));
        }
        
        // 打乱顺序
        return result.split('').sort(() => Math.random() - 0.5).join('');
    }

    // 生成UUID
    function generateVmUuid() {
        const randomStr = generateRandomString(8);
        document.getElementById('vmUuidInput').value = randomStr;
        collectVmUuid();
    }

    // 收集完整UUID
    function collectVmUuid() {
        const hostSelect = document.getElementById('vmHost');
        const selectedHost = hostSelect.value;
        
        let prefix = '';
        if (selectedHost && window.hostConfigs && window.hostConfigs[selectedHost]) {
            prefix = window.hostConfigs[selectedHost].filter_name || '';
        }
        
        const prefixWithHyphen = prefix ? (prefix.endsWith('-') ? prefix : prefix + '-') : '';
        const input = document.getElementById('vmUuidInput').value || '';
        document.getElementById('vmUuid').value = prefixWithHyphen + input;
    }

    // 更新UUID前缀显示
    function updateVmUuidPrefix() {
        const hostSelect = document.getElementById('vmHost');
        const selectedHost = hostSelect.value;
        
        if (!selectedHost || !window.hostConfigs || !window.hostConfigs[selectedHost]) {
            document.getElementById('vmUuidPrefix').textContent = '';
            return;
        }
        
        const hostConfig = window.hostConfigs[selectedHost];
        const prefix = hostConfig.filter_name || '';
        const prefixSpan = document.getElementById('vmUuidPrefix');
        if (prefixSpan) {
            prefixSpan.textContent = prefix ? (prefix.endsWith('-') ? prefix : prefix + '-') : '';
        }
    }

    // 生成所有密码和端口
    function generateAllPasswordsAndPort() {
        generatePasswordAndSync();
        generateRandomVncPortForInput();
    }

    async function loadHostImages() {
        const hostSelect = document.getElementById('vmHost');
        const osSelect = document.getElementById('vmOsName');
        const selectedHost = hostSelect.value;

        if (!selectedHost) {
            osSelect.innerHTML = '<option value="">请先选择主机</option>';
            return;
        }

        try {
            // 获取指定主机的系统镜像列表
            const imagesResult = await apiRequest(`/api/client/os-images/${selectedHost}`);
            if (imagesResult.code === 200 && imagesResult.data && imagesResult.data.system_maps) {
                // 保存主机配置到全局变量
                if (!window.hostConfigs) {
                    window.hostConfigs = {};
                }
                window.hostConfigs[selectedHost] = imagesResult.data;
                
                const systemMaps = imagesResult.data.system_maps;

                osSelect.innerHTML = '<option value="">请选择系统镜像</option>';

                // system_maps是对象，需要遍历键名
                for (const imageName in systemMaps) {
                    const option = document.createElement('option');
                    option.value = imageName;
                    option.textContent = imageName;
                    // 将最小磁盘大小存储在data属性中
                    const osConfig = systemMaps[imageName];
                    const minDiskGB = Array.isArray(osConfig) && osConfig[1] ? osConfig[1] : 10;
                    option.setAttribute('data-min-disk', minDiskGB);
                    osSelect.appendChild(option);
                }
                
                // 更新UUID前缀并生成UUID
                updateVmUuidPrefix();
                generateVmUuid();
                // 更新最小硬盘要求提示
                updateVmMinDiskRequirement();
            } else {
                osSelect.innerHTML = '<option value="">该主机暂无可用镜像</option>';
            }
        } catch (error) {
            console.error('加载系统镜像失败:', error);
            osSelect.innerHTML = '<option value="">加载镜像失败</option>';
        }
    }

    // 获取当前选择的操作系统的最小硬盘要求（GB）
    function getVmMinDiskRequirement() {
        const osSelect = document.getElementById('vmOsName');
        const selectedOption = osSelect.options[osSelect.selectedIndex];
        if (selectedOption && selectedOption.value) {
            return parseInt(selectedOption.getAttribute('data-min-disk')) || 10;
        }
        return 10; // 默认10GB
    }

    // 更新最小硬盘要求提示
    function updateVmMinDiskRequirement() {
        const minDiskGB = getVmMinDiskRequirement();
        const hddDisplay = document.getElementById('vmHddNumDisplay');
        
        // 查找或创建提示元素
        let hintElement = document.getElementById('vmHddMinHint');
        if (!hintElement) {
            hintElement = document.createElement('div');
            hintElement.id = 'vmHddMinHint';
            hintElement.className = 'text-xs text-gray-500 mt-1';
            // 在硬盘滑块下方添加提示
            const hddSlider = document.getElementById('vmHddNumSlider');
            hddSlider.parentElement.appendChild(hintElement);
        }
        
        // 更新提示文本
        const osSelect = document.getElementById('vmOsName');
        if (osSelect.value) {
            hintElement.textContent = `最小要求: ${minDiskGB}GB`;
            hintElement.style.display = 'block';
        } else {
            hintElement.style.display = 'none';
        }
    }

    async function createVm() {
        // 确保UUID包含前缀
        collectVmUuid();
        
        const form = document.getElementById('createVmForm');
        if (!form.checkValidity()) {
            form.reportValidity();
            return;
        }

        const formData = new FormData(form);

        // 收集网卡配置
        const nicAll = {};
        const nicContainers = document.querySelectorAll('[id^="nic_"]');
        nicContainers.forEach((container) => {
            const nicNameInput = container.querySelector('[name^="nic_name_"]');
            const nicTypeInput = container.querySelector('[name^="nic_type_"]');
            const nicIpInput = container.querySelector('[name^="nic_ip_"]');

            if (nicNameInput && nicNameInput.value) {
                const nicName = nicNameInput.value;
                nicAll[nicName] = {
                    nic_type: nicTypeInput ? nicTypeInput.value : 'nat',
                    ip4_addr: nicIpInput ? nicIpInput.value : ''
                };
            }
        });

        // 将GB转换为MB
        const ramGB = parseFloat(formData.get('mem_num'));
        const hddGB = parseFloat(formData.get('hdd_num'));
        const gpuGB = parseFloat(formData.get('gpu_mem')) || 0;
        const fluGB = parseFloat(formData.get('flu_num')) || 0;
        
        // 验证硬盘大小
        const minDiskGB = getVmMinDiskRequirement();
        if (hddGB < minDiskGB) {
            showToast(`硬盘大小不能少于${minDiskGB}GB`, 'error');
            return;
        }
        
        const data = {
            host_name: formData.get('host_name'),
            os_name: formData.get('os_name'),
            os_pass: formData.get('os_pass'),
            vc_pass: formData.get('vc_pass'),
            vc_port: parseInt(formData.get('vc_port')) || 5900,
            cpu_num: parseInt(formData.get('cpu_num')),
            mem_num: Math.round(ramGB * 1024), // GB转MB
            hdd_num: Math.round(hddGB * 1024), // GB转MB
            gpu_num: parseInt(formData.get('gpu_num')) || 0,
            gpu_mem: Math.round(gpuGB * 1024), // GB转MB
            speed_u: parseInt(formData.get('speed_u')) || 100,
            speed_d: parseInt(formData.get('speed_d')) || 100,
            nat_num: parseInt(formData.get('nat_num')) || 0,
            flu_num: Math.round(fluGB * 1024), // GB转MB
            web_num: parseInt(formData.get('web_num')) || 0,
            nic_all: nicAll
        };

        // 验证资源配额
        const cpuNeeded = data.cpu_num;
        const ramNeeded = data.mem_num;
        const ssdNeeded = data.hdd_num;

        if (cpuNeeded > (currentUser.quota_cpu - currentUser.used_cpu)) {
            showToast('CPU资源不足', 'error');
            return;
        }
        if (ramNeeded > (currentUser.quota_ram - currentUser.used_ram)) {
            showToast('内存资源不足', 'error');
            return;
        }
        if (ssdNeeded > (currentUser.quota_ssd - currentUser.used_ssd)) {
            showToast('磁盘资源不足', 'error');
            return;
        }

        try {
            // 显示创建中的加载状态
            Swal.fire({
                title: '虚拟机创建中...',
                html: '正在创建虚拟机，请稍候...',
                allowOutsideClick: false,
                allowEscapeKey: false,
                showConfirmButton: false,
                didOpen: () => {
                    Swal.showLoading();
                }
            });

            // 禁用创建按钮
            const submitBtn = document.getElementById('submitCreateVmBtn');
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<span class="iconify animate-spin" data-icon="mdi:loading" data-width="16"></span> 创建中...';

            const result = await apiRequest(`/api/client/create/${data.host_name}`, 'POST', data);

            if (result.code === 200) {
                // 创建成功
                Swal.fire({
                    icon: 'success',
                    title: '创建成功',
                    text: result.msg || '虚拟机创建成功',
                    timer: 2000,
                    showConfirmButton: false
                }).then(() => {
                    closeCreateVmModal();
                    // 刷新仪表盘数据
                    loadUserDashboard();
                });
            } else {
                // 创建失败
                Swal.fire({
                    icon: 'error',
                    title: '创建失败',
                    text: result.msg || '虚拟机创建失败，请重试'
                });
            }
        } catch (error) {
            console.error('创建虚拟机失败:', error);
            Swal.fire({
                icon: 'error',
                title: '创建失败',
                text: '网络错误，请重试'
            });
        } finally {
            // 恢复按钮状态
            const submitBtn = document.getElementById('submitCreateVmBtn');
            submitBtn.disabled = false;
            submitBtn.innerHTML = '<span class="iconify" data-icon="mdi:plus" data-width="16"></span> 创建虚拟机';
        }
    }

    // 打开VNC控制台
    async function openVncConsole(uuid, host) {
        // 显示加载状态
        Swal.fire({
            title: '连接中...',
            html: `正在获取虚拟机 "<strong>${uuid}</strong>" 的VNC控制台地址`,
            allowOutsideClick: false,
            allowEscapeKey: false,
            showConfirmButton: false,
            didOpen: () => {
                Swal.showLoading();
            }
        });

        try {
            const result = await apiRequest(`/api/client/remote/${host}/${uuid}`);
            if (result && result.code === 200 && result.data) {
                Swal.close();
                // 新窗口打开VNC控制台URL
                window.open(result.data, `vnc_${uuid}`, 'width=1024,height=768,menubar=no,toolbar=no,location=no,status=no');
            } else {
                Swal.fire({
                    icon: 'error',
                    title: '获取失败',
                    text: result?.msg || '无法获取VNC控制台地址'
                });
            }
        } catch (error) {
            Swal.fire({
                icon: 'error',
                title: '连接失败',
                text: '网络错误或服务器异常'
            });
        }
    }

    // 打开电源操作模态框
    function openPowerModal(uuid, host) {
        currentPowerVm = uuid;
        currentPowerHost = host;
        document.getElementById('powerVmName').textContent = uuid;
        document.getElementById('powerModal').classList.remove('hidden');
    }

    // 关闭电源操作模态框
    function closePowerModal() {
        document.getElementById('powerModal').classList.add('hidden');
        currentPowerVm = '';
        currentPowerHost = '';
    }

    // 电源操作名称映射
    const powerActionMap = {
        'start': {name: '启动', color: '#16a34a', icon: 'success'},
        'stop': {name: '关机', color: '#ca8a04', icon: 'warning'},
        'hard_stop': {name: '强制关机', color: '#dc2626', icon: 'error'},
        'reset': {name: '重启', color: '#2563eb', icon: 'info'},
        'hard_reset': {name: '强制重启', color: '#ea580c', icon: 'warning'},
        'pause': {name: '暂停', color: '#4b5563', icon: 'warning'},
        'resume': {name: '恢复', color: '#4f46e5', icon: 'info'}
    };

    // 执行电源操作 - 使用SweetAlert2确认弹窗
    function vmPower(action) {
        if (!currentPowerVm || !currentPowerHost) return;

        const actionInfo = powerActionMap[action] || {name: action, color: '#9333ea', icon: 'question'};
        const vmName = currentPowerVm;

        // 先关闭电源操作菜单
        closePowerModal();

        // 使用SweetAlert2显示确认弹窗
        Swal.fire({
            title: `确认${actionInfo.name}`,
            html: `确定要对虚拟机 "<strong>${vmName}</strong>" 执行 <strong style="color: ${actionInfo.color}">${actionInfo.name}</strong> 操作吗？`,
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: actionInfo.color,
            cancelButtonColor: '#6b7280',
            confirmButtonText: `确认${actionInfo.name}`,
            cancelButtonText: '取消',
            reverseButtons: true
        }).then((result) => {
            if (result.isConfirmed) {
                doExecutePower(action, actionInfo, vmName);
            }
        });
    }

    // 实际执行电源操作
    async function doExecutePower(action, actionInfo, vmName) {
        // 显示加载状态
        Swal.fire({
            title: `${actionInfo.name}中...`,
            html: `正在对虚拟机 "<strong>${vmName}</strong>" 执行${actionInfo.name}操作`,
            allowOutsideClick: false,
            allowEscapeKey: false,
            showConfirmButton: false,
            didOpen: () => {
                Swal.showLoading();
            }
        });

        try {
            const result = await apiRequest(`/api/client/powers/${currentPowerHost}/${vmName}`, 'POST', {action: action});

            if (result && result.code === 200) {
                Swal.fire({
                    icon: 'success',
                    title: '操作成功',
                    text: result.msg || `${actionInfo.name}操作已完成`,
                    timer: 2000,
                    showConfirmButton: false
                });
                setTimeout(loadUserVms, 1000);
            } else {
                Swal.fire({
                    icon: 'error',
                    title: '操作失败',
                    text: result?.msg || '操作失败，请重试'
                });
            }
        } catch (error) {
            Swal.fire({
                icon: 'error',
                title: '操作失败',
                text: '网络错误或服务器异常'
            });
        }
    }

    // ESC键关闭模态框
    document.addEventListener('keydown', function (e) {
        if (e.key === 'Escape') {
            // 只有在模态框显示时才关闭
            const createVmModal = document.getElementById('createVmModal');
            if (createVmModal && !createVmModal.classList.contains('hidden')) {
                closeCreateVmModal();
            }
            
            // 关闭电源操作模态框
            const powerModal = document.getElementById('powerModal');
            if (powerModal && !powerModal.classList.contains('hidden')) {
                closePowerModal();
            }
        }
    });

    // 点击模态框外部关闭
    const createVmModal = document.getElementById('createVmModal');
    if (createVmModal) {
        createVmModal.addEventListener('click', function (e) {
            if (e.target === this) {
                closeCreateVmModal();
            }
        });
    }

    // 点击电源操作模态框外部关闭
    const powerModal = document.getElementById('powerModal');
    if (powerModal) {
        powerModal.addEventListener('click', function (e) {
            if (e.target === this) {
                closePowerModal();
            }
        });
    }
</script>
{% endblock %}
