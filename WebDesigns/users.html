{% extends "base.html" %}

{% block content %}
<style>
    /* 自定义确认对话框样式 */
    .transform {
        transform-origin: center;
    }
    .scale-95 {
        transform: scale(0.95);
        opacity: 0.9;
    }
    .scale-100 {
        transform: scale(1);
        opacity: 1;
    }
    .transition-all {
        transition: all 0.15s ease-in-out;
    }
</style>

<!-- 页面标题 -->
<div class="mb-6">
    <h1 class="text-3xl font-bold text-gray-800 flex items-center gap-3">
        <span class="iconify text-gray-600" data-icon="mdi:account-group" data-width="36"></span>
        用户管理
    </h1>
    <p class="text-gray-600 mt-1">管理系统用户、权限和资源配额</p>
</div>

<!-- 用户列表 -->
<div class="bg-white rounded-lg border border-gray-200">
    <div class="p-4 border-b border-gray-200 flex items-center justify-between">
        <h2 class="text-base font-semibold text-gray-800">用户列表</h2>
        <button onclick="showAddUserModal()"
                class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg flex items-center gap-2">
            <span class="iconify" data-icon="mdi:account-plus" data-width="18"></span>
            添加用户
        </button>
    </div>
    <div class="overflow-x-auto">
        <table class="w-full">
            <thead class="bg-gray-50">
            <tr>
                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">用户名</th>
                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">邮箱</th>
                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">角色</th>
                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">状态</th>
                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">基础配额</th>
                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">GPU显存</th>
                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">带宽/流量</th>
                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">网络服务</th>
                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">IP配额</th>
                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">操作</th>
            </tr>
            </thead>
            <tbody id="userTableBody" class="divide-y divide-gray-200">
            <!-- 用户列表将通过JavaScript动态加载 -->
            </tbody>
        </table>
    </div>
</div>

<!-- 添加用户模态框 -->
<div id="addUserModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white rounded-lg p-6 w-full max-w-2xl max-h-[90vh] overflow-y-auto">
        <div class="flex items-center justify-between mb-4">
            <h3 class="text-xl font-bold text-gray-800">添加用户</h3>
            <button onclick="closeAddUserModal()" class="text-gray-500 hover:text-gray-700">
                <span class="iconify" data-icon="mdi:close" data-width="24"></span>
            </button>
        </div>

        <form id="addUserForm" class="space-y-4">
            <!-- 基本信息 -->
            <div class="border-b pb-4">
                <h4 class="font-semibold text-gray-700 mb-3">基本信息</h4>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">用户名 <span
                                class="text-red-500">*</span></label>
                        <input type="text" id="addUsername" required
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">邮箱 <span
                                class="text-red-500">*</span></label>
                        <input type="email" id="addEmail" required
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                    </div>
                    <div class="col-span-2">
                        <label class="block text-sm font-medium text-gray-700 mb-1">密码 <span
                                class="text-red-500">*</span></label>
                        <input type="password" id="addPassword" required
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                    </div>
                </div>
            </div>

            <!-- 角色和状态 -->
            <div class="border-b pb-4">
                <h4 class="font-semibold text-gray-700 mb-3">角色和状态</h4>
                <div class="space-y-3">
                    <label class="flex items-center gap-2">
                        <input type="checkbox" id="addIsAdmin" class="rounded">
                        <span class="text-sm">管理员</span>
                    </label>
                    <label class="flex items-center gap-2">
                        <input type="checkbox" id="addIsActive" checked class="rounded">
                        <span class="text-sm">已启用</span>
                    </label>
                </div>
            </div>

            <!-- 虚拟机权限 -->
            <div class="border-b pb-4">
                <h4 class="font-semibold text-gray-700 mb-3">虚拟机权限</h4>
                <div class="space-y-3">
                    <label class="flex items-center gap-2">
                        <input type="checkbox" id="addCanCreate" checked class="rounded">
                        <span class="text-sm">允许创建虚拟机</span>
                    </label>
                    <label class="flex items-center gap-2">
                        <input type="checkbox" id="addCanModify" checked class="rounded">
                        <span class="text-sm">允许修改虚拟机</span>
                    </label>
                    <label class="flex items-center gap-2">
                        <input type="checkbox" id="addCanDelete" checked class="rounded">
                        <span class="text-sm">允许删除虚拟机</span>
                    </label>
                </div>
            </div>

            <!-- 资源配额 -->
            <div class="border-b pb-4">
                <h4 class="font-semibold text-gray-700 mb-3">资源配额</h4>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">CPU核心(个)</label>
                        <input type="number" id="addQuotaCpu" min="0" value="2"
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">RAM内存(GB)</label>
                        <input type="number" id="addQuotaRam" min="0" step="0.5" value="4"
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">HDD磁盘(GB)</label>
                        <input type="number" id="addQuotaSsd" min="0" step="1" value="50"
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">GPU显存(GB)</label>
                        <input type="number" id="addQuotaGpu" min="0" step="1" value="0"
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">GPU可用ID列表</label>
                        <select id="addGpuIds" multiple class="w-full px-3 py-2 border border-gray-300 rounded-lg"
                                style="height: 38px;">
                            <option value="0" selected>0</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">NAT端口(个)</label>
                        <input type="number" id="addQuotaNatPorts" min="0" value="5"
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">内网IP(个)</label>
                        <input type="number" id="addQuotaNatIps" min="0" value="5"
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">WEB代理(个)</label>
                        <input type="number" id="addQuotaWebProxy" min="0" value="2"
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">公网IP(个)</label>
                        <input type="number" id="addQuotaPubIps" min="0" value="2"
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">上行带宽(Mbps)</label>
                        <input type="number" id="addQuotaBandwidthUp" min="0" value="100"
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">下行带宽(Mbps)</label>
                        <input type="number" id="addQuotaBandwidthDown" min="0" value="100"
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                    </div>
                    <div class="col-span-2">
                        <label class="block text-sm font-medium text-gray-700 mb-1">月流量(GB)</label>
                        <input type="number" id="addQuotaTraffic" min="0" step="1" value="500"
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                    </div>
                </div>
            </div>

            <!-- 分配主机 -->
            <div>
                <h4 class="font-semibold text-gray-700 mb-3">分配主机</h4>
                <div id="addAssignedHostsContainer" class="space-y-2">
                    <!-- 主机列表将通过JavaScript动态加载 -->
                </div>
            </div>

            <div class="flex gap-2 pt-4">
                <button type="submit" class="flex-1 px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg">
                    添加用户
                </button>
                <button type="button" onclick="closeAddUserModal()"
                        class="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50">
                    取消
                </button>
            </div>
        </form>
    </div>
</div>

<!-- 编辑用户模态框 -->
<div id="editUserModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white rounded-lg p-6 w-full max-w-2xl max-h-[90vh] overflow-y-auto">
        <div class="flex items-center justify-between mb-4">
            <h3 class="text-xl font-bold text-gray-800">编辑用户</h3>
            <button onclick="closeEditUserModal()" class="text-gray-500 hover:text-gray-700">
                <span class="iconify" data-icon="mdi:close" data-width="24"></span>
            </button>
        </div>

        <form id="editUserForm" class="space-y-4">
            <input type="hidden" id="editUserId">

            <!-- 基本信息 -->
            <div class="border-b pb-4">
                <h4 class="font-semibold text-gray-700 mb-3">基本信息</h4>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">用户名</label>
                        <input type="text" id="editUsername" readonly
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-50">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">邮箱</label>
                        <input type="email" id="editEmail" readonly
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-50">
                    </div>
                    <div class="col-span-2">
                        <label class="block text-sm font-medium text-gray-700 mb-1">
                            新密码
                            <span class="text-xs text-gray-500 font-normal">(留空则不修改密码)</span>
                        </label>
                        <input type="password" id="editPassword" placeholder="留空则不修改"
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    </div>
                </div>
            </div>

            <!-- 角色和状态 -->
            <div class="border-b pb-4">
                <h4 class="font-semibold text-gray-700 mb-3">角色和状态</h4>
                <div class="flex items-center gap-6">
                    <label class="flex items-center gap-2">
                        <input type="checkbox" id="editIsAdmin" class="rounded">
                        <span class="text-sm">管理员</span>
                    </label>
                    <label class="flex items-center gap-2">
                        <input type="checkbox" id="editIsActive" class="rounded">
                        <span class="text-sm">启用用户</span>
                    </label>
                </div>
            </div>

            <!-- 虚拟机权限 -->
            <div class="border-b pb-4">
                <h4 class="font-semibold text-gray-700 mb-3">虚拟机权限</h4>
                <div class="flex items-center gap-6">
                    <label class="flex items-center gap-2">
                        <input type="checkbox" id="editCanCreate" class="rounded">
                        <span class="text-sm">允许创建虚拟机</span>
                    </label>
                    <label class="flex items-center gap-2">
                        <input type="checkbox" id="editCanModify" class="rounded">
                        <span class="text-sm">允许修改虚拟机</span>
                    </label>
                    <label class="flex items-center gap-2">
                        <input type="checkbox" id="editCanDelete" class="rounded">
                        <span class="text-sm">允许删除虚拟机</span>
                    </label>
                </div>
            </div>

            <!-- 资源配额 -->
            <div class="border-b pb-4">
                <h4 class="font-semibold text-gray-700 mb-3">资源配额</h4>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">CPU核心(个)</label>
                        <input type="number" id="editQuotaCpu" min="0"
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">RAM内存(GB)</label>
                        <input type="number" id="editQuotaRam" min="0" step="1"
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">HDD磁盘(GB)</label>
                        <input type="number" id="editQuotaSsd" min="0" step="1"
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">GPU显存(GB)</label>
                        <input type="number" id="editQuotaGpu" min="0" step="1"
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">GPU可用ID列表</label>
                        <select id="editGpuIds" multiple class="w-full px-3 py-2 border border-gray-300 rounded-lg"
                                style="height: 38px;">
                            <option value="0" selected>0</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">NAT端口(个)</label>
                        <input type="number" id="editQuotaNatPorts" min="0"
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">内网IP(个)</label>
                        <input type="number" id="editQuotaNatIps" min="0"
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">WEB代理(个)</label>
                        <input type="number" id="editQuotaWebProxy" min="0"
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">公网IP(个)</label>
                        <input type="number" id="editQuotaPubIps" min="0"
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">上行带宽(Mbps)</label>
                        <input type="number" id="editQuotaBandwidthUp" min="0"
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">下行带宽(Mbps)</label>
                        <input type="number" id="editQuotaBandwidthDown" min="0"
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                    </div>
                    <div class="col-span-2">
                        <label class="block text-sm font-medium text-gray-700 mb-1">月流量(GB)</label>
                        <input type="number" id="editQuotaTraffic" min="0" step="1"
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                    </div>
                </div>
            </div>

            <!-- 分配主机 -->
            <div>
                <h4 class="font-semibold text-gray-700 mb-3">分配主机</h4>
                <div id="assignedHostsContainer" class="space-y-2">
                    <!-- 主机列表将通过JavaScript动态加载 -->
                </div>
            </div>

            <div class="flex gap-2 pt-4">
                <button type="submit" class="flex-1 px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg">
                    保存
                </button>
                <button type="button" onclick="closeEditUserModal()"
                        class="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50">
                    取消
                </button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    let allHosts = [];

    $(document).ready(function () {
        loadUsers();
        loadHosts();
        
        // 初始化自定义确认对话框
        initConfirmDialog();
    });

    async function loadUsers() {
        const result = await apiRequest('/api/users');
        if (result && result.code === 200) {
            renderUserTable(result.data);
        }
    }

    async function loadHosts() {
        const result = await apiRequest('/api/server/detail');
        if (result && result.code === 200) {
            // 将对象转换为数组，每个元素包含主机名
            if (typeof result.data === 'object' && !Array.isArray(result.data)) {
                allHosts = Object.keys(result.data).map(hostName => ({
                    hs_name: hostName,
                    ...result.data[hostName]
                }));
            } else if (Array.isArray(result.data)) {
                allHosts = result.data;
            } else {
                allHosts = [];
            }
        } else {
            allHosts = [];
        }
    }

    function renderUserTable(users) {
        const tbody = document.getElementById('userTableBody');
        tbody.innerHTML = users.map(user => `
            <tr>
                <td class="px-4 py-3 text-sm">${user.username}</td>
                <td class="px-4 py-3 text-sm">${user.email}</td>
                <td class="px-4 py-3 text-sm">
                    ${user.is_admin ? '<span class="px-2 py-1 bg-purple-100 text-purple-700 rounded text-xs">管理员</span>' : '<span class="px-2 py-1 bg-gray-100 text-gray-700 rounded text-xs">普通用户</span>'}
                </td>
                <td class="px-4 py-3 text-sm">
                    ${user.is_active ? '<span class="px-2 py-1 bg-green-100 text-green-700 rounded text-xs">启用</span>' : '<span class="px-2 py-1 bg-red-100 text-red-700 rounded text-xs">禁用</span>'}
                </td>
                <td class="px-4 py-3 text-sm">
                    <div class="space-y-1">
                        <div class="flex justify-between gap-4">
                            <span>CPU:</span>
                            <span class="font-mono">${user.used_cpu || 0}/${user.quota_cpu}</span>
                        </div>
                        <div class="flex justify-between gap-4">
                            <span>RAM:</span>
                            <span class="font-mono">${Math.round((user.used_ram || 0) / 1024)}/${Math.round(user.quota_ram / 1024)}GB</span>
                        </div>
                        <div class="flex justify-between gap-4">
                            <span>SSD:</span>
                            <span class="font-mono">${Math.round((user.used_ssd || 0) / 1024)}/${Math.round(user.quota_ssd / 1024)}GB</span>
                        </div>
                        <div class="flex justify-between gap-4">
                            <span>GPU ID:</span>
                            <span class="font-mono">${user.gpu_ids || '0'}</span>
                        </div>
                    </div>
                </td>
                <td class="px-4 py-3 text-sm">
                    <div class="space-y-1">
                        <div class="flex justify-between gap-4">
                            <span>GPU显存:</span>
                            <span class="font-mono">${Math.round((user.used_gpu || 0) / 1024)}/${Math.round(user.quota_gpu / 1024)}GB</span>
                        </div>
                    </div>
                </td>
                <td class="px-4 py-3 text-sm">
                    <div class="space-y-1">
                        <div class="flex justify-between gap-4">
                            <span>上行:</span>
                            <span class="font-mono">${user.used_bandwidth_up || 0}/${user.quota_bandwidth_up}M</span>
                        </div>
                        <div class="flex justify-between gap-4">
                            <span>下行:</span>
                            <span class="font-mono">${user.used_bandwidth_down || 0}/${user.quota_bandwidth_down}M</span>
                        </div>
                        <div class="flex justify-between gap-4">
                            <span>流量:</span>
                            <span class="font-mono">${Math.round((user.used_traffic || 0) / 1024)}/${Math.round(user.quota_traffic / 1024)}GB</span>
                        </div>
                    </div>
                </td>
                <td class="px-4 py-3 text-sm">
                    <div class="space-y-1">
                        <div class="flex justify-between gap-4">
                            <span>NAT:</span>
                            <span class="font-mono">${user.used_nat_ports || 0}/${user.quota_nat_ports}</span>
                        </div>
                        <div class="flex justify-between gap-4">
                            <span>WEB:</span>
                            <span class="font-mono">${user.used_web_proxy || 0}/${user.quota_web_proxy}</span>
                        </div>
                    </div>
                </td>
                <td class="px-4 py-3 text-sm">
                    <div class="space-y-1">
                        <div class="flex justify-between gap-4">
                            <span>内网IP:</span>
                            <span class="font-mono">${user.used_nat_ips || 0}/${user.quota_nat_ips || 0}</span>
                        </div>
                        <div class="flex justify-between gap-4">
                            <span>公网IP:</span>
                            <span class="font-mono">${user.used_pub_ips || 0}/${user.quota_pub_ips || 0}</span>
                        </div>
                    </div>
                </td>
                <td class="px-4 py-3 text-sm">
                    <button onclick="editUser(${user.id})" class="text-blue-600 hover:text-blue-700 mr-2">编辑</button>
                    <button onclick="deleteUser(${user.id})" class="text-red-600 hover:text-red-700">删除</button>
                </td>
            </tr>
        `).join('');
    }

    async function editUser(userId) {
        const result = await apiRequest(`/api/users/${userId}`);
        if (result && result.code === 200) {
            const user = result.data;
            document.getElementById('editUserId').value = user.id;
            document.getElementById('editUsername').value = user.username;
            document.getElementById('editEmail').value = user.email;
            document.getElementById('editIsAdmin').checked = user.is_admin;
            document.getElementById('editIsActive').checked = user.is_active;
            document.getElementById('editCanCreate').checked = user.can_create_vm;
            document.getElementById('editCanModify').checked = user.can_modify_vm;
            document.getElementById('editCanDelete').checked = user.can_delete_vm;
            document.getElementById('editQuotaCpu').value = user.quota_cpu;
            // 将MB转换为GB显示（整数）
            document.getElementById('editQuotaRam').value = Math.floor(user.quota_ram / 1024);
            document.getElementById('editQuotaSsd').value = Math.floor(user.quota_ssd / 1024);
            document.getElementById('editQuotaGpu').value = Math.floor(user.quota_gpu / 1024);

            // 设置GPU ID列表（固定为0）
            const editGpuIds = document.getElementById('editGpuIds');
            if (editGpuIds) {
                Array.from(editGpuIds.options).forEach(option => {
                    option.selected = true;
                });
            }

            document.getElementById('editQuotaNatPorts').value = user.quota_nat_ports;
            document.getElementById('editQuotaNatIps').value = user.quota_nat_ips || 0;
            document.getElementById('editQuotaWebProxy').value = user.quota_web_proxy;
            document.getElementById('editQuotaPubIps').value = user.quota_pub_ips || 0;
            document.getElementById('editQuotaBandwidthUp').value = user.quota_bandwidth_up;
            document.getElementById('editQuotaBandwidthDown').value = user.quota_bandwidth_down;
            document.getElementById('editQuotaTraffic').value = Math.floor(user.quota_traffic / 1024);

            // 渲染主机列表
            let assignedHosts = [];
            // 后端返回的assigned_hosts可能是数组或JSON字符串
            if (Array.isArray(user.assigned_hosts)) {
                assignedHosts = user.assigned_hosts;
            } else if (typeof user.assigned_hosts === 'string') {
                try {
                    assignedHosts = JSON.parse(user.assigned_hosts);
                } catch (error) {
                    console.error('解析assigned_hosts失败:', error, user.assigned_hosts);
                    assignedHosts = [];
                }
            }
            const container = document.getElementById('assignedHostsContainer');
            if (Array.isArray(allHosts)) {
                container.innerHTML = allHosts.map(host => `
                    <label class="flex items-center gap-2">
                        <input type="checkbox" class="rounded assigned-host-checkbox" value="${host.hs_name}" ${assignedHosts.includes(host.hs_name) ? 'checked' : ''}>
                        <span class="text-sm">${host.hs_name}</span>
                    </label>
                `).join('');
            } else {
                container.innerHTML = '<p class="text-gray-500 text-sm">暂无可用主机</p>';
            }

            document.getElementById('editUserModal').classList.remove('hidden');
        }
    }

    function closeEditUserModal() {
        document.getElementById('editUserModal').classList.add('hidden');
        // 清空密码字段
        document.getElementById('editPassword').value = '';
    }

    document.getElementById('editUserForm').addEventListener('submit', async (e) => {
        e.preventDefault();

        const assignedHosts = Array.from(document.querySelectorAll('.assigned-host-checkbox:checked')).map(cb => cb.value);

        // 将GB转换为MB提交给后端
        const data = {
            is_admin: document.getElementById('editIsAdmin').checked ? 1 : 0,
            is_active: document.getElementById('editIsActive').checked ? 1 : 0,
            can_create_vm: document.getElementById('editCanCreate').checked ? 1 : 0,
            can_modify_vm: document.getElementById('editCanModify').checked ? 1 : 0,
            can_delete_vm: document.getElementById('editCanDelete').checked ? 1 : 0,
            quota_cpu: parseInt(document.getElementById('editQuotaCpu').value),
            quota_ram: Math.round(parseInt(document.getElementById('editQuotaRam').value) * 1024),
            quota_ssd: Math.round(parseInt(document.getElementById('editQuotaSsd').value) * 1024),
            quota_gpu: Math.round(parseInt(document.getElementById('editQuotaGpu').value) * 1024),
            quota_nat_ports: parseInt(document.getElementById('editQuotaNatPorts').value),
            quota_nat_ips: parseInt(document.getElementById('editQuotaNatIps').value) || 0,
            quota_web_proxy: parseInt(document.getElementById('editQuotaWebProxy').value),
            quota_pub_ips: parseInt(document.getElementById('editQuotaPubIps').value) || 0,
            quota_bandwidth_up: parseInt(document.getElementById('editQuotaBandwidthUp').value),
            quota_bandwidth_down: parseInt(document.getElementById('editQuotaBandwidthDown').value),
            quota_traffic: Math.round(parseInt(document.getElementById('editQuotaTraffic').value) * 1024),
            assigned_hosts: assignedHosts
        };

        // 如果填写了新密码，则添加到数据中
        const newPassword = document.getElementById('editPassword').value;
        if (newPassword && newPassword.trim() !== '') {
            data.password = newPassword;
        }

        const userId = document.getElementById('editUserId').value;
        const result = await apiRequest(`/api/users/${userId}`, 'PUT', data);

        if (result && result.code === 200) {
            showToast('用户信息已更新', 'success');
            closeEditUserModal();
            loadUsers();
        } else {
            showToast(result?.msg || '更新失败', 'error');
        }
    });

    function showAddUserModal() {
        // 重置表单
        document.getElementById('addUserForm').reset();

        // 设置默认值
        document.getElementById('addIsActive').checked = true;
        document.getElementById('addCanCreate').checked = true;
        document.getElementById('addCanModify').checked = true;
        document.getElementById('addCanDelete').checked = true;

        // 渲染主机列表
        const container = document.getElementById('addAssignedHostsContainer');
        if (Array.isArray(allHosts)) {
            container.innerHTML = allHosts.map(host => `
                <label class="flex items-center gap-2">
                    <input type="checkbox" class="rounded add-assigned-host-checkbox" value="${host.hs_name}">
                    <span class="text-sm">${host.hs_name}</span>
                </label>
            `).join('');
        } else {
            container.innerHTML = '<p class="text-gray-500 text-sm">暂无可用主机</p>';
        }

        document.getElementById('addUserModal').classList.remove('hidden');
    }

    function closeAddUserModal() {
        document.getElementById('addUserModal').classList.add('hidden');
    }

    async function deleteUser(userId) {
        // 显示自定义确认对话框
        showConfirmDialog('确定要删除此用户吗？删除后无法恢复！', async () => {
            const result = await apiRequest(`/api/users/${userId}`, 'DELETE');
            if (result && result.code === 200) {
                showToast('用户已删除', 'success');
                loadUsers();
            } else {
                showToast(result?.msg || '删除失败', 'error');
            }
        });
    }

    // 添加用户表单提交处理
    document.getElementById('addUserForm').addEventListener('submit', async (e) => {
        e.preventDefault();

        const assignedHosts = Array.from(document.querySelectorAll('.add-assigned-host-checkbox:checked')).map(cb => cb.value);

        // 将GB转换为MB提交给后端
        const data = {
            username: document.getElementById('addUsername').value,
            email: document.getElementById('addEmail').value,
            password: document.getElementById('addPassword').value,
            is_admin: document.getElementById('addIsAdmin').checked ? 1 : 0,
            is_active: document.getElementById('addIsActive').checked ? 1 : 0,
            can_create_vm: document.getElementById('addCanCreate').checked ? 1 : 0,
            can_modify_vm: document.getElementById('addCanModify').checked ? 1 : 0,
            can_delete_vm: document.getElementById('addCanDelete').checked ? 1 : 0,
            quota_cpu: parseInt(document.getElementById('addQuotaCpu').value) || 0,
            quota_ram: Math.round(parseFloat(document.getElementById('addQuotaRam').value) * 1024) || 0,
            quota_ssd: Math.round(parseFloat(document.getElementById('addQuotaSsd').value) * 1024) || 0,
            quota_gpu: Math.round(parseFloat(document.getElementById('addQuotaGpu').value) * 1024) || 0,
            quota_nat_ports: parseInt(document.getElementById('addQuotaNatPorts').value) || 0,
            quota_nat_ips: parseInt(document.getElementById('addQuotaNatIps').value) || 0,
            quota_web_proxy: parseInt(document.getElementById('addQuotaWebProxy').value) || 0,
            quota_pub_ips: parseInt(document.getElementById('addQuotaPubIps').value) || 0,
            quota_bandwidth_up: parseInt(document.getElementById('addQuotaBandwidthUp').value) || 0,
            quota_bandwidth_down: parseInt(document.getElementById('addQuotaBandwidthDown').value) || 0,
            quota_traffic: Math.round(parseFloat(document.getElementById('addQuotaTraffic').value) * 1024) || 0,
            assigned_hosts: assignedHosts
        };

        const result = await apiRequest('/api/users', 'POST', data);

        if (result && result.code === 200) {
            showToast('用户添加成功', 'success');
            closeAddUserModal();
            loadUsers();
        } else {
            showToast(result?.msg || '添加失败', 'error');
        }
    });

    // 自定义确认对话框功能
    let confirmCallback = null;

    function initConfirmDialog() {
        const cancelBtn = document.getElementById('confirmCancel');
        const okBtn = document.getElementById('confirmOk');
        const dialog = document.getElementById('confirmDialog');
        
        // 取消按钮事件
        cancelBtn.addEventListener('click', () => {
            hideConfirmDialog();
        });
        
        // 确认按钮事件
        okBtn.addEventListener('click', () => {
            if (confirmCallback) {
                confirmCallback();
            }
            hideConfirmDialog();
        });
        
        // 点击背景关闭（可选）
        dialog.addEventListener('click', (e) => {
            if (e.target === dialog) {
                hideConfirmDialog();
            }
        });
        
        // ESC键关闭
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && !dialog.classList.contains('hidden')) {
                hideConfirmDialog();
            }
        });
    }
    
    function showConfirmDialog(message, callback) {
        const dialog = document.getElementById('confirmDialog');
        const messageElement = document.getElementById('confirmMessage');
        
        messageElement.textContent = message;
        confirmCallback = callback;
        dialog.classList.remove('hidden');
        
        // 添加动画效果
        setTimeout(() => {
            dialog.querySelector('.bg-white').classList.add('scale-100');
            dialog.querySelector('.bg-white').classList.remove('scale-95');
        }, 10);
    }
    
    function hideConfirmDialog() {
        const dialog = document.getElementById('confirmDialog');
        
        // 添加动画效果
        dialog.querySelector('.bg-white').classList.add('scale-95');
        dialog.querySelector('.bg-white').classList.remove('scale-100');
        
        setTimeout(() => {
            dialog.classList.add('hidden');
            confirmCallback = null;
        }, 150);
    }
</script>

<!-- 自定义确认对话框 -->
<div id="confirmDialog" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white rounded-lg p-6 w-full max-w-md mx-4 transform transition-all">
        <div class="flex items-center mb-4">
            <div class="flex-shrink-0 w-12 h-12 bg-red-100 rounded-full flex items-center justify-center">
                <span class="iconify text-red-600" data-icon="mdi:alert-circle" data-width="24"></span>
            </div>
            <div class="ml-4">
                <h3 class="text-lg font-semibold text-gray-900">确认删除</h3>
                <p class="text-sm text-gray-500">此操作不可恢复</p>
            </div>
        </div>
        
        <div class="mb-6">
            <p id="confirmMessage" class="text-gray-700">确定要删除此用户吗？</p>
        </div>
        
        <div class="flex gap-3 justify-end">
            <button id="confirmCancel" 
                    class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 transition-colors">
                取消
            </button>
            <button id="confirmOk" 
                    class="px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg transition-colors">
                确认删除
            </button>
        </div>
    </div>
</div>
{% endblock %}
